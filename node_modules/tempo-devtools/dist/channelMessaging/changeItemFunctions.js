"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.updateCodebaseIds = exports.applyChangeItemToDocument = exports.resetIntermediateClassesForSliderInstantUpdate = exports.TEMPORARY_STYLING_CLASS_NAME = exports.ADD_CLASS_INSTANT_UPDATE_QUEUE = exports.ADD_JSX_PREFIX = exports.DUPLICATE_PLACEHOLDER_PREFIX = exports.WRAP_IN_DIV_PLACEHOLDER_CODEBASE_ID = void 0;
const jquery_1 = __importDefault(require("jquery"));
const identifierUtils_1 = require("./identifierUtils");
const changeLedgerTypes_1 = require("./changeLedgerTypes");
const constantsAndTypes_1 = require("./constantsAndTypes");
const cssRuleUtils_1 = require("./cssRuleUtils");
const sessionStorageUtils_1 = require("./sessionStorageUtils");
const tempoElement_1 = require("./tempoElement");
const uuid_1 = require("uuid");
// These constants match what tempo-api has
exports.WRAP_IN_DIV_PLACEHOLDER_CODEBASE_ID = 'tempo-wrap-in-div-placeholder';
exports.DUPLICATE_PLACEHOLDER_PREFIX = 'tempo-duplicate-placeholder-';
exports.ADD_JSX_PREFIX = 'tempo-add-jsx-placeholder-';
// Stored in memory storage, used to keep track of some possible add class instant
// updates that need to be re-applied after a hot reload
// (e.g. when the additional) instant updates happened during flushing
exports.ADD_CLASS_INSTANT_UPDATE_QUEUE = 'ADD_CLASS_INSTANT_UPDATE_QUEUE';
exports.TEMPORARY_STYLING_CLASS_NAME = 'arb89-temp-styling';
const getTopLevelCodebaseIdForComponent = (componentId) => {
    let topLevelCodebaseId = null;
    let minNumberParents = Infinity;
    (0, jquery_1.default)(`.component-${componentId}`).each((index, element) => {
        if ((0, jquery_1.default)(element).parents().length < minNumberParents) {
            minNumberParents = (0, jquery_1.default)(element).parents().length;
            topLevelCodebaseId = (0, identifierUtils_1.getCodebaseIdFromNode)(element);
        }
    });
    return topLevelCodebaseId;
};
const makeid = (length) => {
    let result = '';
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    const charactersLength = characters.length;
    let counter = 0;
    while (counter < length) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
        counter += 1;
    }
    return result;
};
let intermediateClassesForSliderInstantUpdate = {};
const resetIntermediateClassesForSliderInstantUpdate = () => {
    intermediateClassesForSliderInstantUpdate = {};
};
exports.resetIntermediateClassesForSliderInstantUpdate = resetIntermediateClassesForSliderInstantUpdate;
const addClassCssRule = (className, rules, id) => {
    let selector = className
        .replace(/\[/g, '\\[')
        .replace(/\]/g, '\\]')
        .replace(/\(/g, '\\(')
        .replace(/\)/g, '\\)')
        .replace(/\./g, '\\.')
        .replace(/\%/g, '\\%')
        .replace(/\!/g, '\\!')
        .replace(/\//g, '\\/')
        .replace(/#/g, '\\#');
    selector = `.${selector}`;
    try {
        addOrEditCSSRule(selector, rules, id);
    }
    catch (e) {
        console.log('Error adding class CSS rule', e);
    }
};
const addOrEditCSSRule = (selector, rules, id) => {
    var styleEl = document.createElement('style');
    if (id) {
        const existingElement = document.getElementById(id);
        if (existingElement) {
            existingElement.remove();
        }
        styleEl.id = id;
    }
    // Append <style> element to <head>
    document.head.appendChild(styleEl);
    var styleSheet = styleEl.sheet;
    if (styleSheet.insertRule) {
        // All browsers, except IE before version 9
        styleSheet.insertRule(selector + '{' + rules + '}', styleSheet.cssRules.length);
    }
    else if (styleSheet.addRule) {
        // IE before version 9
        styleSheet.addRule(selector, rules, styleSheet.rules.length);
    }
};
const applyChangeItemToDocument = (parentPort, storyboardId, plainChangeItem) => {
    var _a;
    if (!plainChangeItem || !plainChangeItem.type) {
        return { sendNewNavTree: false, instantUpdateSuccessful: false };
    }
    const changeItem = (0, changeLedgerTypes_1.reconstructChangeLedgerClass)(plainChangeItem);
    let extraInstantUpdateData = {};
    let instantUpdateSuccessful = false;
    // The display: none rule is needed for a lot of instant updates, so create it if it doesn't exist
    if (!document.getElementById(identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS)) {
        addClassCssRule(identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS, 'display: none !important', identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS);
    }
    let sendNewNavTree = false;
    if (changeItem.type === changeLedgerTypes_1.ChangeType.ADD_JSX) {
        const castChangeItem = changeItem;
        const changeFields = castChangeItem.changeFields;
        const newAddedIds = [];
        if (changeFields.htmlForInstantUpdate) {
            const elementToAdd = (0, jquery_1.default)(changeFields.htmlForInstantUpdate);
            elementToAdd.attr(identifierUtils_1.TEMPO_DELETE_AFTER_REFRESH, 'true');
            elementToAdd.attr(identifierUtils_1.TEMPO_INSTANT_UPDATE, 'true'); // So that the DOM tree refresh doesn't get triggered
            elementToAdd.attr(identifierUtils_1.TEMPO_OUTLINE_UNTIL_REFESH, 'true');
            const ID_FOR_ELEMENT = `${exports.ADD_JSX_PREFIX}${(0, uuid_1.v4)()}`;
            elementToAdd.attr(identifierUtils_1.TEMPO_ELEMENT_ID, ID_FOR_ELEMENT);
            elementToAdd.addClass(ID_FOR_ELEMENT);
            newAddedIds.push(ID_FOR_ELEMENT);
            (0, jquery_1.default)(`.${changeFields.codebaseIdToAddTo}`).each((index, item) => {
                if (changeFields.afterCodebaseId) {
                    const afterElement = (0, jquery_1.default)(`.${changeFields.afterCodebaseId}`);
                    if (!(afterElement === null || afterElement === void 0 ? void 0 : afterElement.length)) {
                        return;
                    }
                    elementToAdd.insertAfter(afterElement.first());
                }
                else if (changeFields.beforeCodebaseId) {
                    const beforeElement = (0, jquery_1.default)(`.${changeFields.beforeCodebaseId}`);
                    if (!(beforeElement === null || beforeElement === void 0 ? void 0 : beforeElement.length)) {
                        return;
                    }
                    elementToAdd.insertBefore(beforeElement.first());
                }
                else {
                    (0, jquery_1.default)(item).append(elementToAdd);
                }
                sendNewNavTree = true;
                instantUpdateSuccessful = true;
            });
        }
        extraInstantUpdateData['newAddedIds'] = newAddedIds;
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.MOVE_JSX) {
        const castChangeItem = changeItem;
        // Find each element that matches the jsxCodebaseId
        const sourceElements = [];
        // See if direct matches work first
        if ((0, jquery_1.default)(`.${castChangeItem.changeFields.codebaseIdToMove}`).length > 0) {
            (0, jquery_1.default)(`.${castChangeItem.changeFields.codebaseIdToMove}`).each((index, element) => {
                sourceElements.push((0, jquery_1.default)(element));
            });
        }
        else {
            // Try to find it by the component ID
            let topLevelCodebaseId = getTopLevelCodebaseIdForComponent(castChangeItem.changeFields.codebaseIdToMove || '');
            if (topLevelCodebaseId) {
                (0, jquery_1.default)(`.${topLevelCodebaseId}`).each((index, element) => {
                    sourceElements.push((0, jquery_1.default)(element));
                });
            }
        }
        // If the container is a component, drop into the codebaseId of the top-most child div
        let containerCodebaseId = getTopLevelCodebaseIdForComponent(castChangeItem.changeFields.codebaseIdToMoveTo || '') || castChangeItem.changeFields.codebaseIdToMoveTo;
        // For each source element, find the new matching parent element
        const newParentElements = [];
        sourceElements.forEach((element) => {
            let newParentElement = null;
            // For each parent, try to see if it either matches or contains the new parent
            let parentElement = element.parent();
            while (parentElement.length) {
                // If the parent directly matches, this is it
                if (parentElement.hasClass(containerCodebaseId)) {
                    newParentElement = parentElement;
                    break;
                }
                // Check children that match the codebase ID to drop into
                const matchingChildren = parentElement.find(`.${containerCodebaseId}`);
                if (matchingChildren.length) {
                    // TODO: What if this matches more than one?
                    newParentElement = matchingChildren.first();
                    break;
                }
                parentElement = parentElement.parent();
            }
            if (!newParentElement) {
                newParentElements.push(null);
                return;
            }
            newParentElements.push(newParentElement);
        });
        // For each child/parentElement pair, move the child to the new parent
        sourceElements.forEach((element, index) => {
            const newParentElement = newParentElements[index];
            if (!newParentElement.length) {
                console.log('Could not find new parent element for instant update');
                return;
            }
            sendNewNavTree = true;
            instantUpdateSuccessful = true;
            element.attr(identifierUtils_1.TEMPO_INSTANT_UPDATE, 'true');
            // If the parent hasn't changed, just move it, otherwise clone it and create a new one in the new spot
            let useClone = !newParentElement.is(element.parent());
            // So that nextjs hot reloading works, simply hide the element and clone it into the new spot
            let cloneElement;
            if (useClone) {
                cloneElement = element.clone();
                cloneElement.attr(identifierUtils_1.TEMPO_DELETE_AFTER_REFRESH, 'true');
                element.addClass(identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS);
                element.attr(identifierUtils_1.TEMPO_DO_NOT_SHOW_IN_NAV_UNTIL_REFRESH, 'true');
            }
            if (castChangeItem.changeFields.afterCodebaseId) {
                const afterIdToUse = getTopLevelCodebaseIdForComponent(castChangeItem.changeFields.afterCodebaseId) || castChangeItem.changeFields.afterCodebaseId;
                const afterElement = newParentElement.children(`.${afterIdToUse}`);
                if (afterElement.length) {
                    if (useClone && cloneElement) {
                        cloneElement.insertAfter(afterElement.first());
                    }
                    else {
                        element.insertAfter(afterElement.first());
                    }
                    return;
                }
            }
            if (castChangeItem.changeFields.beforeCodebaseId) {
                const beforeIdToUse = getTopLevelCodebaseIdForComponent(castChangeItem.changeFields.beforeCodebaseId) || castChangeItem.changeFields.beforeCodebaseId;
                const beforeElement = newParentElement.children(`.${beforeIdToUse}`);
                if (beforeElement.length) {
                    if (useClone && cloneElement) {
                        cloneElement.insertBefore(beforeElement.first());
                    }
                    else {
                        element.insertBefore(beforeElement.first());
                    }
                    return;
                }
            }
            if (useClone && cloneElement) {
                cloneElement.appendTo(newParentElement);
            }
            else {
                element.appendTo(newParentElement);
            }
        });
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.REMOVE_JSX) {
        const castChangeItem = changeItem;
        const parentToElementKeysRemoved = {};
        castChangeItem.changeFields.codebaseIdsToRemove.forEach((codebaseId) => {
            // See if direct matches work first
            let codebaseIdToRemove;
            if ((0, jquery_1.default)(`.${codebaseId}`).length > 0) {
                codebaseIdToRemove = codebaseId;
            }
            else {
                // Try to find it by the component ID
                let topLevelCodebaseId = getTopLevelCodebaseIdForComponent(codebaseId || '');
                if (!topLevelCodebaseId) {
                    console.log('Could not find component element for instant update');
                    return false;
                }
                codebaseIdToRemove = topLevelCodebaseId;
            }
            // For each item that is removed, save the inner HTML in case it gets deleted and we want to undo
            (0, jquery_1.default)(`.${codebaseIdToRemove}`).each((index, item) => {
                const elementKeyRemoved = (0, identifierUtils_1.getElementKeyFromNode)(item);
                const parentElementKey = (0, identifierUtils_1.getElementKeyFromNode)(item.parentElement);
                if (elementKeyRemoved && parentElementKey) {
                    if (!parentToElementKeysRemoved[parentElementKey]) {
                        parentToElementKeysRemoved[parentElementKey] = [];
                    }
                    parentToElementKeysRemoved[parentElementKey].push({
                        outerHTML: item.outerHTML,
                        elementKeyRemoved,
                    });
                }
                item.classList.add(identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS);
                item.setAttribute(identifierUtils_1.TEMPO_DO_NOT_SHOW_IN_NAV_UNTIL_REFRESH, 'true');
                sendNewNavTree = true;
                instantUpdateSuccessful = true;
            });
        });
        extraInstantUpdateData.parentToElementKeysRemoved =
            parentToElementKeysRemoved;
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.ADD_CLASS ||
        changeItem.type === changeLedgerTypes_1.ChangeType.STYLING) {
        let className, cssEquivalent, codebaseIdToAddClass, temporaryClass, codebaseClassName, modifiers;
        if (changeItem.type === changeLedgerTypes_1.ChangeType.ADD_CLASS) {
            const castChangeItem = changeItem;
            codebaseClassName = castChangeItem.changeFields.className;
            className = castChangeItem.changeFields.className;
            cssEquivalent = castChangeItem.changeFields.cssEquivalent;
            codebaseIdToAddClass = castChangeItem.changeFields.codebaseIdToAddClass;
            temporaryClass = castChangeItem.changeFields.temporaryOnly;
            modifiers = castChangeItem.changeFields.modifiers;
            if (temporaryClass) {
                className = exports.TEMPORARY_STYLING_CLASS_NAME;
            }
        }
        else {
            // As of March 6, 2024 we only support tailwind STYLING changes, so treat them as adding a class
            const castChangeItem = changeItem.changeFields;
            className = '';
            cssEquivalent = Object.keys(castChangeItem.stylingChanges)
                .map((key) => {
                if (castChangeItem.stylingChanges[key] === constantsAndTypes_1.DELETE_STYLE_CONSTANT) {
                    return `${(0, cssRuleUtils_1.camelToSnakeCase)(key)}: unset !important;`;
                }
                return `${(0, cssRuleUtils_1.camelToSnakeCase)(key)}: ${castChangeItem.stylingChanges[key]};`;
            })
                .join('');
            codebaseIdToAddClass = castChangeItem.codebaseId;
            modifiers = castChangeItem.modifiers;
        }
        const SAFE_CLASSNAME_REGEX = /[^A-Za-z0-9_-]/g;
        // Escape any custom classes
        let classToAdd = (className || '')
            .replace(SAFE_CLASSNAME_REGEX, '-') // Replace any non-alphanumeric characters with '-'
            .replace(/^\d/, '-$&'); // If the class starts with a digit, prepend with '-'
        // Instead of adding the class name, generate a new class and set the
        // css equivalent values inside it
        // This class will be deleted after a hot reload
        // Note - for temporary classes we want to explicitly use the same class
        if (cssEquivalent && !temporaryClass) {
            const msSinceJan1 = Date.now() - 1704067200000;
            classToAdd = `${identifierUtils_1.TEMPO_INSTANT_UPDATE_STYLING_PREFIX}${msSinceJan1}-${classToAdd}`;
        }
        if (classToAdd) {
            if (!temporaryClass) {
                // Clear the temporary class on this element if it has it
                (0, jquery_1.default)(`.${codebaseIdToAddClass}`).removeClass(exports.TEMPORARY_STYLING_CLASS_NAME);
            }
            if (cssEquivalent) {
                if (modifiers && modifiers.length > 0) {
                    const CSS_PSEUDO_MODIFIERS = [
                        'hover',
                        'required',
                        'focus',
                        'active',
                        'invalid',
                        'disabled',
                    ];
                    const pseudoModifiers = modifiers.filter((modifier) => CSS_PSEUDO_MODIFIERS.includes(modifier));
                    const pseudoModifiersSuffix = pseudoModifiers.join(':');
                    if (pseudoModifiers.length > 0) {
                        const modifierClass = `${classToAdd}:${pseudoModifiersSuffix}`;
                        addClassCssRule(modifierClass, cssEquivalent, modifierClass);
                    }
                    else {
                        addClassCssRule(classToAdd, cssEquivalent, classToAdd);
                    }
                    const forceClasses = modifiers
                        .map((modifier) => `.tempo-force-${modifier}`)
                        .join('');
                    const instantUpdateForForceClass = `${classToAdd}${forceClasses}`;
                    addClassCssRule(instantUpdateForForceClass, cssEquivalent, instantUpdateForForceClass);
                }
                else {
                    addClassCssRule(classToAdd, cssEquivalent, classToAdd);
                }
            }
            const currentAddClassValues = (0, sessionStorageUtils_1.getMemoryStorageItem)(exports.ADD_CLASS_INSTANT_UPDATE_QUEUE) || [];
            // See if direct matches work first
            if ((0, jquery_1.default)(`.${codebaseIdToAddClass}`).length > 0) {
                (0, jquery_1.default)(`.${codebaseIdToAddClass}`).addClass(classToAdd);
                instantUpdateSuccessful = true;
                currentAddClassValues.push({
                    codebaseId: codebaseIdToAddClass,
                    className: classToAdd,
                });
            }
            else {
                // Try to find it by the component ID
                let topLevelCodebaseId = getTopLevelCodebaseIdForComponent(codebaseIdToAddClass || '');
                if (topLevelCodebaseId && (0, jquery_1.default)(`.${topLevelCodebaseId}`).length > 0) {
                    instantUpdateSuccessful = true;
                    (0, jquery_1.default)(`.${topLevelCodebaseId}`).addClass(classToAdd);
                    currentAddClassValues.push({
                        codebaseId: topLevelCodebaseId,
                        className: classToAdd,
                    });
                }
            }
            (0, sessionStorageUtils_1.setMemoryStorageItem)(exports.ADD_CLASS_INSTANT_UPDATE_QUEUE, currentAddClassValues);
            extraInstantUpdateData.addedClass = classToAdd;
            extraInstantUpdateData.codebaseAddedClass = codebaseClassName;
        }
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.REMOVE_CLASS) {
        const removeClassChangeFields = changeItem.changeFields;
        // See if direct matches work first
        if ((0, jquery_1.default)(`.${removeClassChangeFields.codebaseIdToRemoveClass}`).length > 0) {
            (0, jquery_1.default)(`.${removeClassChangeFields.codebaseIdToRemoveClass}`).removeClass(removeClassChangeFields.className);
            instantUpdateSuccessful = true;
        }
        else {
            // Try to find it by the component ID
            let topLevelCodebaseId = getTopLevelCodebaseIdForComponent(removeClassChangeFields.codebaseIdToRemoveClass || '');
            if (topLevelCodebaseId && (0, jquery_1.default)(`.${topLevelCodebaseId}`).length > 0) {
                instantUpdateSuccessful = true;
                (0, jquery_1.default)(`.${topLevelCodebaseId}`).removeClass(removeClassChangeFields.className);
            }
        }
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.WRAP_DIV) {
        const changeFields = changeItem.changeFields;
        const codebaseIdsToWrap = changeFields.codebaseIdsToWrap;
        const firstCodebaseId = codebaseIdsToWrap[0];
        // We assume the other codebase IDs are siblings of this codebase ID, so we
        // find each instance of the first one and include the other items that match in it
        // If the other items aren't all found, we do not wrap and let hot reload handle it
        (0, jquery_1.default)(`.${firstCodebaseId}`).each((index, item) => {
            const otherCodebaseIds = codebaseIdsToWrap.slice(1);
            // For each codebase ID in otherCodebaseIds, retrieve the element that is a sibling of item
            const siblings = (0, jquery_1.default)(item).siblings();
            const allItemsToAddToNewDiv = [item];
            let earliestItem = item;
            let earliestIndex = (0, jquery_1.default)(item).index();
            otherCodebaseIds.forEach((codebaseId) => {
                const foundSibling = siblings.filter(`.${codebaseId}`).get(0);
                if (foundSibling) {
                    allItemsToAddToNewDiv.push(foundSibling);
                    const index = (0, jquery_1.default)(foundSibling).index();
                    if (index < earliestIndex) {
                        earliestItem = foundSibling;
                        earliestIndex = index;
                    }
                }
            });
            // TODO: What to do if they all can't be found?
            if (allItemsToAddToNewDiv.length !== codebaseIdsToWrap.length) {
                // For now, just add the ones that were found
            }
            // Create a div with a clone of the item, while hiding the item
            // When the hot reload happens the clone gets deleted and the item is shown again
            const newDiv = document.createElement('div');
            newDiv.className = exports.WRAP_IN_DIV_PLACEHOLDER_CODEBASE_ID;
            newDiv.setAttribute(identifierUtils_1.TEMPO_INSTANT_UPDATE, 'true'); // So that the DOM tree refresh doesn't get triggered
            newDiv.setAttribute('tempoelementid', exports.WRAP_IN_DIV_PLACEHOLDER_CODEBASE_ID);
            newDiv.setAttribute('data-testid', exports.WRAP_IN_DIV_PLACEHOLDER_CODEBASE_ID);
            newDiv.setAttribute(identifierUtils_1.TEMPO_DELETE_AFTER_REFRESH, 'true');
            allItemsToAddToNewDiv.forEach((elem) => {
                newDiv.appendChild(elem.cloneNode(true));
                elem.classList.add(identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS);
                elem.setAttribute(identifierUtils_1.TEMPO_DO_NOT_SHOW_IN_NAV_UNTIL_REFRESH, 'true');
            });
            // Insert the new div right before the first item
            earliestItem.insertAdjacentElement('beforebegin', newDiv);
            sendNewNavTree = true;
            instantUpdateSuccessful = true;
        });
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.DUPLICATE) {
        const changeFileds = changeItem.changeFields;
        const codebaseIdsToDuplicate = changeFileds.codebaseIdsToDuplicate;
        codebaseIdsToDuplicate.forEach((codebaseIdToDuplicate) => {
            (0, jquery_1.default)(`.${codebaseIdToDuplicate}`).each((index, item) => {
                const clonedNode = item.cloneNode(true);
                clonedNode.setAttribute(identifierUtils_1.TEMPO_DELETE_AFTER_REFRESH, 'true');
                clonedNode.setAttribute(identifierUtils_1.TEMPO_INSTANT_UPDATE, 'true'); // So that the DOM tree refresh doesn't get triggered
                // Set up all the correct duplicated codebase IDs
                clonedNode.setAttribute('tempoelementid', `${exports.DUPLICATE_PLACEHOLDER_PREFIX}${codebaseIdToDuplicate}`);
                clonedNode.setAttribute('data-testid', `${exports.DUPLICATE_PLACEHOLDER_PREFIX}${codebaseIdToDuplicate}`);
                clonedNode.classList.add(exports.DUPLICATE_PLACEHOLDER_PREFIX + codebaseIdToDuplicate);
                clonedNode.classList.remove(codebaseIdToDuplicate);
                let children = Array.from(clonedNode.children);
                while (children.length) {
                    const child = children.pop();
                    if (!child) {
                        continue;
                    }
                    const codebaseId = child.getAttribute('tempoelementid') ||
                        child.getAttribute('data-testid');
                    if (!codebaseId) {
                        continue;
                    }
                    child.setAttribute('tempoelementid', `${exports.DUPLICATE_PLACEHOLDER_PREFIX}${codebaseId}`);
                    child.setAttribute('data-testid', `${exports.DUPLICATE_PLACEHOLDER_PREFIX}${codebaseId}`);
                    child.classList.remove(codebaseId);
                    child.classList.add(exports.DUPLICATE_PLACEHOLDER_PREFIX + codebaseId);
                    child.setAttribute(identifierUtils_1.TEMPO_INSTANT_UPDATE, 'true');
                    children.push(...Array.from(child.children));
                }
                // Add the clones node right after the found node
                item.insertAdjacentElement('afterend', clonedNode);
                sendNewNavTree = true;
                instantUpdateSuccessful = true;
            });
        });
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.CHANGE_TAG) {
        const changeFields = changeItem.changeFields;
        (0, jquery_1.default)(`.${changeFields.codebaseIdToChange}`).each((index, item) => {
            const $newElement = (0, jquery_1.default)('<' + changeFields.newTagName + '></' + changeFields.newTagName + '>');
            $newElement.attr(identifierUtils_1.TEMPO_INSTANT_UPDATE, 'true'); // So that the DOM tree refresh doesn't get triggered
            $newElement.attr(identifierUtils_1.TEMPO_DELETE_AFTER_REFRESH, 'true');
            const $item = (0, jquery_1.default)(item);
            // Copy all attributes from the original element to the new element
            jquery_1.default.each($item[0].attributes, function () {
                $newElement.attr(this.name, this.value);
            });
            $item.contents().clone(true, true).appendTo($newElement);
            // Add right before the cloned item so the unique path stays the same
            $item.before($newElement);
            // Hide the original item
            $item.addClass(identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS);
            $item.attr(identifierUtils_1.TEMPO_DO_NOT_SHOW_IN_NAV_UNTIL_REFRESH, 'true');
            sendNewNavTree = true;
            instantUpdateSuccessful = true;
        });
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.UNDO) {
        const { sendNewNavTree: _sendNewNavTree, instantUpdateSuccessful: _instantUpdateSuccessful, } = applyUndoChangeItemToDocument(parentPort, changeItem);
        sendNewNavTree = _sendNewNavTree;
        instantUpdateSuccessful = _instantUpdateSuccessful;
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.REDO) {
        const changeFields = changeItem.changeFields;
        const changeToRedo = changeFields.changeToRedo;
        if (changeLedgerTypes_1.CHANGE_TYPES_WITH_INSTANT_UNDO.includes(changeToRedo.type)) {
            const { sendNewNavTree: _sendNewNavTree, instantUpdateSuccessful: _instantUpdateSuccessful, } = (0, exports.applyChangeItemToDocument)(parentPort, storyboardId, changeToRedo);
            sendNewNavTree = _sendNewNavTree;
            instantUpdateSuccessful = _instantUpdateSuccessful;
            if (changeToRedo.prevIdToNewIdMap) {
                (0, exports.updateCodebaseIds)(parentPort, changeToRedo.prevIdToNewIdMap, true);
            }
        }
    }
    else if (changeItem.type === changeLedgerTypes_1.ChangeType.UPDATE_CLASSES) {
        const { codebaseIdToUpdateClass, newClasses, oldClasses, involvedClasses, isInstantChangeOnly, } = changeItem.changeFields;
        // TODO(nhanthai): Should handle this better instead of just remove and add
        for (const oldClass of oldClasses) {
            (0, jquery_1.default)(`.${codebaseIdToUpdateClass}`).removeClass(oldClass);
        }
        (intermediateClassesForSliderInstantUpdate[codebaseIdToUpdateClass] || []).forEach((className) => {
            (0, jquery_1.default)(`.${codebaseIdToUpdateClass}`).removeClass(className);
        });
        for (const newClass of newClasses) {
            (0, jquery_1.default)(`.${codebaseIdToUpdateClass}`).addClass(newClass);
        }
        for (const involvedClass of involvedClasses) {
            addClassCssRule(involvedClass.tailwind, involvedClass.css);
        }
        if (isInstantChangeOnly) {
            intermediateClassesForSliderInstantUpdate[codebaseIdToUpdateClass] = [];
            for (const involvedClass of involvedClasses) {
                intermediateClassesForSliderInstantUpdate[codebaseIdToUpdateClass].push(involvedClass.tailwind);
            }
        }
        else {
            intermediateClassesForSliderInstantUpdate[codebaseIdToUpdateClass] = [];
        }
    }
    // Immediately set the new selected element keys to prevent any delay in the outlines updating
    let elementKeyToSelectAfterInstantUpdate = changeItem.getElementKeyToSelectAfterInstantUpdate();
    let elementKeysToMultiselectAfterInstantUpdate = changeItem.getElementKeysToMultiselectAfterInstantUpdate();
    if (changeItem.type === changeLedgerTypes_1.ChangeType.UNDO) {
        elementKeyToSelectAfterInstantUpdate = changeItem.changeFields.changeToUndo.getElementKeyToSelectAfterUndoInstantUpdate();
        elementKeysToMultiselectAfterInstantUpdate = changeItem.changeFields.changeToUndo.getElementKeysToMultiselectAfterUndoInstantUpdate();
    }
    if (elementKeyToSelectAfterInstantUpdate !== undefined) {
        (0, sessionStorageUtils_1.setMemoryStorageItem)(sessionStorageUtils_1.SELECTED_ELEMENT_KEY, elementKeyToSelectAfterInstantUpdate);
        parentPort.postMessage({
            id: constantsAndTypes_1.FIXED_IFRAME_MESSAGE_IDS.SELECTED_ELEMENT_KEY,
            elementKey: elementKeyToSelectAfterInstantUpdate,
            outerHTML: (_a = (0, jquery_1.default)(`.${identifierUtils_1.ELEMENT_KEY_PREFIX}${elementKeyToSelectAfterInstantUpdate}`).get(0)) === null || _a === void 0 ? void 0 : _a.outerHTML,
        });
    }
    if (elementKeysToMultiselectAfterInstantUpdate !== undefined) {
        (0, sessionStorageUtils_1.setMemoryStorageItem)(sessionStorageUtils_1.MULTI_SELECTED_ELEMENT_KEYS, elementKeysToMultiselectAfterInstantUpdate);
        parentPort.postMessage({
            id: constantsAndTypes_1.FIXED_IFRAME_MESSAGE_IDS.MULTI_SELECTED_ELEMENT_KEYS,
            elementKeys: elementKeysToMultiselectAfterInstantUpdate,
            outerHTMLs: elementKeysToMultiselectAfterInstantUpdate === null || elementKeysToMultiselectAfterInstantUpdate === void 0 ? void 0 : elementKeysToMultiselectAfterInstantUpdate.map((elementKey) => { var _a; return (_a = (0, jquery_1.default)(`.${identifierUtils_1.ELEMENT_KEY_PREFIX}${elementKey}`).get(0)) === null || _a === void 0 ? void 0 : _a.outerHTML; }),
        });
    }
    if (instantUpdateSuccessful) {
        // Delete any elements that need to be deleted after instant updates
        (0, jquery_1.default)(`*[${identifierUtils_1.TEMPO_DELETE_AFTER_INSTANT_UPDATE}=true]`).remove();
    }
    parentPort.postMessage({
        id: constantsAndTypes_1.FIXED_IFRAME_MESSAGE_IDS.INSTANT_UPDATE_DONE,
        changeItem: plainChangeItem,
        instantUpdateData: extraInstantUpdateData,
        instantUpdateSuccessful,
    });
    return { sendNewNavTree, instantUpdateSuccessful };
};
exports.applyChangeItemToDocument = applyChangeItemToDocument;
const applyUndoChangeItemToDocument = (parentPort, changeItem) => {
    const changeFields = changeItem.changeFields;
    const changeToUndo = changeFields.changeToUndo;
    if (!changeLedgerTypes_1.CHANGE_TYPES_WITH_INSTANT_UNDO.includes(changeToUndo.type)) {
        return { sendNewNavTree: false, instantUpdateSuccessful: false };
    }
    let sendNewNavTree = false;
    let instantUpdateSuccessful = false;
    // API has completed and the IDs have been updated, reverse this change
    if (changeToUndo.prevIdToNewIdMap) {
        const undoCodebaseIdChanges = {};
        Object.keys(changeToUndo.prevIdToNewIdMap).forEach((prevId) => {
            const newId = changeToUndo.prevIdToNewIdMap[prevId];
            undoCodebaseIdChanges[newId] = prevId;
        });
        // If undoing do not update the codebase IDs backwards if there are codebase IDs to set after
        // the undo instant update is done
        const selectedElementSpecifiedAfterUndo = changeToUndo.getElementKeyToSelectAfterUndoInstantUpdate() !== undefined;
        (0, exports.updateCodebaseIds)(parentPort, undoCodebaseIdChanges, !selectedElementSpecifiedAfterUndo);
    }
    // Then undo the actual change
    if (changeToUndo.type === changeLedgerTypes_1.ChangeType.REMOVE_JSX) {
        // Re-add the removed JSX
        const innerChangeFields = changeToUndo.changeFields;
        const codebaseIdsToReadd = innerChangeFields.codebaseIdsToRemove;
        // If it has been flushed, re-create the html elements from the saved inner HTML
        if (changeFields.matchingActivityFlushed) {
            const instantUpdateData = changeToUndo.getInstantUpdateData();
            const parentToElementKeysRemoved = instantUpdateData.parentToElementKeysRemoved || {};
            Object.entries(parentToElementKeysRemoved).forEach(([parentElementKey, itemsRemoved]) => {
                // Sort the removed entries in order of unique path
                const sortedItemsRemoved = Object.values(itemsRemoved).sort((a, b) => {
                    const aElementKey = tempoElement_1.TempoElement.fromKey(a.elementKeyRemoved);
                    const bElementKey = tempoElement_1.TempoElement.fromKey(b.elementKeyRemoved);
                    return aElementKey.uniquePath.localeCompare(bElementKey.uniquePath);
                });
                // Find the parent element
                const parentElement = (0, jquery_1.default)(`.${identifierUtils_1.ELEMENT_KEY_PREFIX}${parentElementKey}`).get(0);
                if (parentElement) {
                    // Add the removed elements back in order
                    sortedItemsRemoved.forEach((item) => {
                        const { elementKeyRemoved, outerHTML } = item;
                        const element = tempoElement_1.TempoElement.fromKey(elementKeyRemoved);
                        const indexInParent = Number(element.uniquePath.split('-').pop());
                        const newElementFromHtml = (0, jquery_1.default)(outerHTML).get(0);
                        // Add to the parent in the index
                        if (newElementFromHtml) {
                            newElementFromHtml.setAttribute(identifierUtils_1.TEMPO_DELETE_AFTER_REFRESH, 'true');
                            newElementFromHtml.setAttribute(identifierUtils_1.TEMPO_INSTANT_UPDATE, 'true');
                            parentElement.insertBefore(newElementFromHtml, parentElement.children[indexInParent] || null);
                            instantUpdateSuccessful = true;
                            sendNewNavTree = true;
                        }
                    });
                }
            });
        }
        else {
            // Not flushed yet so can just re-add
            codebaseIdsToReadd.forEach((codebaseIdToReadd) => {
                (0, jquery_1.default)(`.${codebaseIdToReadd}`).each((index, item) => {
                    item.classList.remove(identifierUtils_1.TEMPO_DISPLAY_NONE_UNTIL_REFRESH_CLASS);
                    item.removeAttribute(identifierUtils_1.TEMPO_DO_NOT_SHOW_IN_NAV_UNTIL_REFRESH);
                    sendNewNavTree = true;
                    instantUpdateSuccessful = true;
                });
            });
        }
    }
    else if (changeToUndo.type === changeLedgerTypes_1.ChangeType.ADD_CLASS ||
        changeToUndo.type === changeLedgerTypes_1.ChangeType.STYLING) {
        const instantUpdateData = changeToUndo.getInstantUpdateData();
        const innerChangeFields = changeToUndo.changeFields;
        const addedClass = instantUpdateData === null || instantUpdateData === void 0 ? void 0 : instantUpdateData.addedClass;
        if (addedClass) {
            (0, jquery_1.default)(`.${innerChangeFields.codebaseIdToAddClass}`).each((index, item) => {
                if ((0, jquery_1.default)(item).hasClass(addedClass)) {
                    (0, jquery_1.default)(item).removeClass(addedClass);
                    instantUpdateSuccessful = true;
                }
            });
        }
        const codebaseAddedClass = instantUpdateData === null || instantUpdateData === void 0 ? void 0 : instantUpdateData.codebaseAddedClass;
        if (codebaseAddedClass) {
            (0, jquery_1.default)(`.${innerChangeFields.codebaseIdToAddClass}`).each((index, item) => {
                if ((0, jquery_1.default)(item).hasClass(codebaseAddedClass)) {
                    (0, jquery_1.default)(item).removeClass(codebaseAddedClass);
                    instantUpdateSuccessful = true;
                }
            });
        }
    }
    else if (changeToUndo.type === changeLedgerTypes_1.ChangeType.UPDATE_CLASSES) {
        const { codebaseIdToUpdateClass, newClasses, oldClasses } = changeToUndo.changeFields;
        // TODO(nhanthai): Should handle this better instead of just remove and add
        for (const newClass of newClasses) {
            (0, jquery_1.default)(`.${codebaseIdToUpdateClass}`).removeClass(newClass);
        }
        for (const oldClass of oldClasses) {
            (0, jquery_1.default)(`.${codebaseIdToUpdateClass}`).addClass(oldClass);
        }
        intermediateClassesForSliderInstantUpdate[codebaseIdToUpdateClass] = [];
    }
    else if (changeToUndo.type === changeLedgerTypes_1.ChangeType.ADD_JSX) {
        const instantUpdateData = changeToUndo.getInstantUpdateData();
        const addedIds = instantUpdateData === null || instantUpdateData === void 0 ? void 0 : instantUpdateData.addedIds;
        addedIds === null || addedIds === void 0 ? void 0 : addedIds.forEach((addedId) => {
            (0, jquery_1.default)(`.${addedId}`).remove();
            instantUpdateSuccessful = true;
        });
        sendNewNavTree = true;
    }
    return { sendNewNavTree, instantUpdateSuccessful };
};
/**
 * After a change is processed on the backend, we need to update the codebase ids in the document.
 */
const updateCodebaseIds = (parentPort, prevIdToNewIdMap, updateElementKeys) => {
    // Update codebase ids in the document
    const changes = [];
    Object.entries(prevIdToNewIdMap).forEach(([prevCodebaseId, newCodebaseId]) => {
        (0, jquery_1.default)(`.${prevCodebaseId}`).each((index, item) => {
            changes.push({
                item,
                prevCodebaseId,
                newCodebaseId,
            });
        });
    });
    // Codebase Ids can swap, so we have to apply the changes after looking all elements up
    changes.forEach((change) => {
        const $item = (0, jquery_1.default)(change.item);
        const newClass = ($item.attr('class') || '').replace(new RegExp(`${change.prevCodebaseId}`, 'g'), change.newCodebaseId);
        $item.attr('class', newClass);
        change.item.setAttribute('tempoelementid', change.newCodebaseId);
        change.item.setAttribute('data-testid', change.newCodebaseId);
    });
    if (!updateElementKeys) {
        return Boolean(changes.length);
    }
    const keysToCheck = [
        {
            key: sessionStorageUtils_1.SELECTED_ELEMENT_KEY,
            messageId: constantsAndTypes_1.FIXED_IFRAME_MESSAGE_IDS.SELECTED_ELEMENT_KEY,
        },
        {
            key: sessionStorageUtils_1.HOVERED_ELEMENT_KEY,
            messageId: constantsAndTypes_1.FIXED_IFRAME_MESSAGE_IDS.HOVERED_ELEMENT_KEY,
        },
    ];
    keysToCheck.forEach(({ key, messageId }) => {
        var _a;
        const elementKey = (0, sessionStorageUtils_1.getMemoryStorageItem)(key);
        const tempoElement = tempoElement_1.TempoElement.fromKey(elementKey);
        if (prevIdToNewIdMap[tempoElement.codebaseId]) {
            const newElement = new tempoElement_1.TempoElement(prevIdToNewIdMap[tempoElement.codebaseId], tempoElement.storyboardId, tempoElement.uniquePath);
            (0, sessionStorageUtils_1.setMemoryStorageItem)(key, newElement.getKey());
            parentPort.postMessage({
                id: messageId,
                elementKey: newElement.getKey(),
                outerHTML: (_a = (0, jquery_1.default)(`.${identifierUtils_1.ELEMENT_KEY_PREFIX}${newElement.getKey()}`).get(0)) === null || _a === void 0 ? void 0 : _a.outerHTML,
            });
        }
    });
    // Also update the multiselected element keys
    const multiselectedElementKeys = (0, sessionStorageUtils_1.getMemoryStorageItem)(sessionStorageUtils_1.MULTI_SELECTED_ELEMENT_KEYS);
    if (multiselectedElementKeys === null || multiselectedElementKeys === void 0 ? void 0 : multiselectedElementKeys.length) {
        const newMultiselectedElementKeys = [];
        multiselectedElementKeys.forEach((elementKey) => {
            const tempoElement = tempoElement_1.TempoElement.fromKey(elementKey);
            if (prevIdToNewIdMap[tempoElement.codebaseId]) {
                const newElement = new tempoElement_1.TempoElement(prevIdToNewIdMap[tempoElement.codebaseId], tempoElement.storyboardId, tempoElement.uniquePath);
                newMultiselectedElementKeys.push(newElement.getKey());
            }
            else {
                newMultiselectedElementKeys.push(elementKey);
            }
        });
        (0, sessionStorageUtils_1.setMemoryStorageItem)(sessionStorageUtils_1.MULTI_SELECTED_ELEMENT_KEYS, newMultiselectedElementKeys);
        parentPort.postMessage({
            id: constantsAndTypes_1.FIXED_IFRAME_MESSAGE_IDS.MULTI_SELECTED_ELEMENT_KEYS,
            elementKeys: newMultiselectedElementKeys,
            outerHTMLs: newMultiselectedElementKeys === null || newMultiselectedElementKeys === void 0 ? void 0 : newMultiselectedElementKeys.map((elementKey) => { var _a; return (_a = (0, jquery_1.default)(`.${identifierUtils_1.ELEMENT_KEY_PREFIX}${elementKey}`).get(0)) === null || _a === void 0 ? void 0 : _a.outerHTML; }),
        });
    }
    return Boolean(changes.length);
};
exports.updateCodebaseIds = updateCodebaseIds;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlSXRlbUZ1bmN0aW9ucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jaGFubmVsTWVzc2FnaW5nL2NoYW5nZUl0ZW1GdW5jdGlvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsb0RBQXVCO0FBQ3ZCLHVEQVkyQjtBQUMzQiwyREFvQjZCO0FBQzdCLDJEQUc2QjtBQUM3QixpREFBa0Q7QUFDbEQsK0RBTStCO0FBQy9CLGlEQUE4QztBQUM5QywrQkFBb0M7QUFFcEMsMkNBQTJDO0FBQzlCLFFBQUEsbUNBQW1DLEdBQzlDLCtCQUErQixDQUFDO0FBQ3JCLFFBQUEsNEJBQTRCLEdBQUcsOEJBQThCLENBQUM7QUFDOUQsUUFBQSxjQUFjLEdBQUcsNEJBQTRCLENBQUM7QUFFM0Qsa0ZBQWtGO0FBQ2xGLHdEQUF3RDtBQUN4RCxzRUFBc0U7QUFDekQsUUFBQSw4QkFBOEIsR0FBRyxnQ0FBZ0MsQ0FBQztBQUVsRSxRQUFBLDRCQUE0QixHQUFHLG9CQUFvQixDQUFDO0FBRWpFLE1BQU0saUNBQWlDLEdBQUcsQ0FBQyxXQUFtQixFQUFVLEVBQUU7SUFDeEUsSUFBSSxrQkFBa0IsR0FBUSxJQUFJLENBQUM7SUFDbkMsSUFBSSxnQkFBZ0IsR0FBRyxRQUFRLENBQUM7SUFDaEMsSUFBQSxnQkFBQyxFQUFDLGNBQWMsV0FBVyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFVLEVBQUUsT0FBWSxFQUFFLEVBQUU7UUFDL0QsSUFBSSxJQUFBLGdCQUFDLEVBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsTUFBTSxHQUFHLGdCQUFnQixFQUFFO1lBQ2xELGdCQUFnQixHQUFHLElBQUEsZ0JBQUMsRUFBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUM7WUFDL0Msa0JBQWtCLEdBQUcsSUFBQSx1Q0FBcUIsRUFBQyxPQUFPLENBQUMsQ0FBQztTQUNyRDtJQUNILENBQUMsQ0FBQyxDQUFDO0lBRUgsT0FBTyxrQkFBa0IsQ0FBQztBQUM1QixDQUFDLENBQUM7QUFFRixNQUFNLE1BQU0sR0FBRyxDQUFDLE1BQWMsRUFBVSxFQUFFO0lBQ3hDLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQztJQUNoQixNQUFNLFVBQVUsR0FDZCxnRUFBZ0UsQ0FBQztJQUNuRSxNQUFNLGdCQUFnQixHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUM7SUFDM0MsSUFBSSxPQUFPLEdBQUcsQ0FBQyxDQUFDO0lBQ2hCLE9BQU8sT0FBTyxHQUFHLE1BQU0sRUFBRTtRQUN2QixNQUFNLElBQUksVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7UUFDMUUsT0FBTyxJQUFJLENBQUMsQ0FBQztLQUNkO0lBQ0QsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyxDQUFDO0FBRUYsSUFBSSx5Q0FBeUMsR0FFekMsRUFBRSxDQUFDO0FBRUEsTUFBTSw4Q0FBOEMsR0FBRyxHQUFHLEVBQUU7SUFDakUseUNBQXlDLEdBQUcsRUFBRSxDQUFDO0FBQ2pELENBQUMsQ0FBQztBQUZXLFFBQUEsOENBQThDLGtEQUV6RDtBQUVGLE1BQU0sZUFBZSxHQUFHLENBQUMsU0FBaUIsRUFBRSxLQUFhLEVBQUUsRUFBVyxFQUFFLEVBQUU7SUFDeEUsSUFBSSxRQUFRLEdBQUcsU0FBUztTQUNyQixPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQztTQUNyQixPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQztTQUNyQixPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQztTQUNyQixPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQztTQUNyQixPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQztTQUNyQixPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQztTQUNyQixPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQztTQUNyQixPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQztTQUNyQixPQUFPLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRXhCLFFBQVEsR0FBRyxJQUFJLFFBQVEsRUFBRSxDQUFDO0lBQzFCLElBQUk7UUFDRixnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0tBQ3ZDO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDVixPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixFQUFFLENBQUMsQ0FBQyxDQUFDO0tBQy9DO0FBQ0gsQ0FBQyxDQUFDO0FBRUYsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLFFBQWdCLEVBQUUsS0FBYSxFQUFFLEVBQVcsRUFBRSxFQUFFO0lBQ3hFLElBQUksT0FBTyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFOUMsSUFBSSxFQUFFLEVBQUU7UUFDTixNQUFNLGVBQWUsR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3BELElBQUksZUFBZSxFQUFFO1lBQ25CLGVBQWUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUMxQjtRQUVELE9BQU8sQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO0tBQ2pCO0lBRUQsbUNBQW1DO0lBQ25DLFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRW5DLElBQUksVUFBVSxHQUFRLE9BQU8sQ0FBQyxLQUFLLENBQUM7SUFFcEMsSUFBSSxVQUFVLENBQUMsVUFBVSxFQUFFO1FBQ3pCLDJDQUEyQztRQUMzQyxVQUFVLENBQUMsVUFBVSxDQUNuQixRQUFRLEdBQUcsR0FBRyxHQUFHLEtBQUssR0FBRyxHQUFHLEVBQzVCLFVBQVUsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUMzQixDQUFDO0tBQ0g7U0FBTSxJQUFJLFVBQVUsQ0FBQyxPQUFPLEVBQUU7UUFDN0Isc0JBQXNCO1FBQ3RCLFVBQVUsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxVQUFVLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0tBQzlEO0FBQ0gsQ0FBQyxDQUFDO0FBRUssTUFBTSx5QkFBeUIsR0FBRyxDQUN2QyxVQUF1QixFQUN2QixZQUFvQixFQUNwQixlQUFvQyxFQUMyQixFQUFFOztJQUNqRSxJQUFJLENBQUMsZUFBZSxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRTtRQUM3QyxPQUFPLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRSx1QkFBdUIsRUFBRSxLQUFLLEVBQUUsQ0FBQztLQUNsRTtJQUVELE1BQU0sVUFBVSxHQUFHLElBQUEsZ0RBQTRCLEVBQzdDLGVBQWUsQ0FDTyxDQUFDO0lBRXpCLElBQUksc0JBQXNCLEdBQVEsRUFBRSxDQUFDO0lBQ3JDLElBQUksdUJBQXVCLEdBQUcsS0FBSyxDQUFDO0lBRXBDLGtHQUFrRztJQUNsRyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyx3REFBc0MsQ0FBQyxFQUFFO1FBQ3BFLGVBQWUsQ0FDYix3REFBc0MsRUFDdEMsMEJBQTBCLEVBQzFCLHdEQUFzQyxDQUN2QyxDQUFDO0tBQ0g7SUFFRCxJQUFJLGNBQWMsR0FBRyxLQUFLLENBQUM7SUFDM0IsSUFBSSxVQUFVLENBQUMsSUFBSSxLQUFLLDhCQUFVLENBQUMsT0FBTyxFQUFFO1FBQzFDLE1BQU0sY0FBYyxHQUFHLFVBQTBCLENBQUM7UUFDbEQsTUFBTSxZQUFZLEdBQUcsY0FBYyxDQUFDLFlBQVksQ0FBQztRQUVqRCxNQUFNLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFFdkIsSUFBSSxZQUFZLENBQUMsb0JBQW9CLEVBQUU7WUFDckMsTUFBTSxZQUFZLEdBQUcsSUFBQSxnQkFBQyxFQUFDLFlBQVksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1lBQzFELFlBQVksQ0FBQyxJQUFJLENBQUMsNENBQTBCLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDdEQsWUFBWSxDQUFDLElBQUksQ0FBQyxzQ0FBb0IsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLHFEQUFxRDtZQUN0RyxZQUFZLENBQUMsSUFBSSxDQUFDLDRDQUEwQixFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBRXRELE1BQU0sY0FBYyxHQUFHLEdBQUcsc0JBQWMsR0FBRyxJQUFBLFNBQU0sR0FBRSxFQUFFLENBQUM7WUFDdEQsWUFBWSxDQUFDLElBQUksQ0FBQyxrQ0FBZ0IsRUFBRSxjQUFjLENBQUMsQ0FBQztZQUNwRCxZQUFZLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBRXRDLFdBQVcsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7WUFFakMsSUFBQSxnQkFBQyxFQUFDLElBQUksWUFBWSxDQUFDLGlCQUFpQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFVLEVBQUUsSUFBSSxFQUFFLEVBQUU7Z0JBQ2hFLElBQUksWUFBWSxDQUFDLGVBQWUsRUFBRTtvQkFDaEMsTUFBTSxZQUFZLEdBQUcsSUFBQSxnQkFBQyxFQUFDLElBQUksWUFBWSxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUM7b0JBQzNELElBQUksQ0FBQyxDQUFBLFlBQVksYUFBWixZQUFZLHVCQUFaLFlBQVksQ0FBRSxNQUFNLENBQUEsRUFBRTt3QkFDekIsT0FBTztxQkFDUjtvQkFFRCxZQUFZLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO2lCQUNoRDtxQkFBTSxJQUFJLFlBQVksQ0FBQyxnQkFBZ0IsRUFBRTtvQkFDeEMsTUFBTSxhQUFhLEdBQUcsSUFBQSxnQkFBQyxFQUFDLElBQUksWUFBWSxDQUFDLGdCQUFnQixFQUFFLENBQUMsQ0FBQztvQkFDN0QsSUFBSSxDQUFDLENBQUEsYUFBYSxhQUFiLGFBQWEsdUJBQWIsYUFBYSxDQUFFLE1BQU0sQ0FBQSxFQUFFO3dCQUMxQixPQUFPO3FCQUNSO29CQUNELFlBQVksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7aUJBQ2xEO3FCQUFNO29CQUNMLElBQUEsZ0JBQUMsRUFBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7aUJBQzlCO2dCQUVELGNBQWMsR0FBRyxJQUFJLENBQUM7Z0JBQ3RCLHVCQUF1QixHQUFHLElBQUksQ0FBQztZQUNqQyxDQUFDLENBQUMsQ0FBQztTQUNKO1FBRUQsc0JBQXNCLENBQUMsYUFBYSxDQUFDLEdBQUcsV0FBVyxDQUFDO0tBQ3JEO1NBQU0sSUFBSSxVQUFVLENBQUMsSUFBSSxLQUFLLDhCQUFVLENBQUMsUUFBUSxFQUFFO1FBQ2xELE1BQU0sY0FBYyxHQUFrQixVQUEyQixDQUFDO1FBRWxFLG1EQUFtRDtRQUNuRCxNQUFNLGNBQWMsR0FBa0IsRUFBRSxDQUFDO1FBRXpDLG1DQUFtQztRQUNuQyxJQUFJLElBQUEsZ0JBQUMsRUFBQyxJQUFJLGNBQWMsQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDcEUsSUFBQSxnQkFBQyxFQUFDLElBQUksY0FBYyxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUN4RCxDQUFDLEtBQVUsRUFBRSxPQUFZLEVBQUUsRUFBRTtnQkFDM0IsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFBLGdCQUFDLEVBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNsQyxDQUFDLENBQ0YsQ0FBQztTQUNIO2FBQU07WUFDTCxxQ0FBcUM7WUFDckMsSUFBSSxrQkFBa0IsR0FBRyxpQ0FBaUMsQ0FDeEQsY0FBYyxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsSUFBSSxFQUFFLENBQ25ELENBQUM7WUFFRixJQUFJLGtCQUFrQixFQUFFO2dCQUN0QixJQUFBLGdCQUFDLEVBQUMsSUFBSSxrQkFBa0IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBVSxFQUFFLE9BQVksRUFBRSxFQUFFO29CQUM1RCxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUEsZ0JBQUMsRUFBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUNsQyxDQUFDLENBQUMsQ0FBQzthQUNKO1NBQ0Y7UUFFRCxzRkFBc0Y7UUFDdEYsSUFBSSxtQkFBbUIsR0FDckIsaUNBQWlDLENBQy9CLGNBQWMsQ0FBQyxZQUFZLENBQUMsa0JBQWtCLElBQUksRUFBRSxDQUNyRCxJQUFJLGNBQWMsQ0FBQyxZQUFZLENBQUMsa0JBQWtCLENBQUM7UUFFdEQsZ0VBQWdFO1FBQ2hFLE1BQU0saUJBQWlCLEdBQVUsRUFBRSxDQUFDO1FBQ3BDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUNqQyxJQUFJLGdCQUFnQixHQUFHLElBQUksQ0FBQztZQUU1Qiw4RUFBOEU7WUFDOUUsSUFBSSxhQUFhLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ3JDLE9BQU8sYUFBYSxDQUFDLE1BQU0sRUFBRTtnQkFDM0IsNkNBQTZDO2dCQUM3QyxJQUFJLGFBQWEsQ0FBQyxRQUFRLENBQUMsbUJBQW1CLENBQUMsRUFBRTtvQkFDL0MsZ0JBQWdCLEdBQUcsYUFBYSxDQUFDO29CQUNqQyxNQUFNO2lCQUNQO2dCQUVELHlEQUF5RDtnQkFDekQsTUFBTSxnQkFBZ0IsR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksbUJBQW1CLEVBQUUsQ0FBQyxDQUFDO2dCQUN2RSxJQUFJLGdCQUFnQixDQUFDLE1BQU0sRUFBRTtvQkFDM0IsNENBQTRDO29CQUM1QyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQztvQkFDNUMsTUFBTTtpQkFDUDtnQkFFRCxhQUFhLEdBQUcsYUFBYSxDQUFDLE1BQU0sRUFBRSxDQUFDO2FBQ3hDO1lBRUQsSUFBSSxDQUFDLGdCQUFnQixFQUFFO2dCQUNyQixpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzdCLE9BQU87YUFDUjtZQUVELGlCQUFpQixDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzNDLENBQUMsQ0FBQyxDQUFDO1FBRUgsc0VBQXNFO1FBQ3RFLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsS0FBYSxFQUFFLEVBQUU7WUFDaEQsTUFBTSxnQkFBZ0IsR0FBRyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUVsRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFO2dCQUM1QixPQUFPLENBQUMsR0FBRyxDQUFDLHNEQUFzRCxDQUFDLENBQUM7Z0JBQ3BFLE9BQU87YUFDUjtZQUVELGNBQWMsR0FBRyxJQUFJLENBQUM7WUFDdEIsdUJBQXVCLEdBQUcsSUFBSSxDQUFDO1lBRS9CLE9BQU8sQ0FBQyxJQUFJLENBQUMsc0NBQW9CLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFFM0Msc0dBQXNHO1lBQ3RHLElBQUksUUFBUSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1lBRXRELDZGQUE2RjtZQUM3RixJQUFJLFlBQVksQ0FBQztZQUNqQixJQUFJLFFBQVEsRUFBRTtnQkFDWixZQUFZLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUMvQixZQUFZLENBQUMsSUFBSSxDQUFDLDRDQUEwQixFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUV0RCxPQUFPLENBQUMsUUFBUSxDQUFDLHdEQUFzQyxDQUFDLENBQUM7Z0JBQ3pELE9BQU8sQ0FBQyxJQUFJLENBQUMsd0RBQXNDLEVBQUUsTUFBTSxDQUFDLENBQUM7YUFDOUQ7WUFFRCxJQUFJLGNBQWMsQ0FBQyxZQUFZLENBQUMsZUFBZSxFQUFFO2dCQUMvQyxNQUFNLFlBQVksR0FDaEIsaUNBQWlDLENBQy9CLGNBQWMsQ0FBQyxZQUFZLENBQUMsZUFBZSxDQUM1QyxJQUFJLGNBQWMsQ0FBQyxZQUFZLENBQUMsZUFBZSxDQUFDO2dCQUNuRCxNQUFNLFlBQVksR0FBRyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsSUFBSSxZQUFZLEVBQUUsQ0FBQyxDQUFDO2dCQUNuRSxJQUFJLFlBQVksQ0FBQyxNQUFNLEVBQUU7b0JBQ3ZCLElBQUksUUFBUSxJQUFJLFlBQVksRUFBRTt3QkFDNUIsWUFBWSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztxQkFDaEQ7eUJBQU07d0JBQ0wsT0FBTyxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztxQkFDM0M7b0JBRUQsT0FBTztpQkFDUjthQUNGO1lBRUQsSUFBSSxjQUFjLENBQUMsWUFBWSxDQUFDLGdCQUFnQixFQUFFO2dCQUNoRCxNQUFNLGFBQWEsR0FDakIsaUNBQWlDLENBQy9CLGNBQWMsQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQzdDLElBQUksY0FBYyxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDcEQsTUFBTSxhQUFhLEdBQUcsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLElBQUksYUFBYSxFQUFFLENBQUMsQ0FBQztnQkFDckUsSUFBSSxhQUFhLENBQUMsTUFBTSxFQUFFO29CQUN4QixJQUFJLFFBQVEsSUFBSSxZQUFZLEVBQUU7d0JBQzVCLFlBQVksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7cUJBQ2xEO3lCQUFNO3dCQUNMLE9BQU8sQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7cUJBQzdDO29CQUNELE9BQU87aUJBQ1I7YUFDRjtZQUVELElBQUksUUFBUSxJQUFJLFlBQVksRUFBRTtnQkFDNUIsWUFBWSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO2FBQ3pDO2lCQUFNO2dCQUNMLE9BQU8sQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsQ0FBQzthQUNwQztRQUNILENBQUMsQ0FBQyxDQUFDO0tBQ0o7U0FBTSxJQUFJLFVBQVUsQ0FBQyxJQUFJLEtBQUssOEJBQVUsQ0FBQyxVQUFVLEVBQUU7UUFDcEQsTUFBTSxjQUFjLEdBQW9CLFVBQTZCLENBQUM7UUFFdEUsTUFBTSwwQkFBMEIsR0FBUSxFQUFFLENBQUM7UUFFM0MsY0FBYyxDQUFDLFlBQVksQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQ3JELENBQUMsVUFBa0IsRUFBRSxFQUFFO1lBQ3JCLG1DQUFtQztZQUNuQyxJQUFJLGtCQUFrQixDQUFDO1lBQ3ZCLElBQUksSUFBQSxnQkFBQyxFQUFDLElBQUksVUFBVSxFQUFFLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUNsQyxrQkFBa0IsR0FBRyxVQUFVLENBQUM7YUFDakM7aUJBQU07Z0JBQ0wscUNBQXFDO2dCQUNyQyxJQUFJLGtCQUFrQixHQUFHLGlDQUFpQyxDQUN4RCxVQUFVLElBQUksRUFBRSxDQUNqQixDQUFDO2dCQUVGLElBQUksQ0FBQyxrQkFBa0IsRUFBRTtvQkFDdkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxREFBcUQsQ0FBQyxDQUFDO29CQUNuRSxPQUFPLEtBQUssQ0FBQztpQkFDZDtnQkFFRCxrQkFBa0IsR0FBRyxrQkFBa0IsQ0FBQzthQUN6QztZQUVELGlHQUFpRztZQUNqRyxJQUFBLGdCQUFDLEVBQUMsSUFBSSxrQkFBa0IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBVSxFQUFFLElBQUksRUFBRSxFQUFFO2dCQUNwRCxNQUFNLGlCQUFpQixHQUFHLElBQUEsdUNBQXFCLEVBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3RELE1BQU0sZ0JBQWdCLEdBQUcsSUFBQSx1Q0FBcUIsRUFBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBRW5FLElBQUksaUJBQWlCLElBQUksZ0JBQWdCLEVBQUU7b0JBQ3pDLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO3dCQUNqRCwwQkFBMEIsQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQztxQkFDbkQ7b0JBRUQsMEJBQTBCLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxJQUFJLENBQUM7d0JBQ2hELFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUzt3QkFDekIsaUJBQWlCO3FCQUNsQixDQUFDLENBQUM7aUJBQ0o7Z0JBRUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsd0RBQXNDLENBQUMsQ0FBQztnQkFDM0QsSUFBSSxDQUFDLFlBQVksQ0FBQyx3REFBc0MsRUFBRSxNQUFNLENBQUMsQ0FBQztnQkFFbEUsY0FBYyxHQUFHLElBQUksQ0FBQztnQkFDdEIsdUJBQXVCLEdBQUcsSUFBSSxDQUFDO1lBQ2pDLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUNGLENBQUM7UUFFRixzQkFBc0IsQ0FBQywwQkFBMEI7WUFDL0MsMEJBQTBCLENBQUM7S0FDOUI7U0FBTSxJQUNMLFVBQVUsQ0FBQyxJQUFJLEtBQUssOEJBQVUsQ0FBQyxTQUFTO1FBQ3hDLFVBQVUsQ0FBQyxJQUFJLEtBQUssOEJBQVUsQ0FBQyxPQUFPLEVBQ3RDO1FBQ0EsSUFBSSxTQUFTLEVBQ1gsYUFBYSxFQUNiLG9CQUFvQixFQUNwQixjQUFjLEVBQ2QsaUJBQWlCLEVBQ2pCLFNBQVMsQ0FBQztRQUVaLElBQUksVUFBVSxDQUFDLElBQUksS0FBSyw4QkFBVSxDQUFDLFNBQVMsRUFBRTtZQUM1QyxNQUFNLGNBQWMsR0FBbUIsVUFBNEIsQ0FBQztZQUNwRSxpQkFBaUIsR0FBRyxjQUFjLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQztZQUMxRCxTQUFTLEdBQUcsY0FBYyxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUM7WUFDbEQsYUFBYSxHQUFHLGNBQWMsQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDO1lBQzFELG9CQUFvQixHQUFHLGNBQWMsQ0FBQyxZQUFZLENBQUMsb0JBQW9CLENBQUM7WUFDeEUsY0FBYyxHQUFHLGNBQWMsQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDO1lBQzNELFNBQVMsR0FBRyxjQUFjLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQztZQUNsRCxJQUFJLGNBQWMsRUFBRTtnQkFDbEIsU0FBUyxHQUFHLG9DQUE0QixDQUFDO2FBQzFDO1NBQ0Y7YUFBTTtZQUNMLGdHQUFnRztZQUNoRyxNQUFNLGNBQWMsR0FDbEIsVUFBVSxDQUFDLFlBQW1DLENBQUM7WUFDakQsU0FBUyxHQUFHLEVBQUUsQ0FBQztZQUNmLGFBQWEsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxjQUFjLENBQUM7aUJBQ3ZELEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUNYLElBQUksY0FBYyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsS0FBSyx5Q0FBcUIsRUFBRTtvQkFDaEUsT0FBTyxHQUFHLElBQUEsK0JBQWdCLEVBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDO2lCQUN0RDtnQkFFRCxPQUFPLEdBQUcsSUFBQSwrQkFBZ0IsRUFBQyxHQUFHLENBQUMsS0FDN0IsY0FBYyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQ25DLEdBQUcsQ0FBQztZQUNOLENBQUMsQ0FBQztpQkFDRCxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDWixvQkFBb0IsR0FBRyxjQUFjLENBQUMsVUFBVSxDQUFDO1lBQ2pELFNBQVMsR0FBRyxjQUFjLENBQUMsU0FBUyxDQUFDO1NBQ3RDO1FBQ0QsTUFBTSxvQkFBb0IsR0FBRyxpQkFBaUIsQ0FBQztRQUUvQyw0QkFBNEI7UUFDNUIsSUFBSSxVQUFVLEdBQUcsQ0FBQyxTQUFTLElBQUksRUFBRSxDQUFDO2FBQy9CLE9BQU8sQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLENBQUMsQ0FBQyxtREFBbUQ7YUFDdEYsT0FBTyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLHFEQUFxRDtRQUUvRSxxRUFBcUU7UUFDckUsa0NBQWtDO1FBQ2xDLGdEQUFnRDtRQUNoRCx3RUFBd0U7UUFDeEUsSUFBSSxhQUFhLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDcEMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLGFBQWEsQ0FBQztZQUMvQyxVQUFVLEdBQUcsR0FBRyxxREFBbUMsR0FBRyxXQUFXLElBQUksVUFBVSxFQUFFLENBQUM7U0FDbkY7UUFFRCxJQUFJLFVBQVUsRUFBRTtZQUNkLElBQUksQ0FBQyxjQUFjLEVBQUU7Z0JBQ25CLHlEQUF5RDtnQkFDekQsSUFBQSxnQkFBQyxFQUFDLElBQUksb0JBQW9CLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxvQ0FBNEIsQ0FBQyxDQUFDO2FBQ3pFO1lBRUQsSUFBSSxhQUFhLEVBQUU7Z0JBQ2pCLElBQUksU0FBUyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO29CQUNyQyxNQUFNLG9CQUFvQixHQUFHO3dCQUMzQixPQUFPO3dCQUNQLFVBQVU7d0JBQ1YsT0FBTzt3QkFDUCxRQUFRO3dCQUNSLFNBQVM7d0JBQ1QsVUFBVTtxQkFDWCxDQUFDO29CQUVGLE1BQU0sZUFBZSxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUNwRCxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQ3hDLENBQUM7b0JBQ0YsTUFBTSxxQkFBcUIsR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUV4RCxJQUFJLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO3dCQUM5QixNQUFNLGFBQWEsR0FBRyxHQUFHLFVBQVUsSUFBSSxxQkFBcUIsRUFBRSxDQUFDO3dCQUMvRCxlQUFlLENBQUMsYUFBYSxFQUFFLGFBQWEsRUFBRSxhQUFhLENBQUMsQ0FBQztxQkFDOUQ7eUJBQU07d0JBQ0wsZUFBZSxDQUFDLFVBQVUsRUFBRSxhQUFhLEVBQUUsVUFBVSxDQUFDLENBQUM7cUJBQ3hEO29CQUVELE1BQU0sWUFBWSxHQUFHLFNBQVM7eUJBQzNCLEdBQUcsQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsZ0JBQWdCLFFBQVEsRUFBRSxDQUFDO3lCQUM3QyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7b0JBQ1osTUFBTSwwQkFBMEIsR0FBRyxHQUFHLFVBQVUsR0FBRyxZQUFZLEVBQUUsQ0FBQztvQkFFbEUsZUFBZSxDQUNiLDBCQUEwQixFQUMxQixhQUFhLEVBQ2IsMEJBQTBCLENBQzNCLENBQUM7aUJBQ0g7cUJBQU07b0JBQ0wsZUFBZSxDQUFDLFVBQVUsRUFBRSxhQUFhLEVBQUUsVUFBVSxDQUFDLENBQUM7aUJBQ3hEO2FBQ0Y7WUFFRCxNQUFNLHFCQUFxQixHQUN6QixJQUFBLDBDQUFvQixFQUFDLHNDQUE4QixDQUFDLElBQUksRUFBRSxDQUFDO1lBRTdELG1DQUFtQztZQUNuQyxJQUFJLElBQUEsZ0JBQUMsRUFBQyxJQUFJLG9CQUFvQixFQUFFLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUM1QyxJQUFBLGdCQUFDLEVBQUMsSUFBSSxvQkFBb0IsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUVuRCx1QkFBdUIsR0FBRyxJQUFJLENBQUM7Z0JBRS9CLHFCQUFxQixDQUFDLElBQUksQ0FBQztvQkFDekIsVUFBVSxFQUFFLG9CQUFvQjtvQkFDaEMsU0FBUyxFQUFFLFVBQVU7aUJBQ3RCLENBQUMsQ0FBQzthQUNKO2lCQUFNO2dCQUNMLHFDQUFxQztnQkFDckMsSUFBSSxrQkFBa0IsR0FBRyxpQ0FBaUMsQ0FDeEQsb0JBQW9CLElBQUksRUFBRSxDQUMzQixDQUFDO2dCQUVGLElBQUksa0JBQWtCLElBQUksSUFBQSxnQkFBQyxFQUFDLElBQUksa0JBQWtCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7b0JBQ2hFLHVCQUF1QixHQUFHLElBQUksQ0FBQztvQkFDL0IsSUFBQSxnQkFBQyxFQUFDLElBQUksa0JBQWtCLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztvQkFFakQscUJBQXFCLENBQUMsSUFBSSxDQUFDO3dCQUN6QixVQUFVLEVBQUUsa0JBQWtCO3dCQUM5QixTQUFTLEVBQUUsVUFBVTtxQkFDdEIsQ0FBQyxDQUFDO2lCQUNKO2FBQ0Y7WUFFRCxJQUFBLDBDQUFvQixFQUNsQixzQ0FBOEIsRUFDOUIscUJBQXFCLENBQ3RCLENBQUM7WUFFRixzQkFBc0IsQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1lBQy9DLHNCQUFzQixDQUFDLGtCQUFrQixHQUFHLGlCQUFpQixDQUFDO1NBQy9EO0tBQ0Y7U0FBTSxJQUFJLFVBQVUsQ0FBQyxJQUFJLEtBQUssOEJBQVUsQ0FBQyxZQUFZLEVBQUU7UUFDdEQsTUFBTSx1QkFBdUIsR0FDM0IsVUFBVSxDQUFDLFlBQXVDLENBQUM7UUFFckQsbUNBQW1DO1FBQ25DLElBQUksSUFBQSxnQkFBQyxFQUFDLElBQUksdUJBQXVCLENBQUMsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDdkUsSUFBQSxnQkFBQyxFQUFDLElBQUksdUJBQXVCLENBQUMsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FDbEUsdUJBQXVCLENBQUMsU0FBUyxDQUNsQyxDQUFDO1lBRUYsdUJBQXVCLEdBQUcsSUFBSSxDQUFDO1NBQ2hDO2FBQU07WUFDTCxxQ0FBcUM7WUFDckMsSUFBSSxrQkFBa0IsR0FBRyxpQ0FBaUMsQ0FDeEQsdUJBQXVCLENBQUMsdUJBQXVCLElBQUksRUFBRSxDQUN0RCxDQUFDO1lBRUYsSUFBSSxrQkFBa0IsSUFBSSxJQUFBLGdCQUFDLEVBQUMsSUFBSSxrQkFBa0IsRUFBRSxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDaEUsdUJBQXVCLEdBQUcsSUFBSSxDQUFDO2dCQUMvQixJQUFBLGdCQUFDLEVBQUMsSUFBSSxrQkFBa0IsRUFBRSxDQUFDLENBQUMsV0FBVyxDQUNyQyx1QkFBdUIsQ0FBQyxTQUFTLENBQ2xDLENBQUM7YUFDSDtTQUNGO0tBQ0Y7U0FBTSxJQUFJLFVBQVUsQ0FBQyxJQUFJLEtBQUssOEJBQVUsQ0FBQyxRQUFRLEVBQUU7UUFDbEQsTUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDLFlBQW1DLENBQUM7UUFDcEUsTUFBTSxpQkFBaUIsR0FBRyxZQUFZLENBQUMsaUJBQWlCLENBQUM7UUFFekQsTUFBTSxlQUFlLEdBQUcsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFN0MsMkVBQTJFO1FBQzNFLG1GQUFtRjtRQUNuRixtRkFBbUY7UUFDbkYsSUFBQSxnQkFBQyxFQUFDLElBQUksZUFBZSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFVLEVBQUUsSUFBSSxFQUFFLEVBQUU7WUFDakQsTUFBTSxnQkFBZ0IsR0FBRyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEQsMkZBQTJGO1lBQzNGLE1BQU0sUUFBUSxHQUFHLElBQUEsZ0JBQUMsRUFBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNwQyxNQUFNLHFCQUFxQixHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFckMsSUFBSSxZQUFZLEdBQUcsSUFBSSxDQUFDO1lBQ3hCLElBQUksYUFBYSxHQUFHLElBQUEsZ0JBQUMsRUFBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUVwQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRTtnQkFDdEMsTUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLFVBQVUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM5RCxJQUFJLFlBQVksRUFBRTtvQkFDaEIscUJBQXFCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO29CQUN6QyxNQUFNLEtBQUssR0FBRyxJQUFBLGdCQUFDLEVBQUMsWUFBWSxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7b0JBQ3RDLElBQUksS0FBSyxHQUFHLGFBQWEsRUFBRTt3QkFDekIsWUFBWSxHQUFHLFlBQVksQ0FBQzt3QkFDNUIsYUFBYSxHQUFHLEtBQUssQ0FBQztxQkFDdkI7aUJBQ0Y7WUFDSCxDQUFDLENBQUMsQ0FBQztZQUVILCtDQUErQztZQUMvQyxJQUFJLHFCQUFxQixDQUFDLE1BQU0sS0FBSyxpQkFBaUIsQ0FBQyxNQUFNLEVBQUU7Z0JBQzdELDZDQUE2QzthQUM5QztZQUVELCtEQUErRDtZQUMvRCxpRkFBaUY7WUFDakYsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUM3QyxNQUFNLENBQUMsU0FBUyxHQUFHLDJDQUFtQyxDQUFDO1lBQ3ZELE1BQU0sQ0FBQyxZQUFZLENBQUMsc0NBQW9CLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxxREFBcUQ7WUFDeEcsTUFBTSxDQUFDLFlBQVksQ0FDakIsZ0JBQWdCLEVBQ2hCLDJDQUFtQyxDQUNwQyxDQUFDO1lBQ0YsTUFBTSxDQUFDLFlBQVksQ0FBQyxhQUFhLEVBQUUsMkNBQW1DLENBQUMsQ0FBQztZQUN4RSxNQUFNLENBQUMsWUFBWSxDQUFDLDRDQUEwQixFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ3hELHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO2dCQUNyQyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFFekMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsd0RBQXNDLENBQUMsQ0FBQztnQkFDM0QsSUFBSSxDQUFDLFlBQVksQ0FBQyx3REFBc0MsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUNwRSxDQUFDLENBQUMsQ0FBQztZQUVILGlEQUFpRDtZQUNqRCxZQUFZLENBQUMscUJBQXFCLENBQUMsYUFBYSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBRTFELGNBQWMsR0FBRyxJQUFJLENBQUM7WUFDdEIsdUJBQXVCLEdBQUcsSUFBSSxDQUFDO1FBQ2pDLENBQUMsQ0FBQyxDQUFDO0tBQ0o7U0FBTSxJQUFJLFVBQVUsQ0FBQyxJQUFJLEtBQUssOEJBQVUsQ0FBQyxTQUFTLEVBQUU7UUFDbkQsTUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDLFlBQXFDLENBQUM7UUFDdEUsTUFBTSxzQkFBc0IsR0FBRyxZQUFZLENBQUMsc0JBQXNCLENBQUM7UUFFbkUsc0JBQXNCLENBQUMsT0FBTyxDQUFDLENBQUMscUJBQXFCLEVBQUUsRUFBRTtZQUN2RCxJQUFBLGdCQUFDLEVBQUMsSUFBSSxxQkFBcUIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBVSxFQUFFLElBQUksRUFBRSxFQUFFO2dCQUN2RCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBZ0IsQ0FBQztnQkFFdkQsVUFBVSxDQUFDLFlBQVksQ0FBQyw0Q0FBMEIsRUFBRSxNQUFNLENBQUMsQ0FBQztnQkFDNUQsVUFBVSxDQUFDLFlBQVksQ0FBQyxzQ0FBb0IsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLHFEQUFxRDtnQkFFNUcsaURBQWlEO2dCQUNqRCxVQUFVLENBQUMsWUFBWSxDQUNyQixnQkFBZ0IsRUFDaEIsR0FBRyxvQ0FBNEIsR0FBRyxxQkFBcUIsRUFBRSxDQUMxRCxDQUFDO2dCQUNGLFVBQVUsQ0FBQyxZQUFZLENBQ3JCLGFBQWEsRUFDYixHQUFHLG9DQUE0QixHQUFHLHFCQUFxQixFQUFFLENBQzFELENBQUM7Z0JBQ0YsVUFBVSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQ3RCLG9DQUE0QixHQUFHLHFCQUFxQixDQUNyRCxDQUFDO2dCQUNGLFVBQVUsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUM7Z0JBRW5ELElBQUksUUFBUSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUMvQyxPQUFPLFFBQVEsQ0FBQyxNQUFNLEVBQUU7b0JBQ3RCLE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQztvQkFDN0IsSUFBSSxDQUFDLEtBQUssRUFBRTt3QkFDVixTQUFTO3FCQUNWO29CQUVELE1BQU0sVUFBVSxHQUNkLEtBQUssQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUM7d0JBQ3BDLEtBQUssQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLENBQUM7b0JBQ3BDLElBQUksQ0FBQyxVQUFVLEVBQUU7d0JBQ2YsU0FBUztxQkFDVjtvQkFFRCxLQUFLLENBQUMsWUFBWSxDQUNoQixnQkFBZ0IsRUFDaEIsR0FBRyxvQ0FBNEIsR0FBRyxVQUFVLEVBQUUsQ0FDL0MsQ0FBQztvQkFDRixLQUFLLENBQUMsWUFBWSxDQUNoQixhQUFhLEVBQ2IsR0FBRyxvQ0FBNEIsR0FBRyxVQUFVLEVBQUUsQ0FDL0MsQ0FBQztvQkFDRixLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztvQkFDbkMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsb0NBQTRCLEdBQUcsVUFBVSxDQUFDLENBQUM7b0JBQy9ELEtBQUssQ0FBQyxZQUFZLENBQUMsc0NBQW9CLEVBQUUsTUFBTSxDQUFDLENBQUM7b0JBRWpELFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO2lCQUM5QztnQkFFRCxpREFBaUQ7Z0JBQ2pELElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUM7Z0JBRW5ELGNBQWMsR0FBRyxJQUFJLENBQUM7Z0JBQ3RCLHVCQUF1QixHQUFHLElBQUksQ0FBQztZQUNqQyxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0tBQ0o7U0FBTSxJQUFJLFVBQVUsQ0FBQyxJQUFJLEtBQUssOEJBQVUsQ0FBQyxVQUFVLEVBQUU7UUFDcEQsTUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDLFlBQXFDLENBQUM7UUFFdEUsSUFBQSxnQkFBQyxFQUFDLElBQUksWUFBWSxDQUFDLGtCQUFrQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFVLEVBQUUsSUFBSSxFQUFFLEVBQUU7WUFDakUsTUFBTSxXQUFXLEdBQUcsSUFBQSxnQkFBQyxFQUNuQixHQUFHLEdBQUcsWUFBWSxDQUFDLFVBQVUsR0FBRyxLQUFLLEdBQUcsWUFBWSxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQ3RFLENBQUM7WUFDRixXQUFXLENBQUMsSUFBSSxDQUFDLHNDQUFvQixFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMscURBQXFEO1lBQ3JHLFdBQVcsQ0FBQyxJQUFJLENBQUMsNENBQTBCLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFFckQsTUFBTSxLQUFLLEdBQUcsSUFBQSxnQkFBQyxFQUFDLElBQUksQ0FBQyxDQUFDO1lBRXRCLG1FQUFtRTtZQUNuRSxnQkFBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxFQUFFO2dCQUMxQixXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzFDLENBQUMsQ0FBQyxDQUFDO1lBRUgsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRXpELHFFQUFxRTtZQUNyRSxLQUFLLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRTFCLHlCQUF5QjtZQUN6QixLQUFLLENBQUMsUUFBUSxDQUFDLHdEQUFzQyxDQUFDLENBQUM7WUFDdkQsS0FBSyxDQUFDLElBQUksQ0FBQyx3REFBc0MsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUUzRCxjQUFjLEdBQUcsSUFBSSxDQUFDO1lBQ3RCLHVCQUF1QixHQUFHLElBQUksQ0FBQztRQUNqQyxDQUFDLENBQUMsQ0FBQztLQUNKO1NBQU0sSUFBSSxVQUFVLENBQUMsSUFBSSxLQUFLLDhCQUFVLENBQUMsSUFBSSxFQUFFO1FBQzlDLE1BQU0sRUFDSixjQUFjLEVBQUUsZUFBZSxFQUMvQix1QkFBdUIsRUFBRSx3QkFBd0IsR0FDbEQsR0FBRyw2QkFBNkIsQ0FBQyxVQUFVLEVBQUUsVUFBd0IsQ0FBQyxDQUFDO1FBRXhFLGNBQWMsR0FBRyxlQUFlLENBQUM7UUFDakMsdUJBQXVCLEdBQUcsd0JBQXdCLENBQUM7S0FDcEQ7U0FBTSxJQUFJLFVBQVUsQ0FBQyxJQUFJLEtBQUssOEJBQVUsQ0FBQyxJQUFJLEVBQUU7UUFDOUMsTUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDLFlBQWdDLENBQUM7UUFFakUsTUFBTSxZQUFZLEdBQUcsWUFBWSxDQUFDLFlBQVksQ0FBQztRQUUvQyxJQUFJLGtEQUE4QixDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDOUQsTUFBTSxFQUNKLGNBQWMsRUFBRSxlQUFlLEVBQy9CLHVCQUF1QixFQUFFLHdCQUF3QixHQUNsRCxHQUFHLElBQUEsaUNBQXlCLEVBQUMsVUFBVSxFQUFFLFlBQVksRUFBRSxZQUFZLENBQUMsQ0FBQztZQUV0RSxjQUFjLEdBQUcsZUFBZSxDQUFDO1lBQ2pDLHVCQUF1QixHQUFHLHdCQUF3QixDQUFDO1lBRW5ELElBQUksWUFBWSxDQUFDLGdCQUFnQixFQUFFO2dCQUNqQyxJQUFBLHlCQUFpQixFQUFDLFVBQVUsRUFBRSxZQUFZLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDcEU7U0FDRjtLQUNGO1NBQU0sSUFBSSxVQUFVLENBQUMsSUFBSSxLQUFLLDhCQUFVLENBQUMsY0FBYyxFQUFFO1FBQ3hELE1BQU0sRUFDSix1QkFBdUIsRUFDdkIsVUFBVSxFQUNWLFVBQVUsRUFDVixlQUFlLEVBQ2YsbUJBQW1CLEdBQ3BCLEdBQUcsVUFBVSxDQUFDLFlBQXlDLENBQUM7UUFFekQsMkVBQTJFO1FBQzNFLEtBQUssTUFBTSxRQUFRLElBQUksVUFBVSxFQUFFO1lBQ2pDLElBQUEsZ0JBQUMsRUFBQyxJQUFJLHVCQUF1QixFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDeEQ7UUFFRCxDQUNFLHlDQUF5QyxDQUFDLHVCQUF1QixDQUFDLElBQUksRUFBRSxDQUN6RSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFO1lBQ3RCLElBQUEsZ0JBQUMsRUFBQyxJQUFJLHVCQUF1QixFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDMUQsQ0FBQyxDQUFDLENBQUM7UUFFSCxLQUFLLE1BQU0sUUFBUSxJQUFJLFVBQVUsRUFBRTtZQUNqQyxJQUFBLGdCQUFDLEVBQUMsSUFBSSx1QkFBdUIsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3JEO1FBRUQsS0FBSyxNQUFNLGFBQWEsSUFBSSxlQUFlLEVBQUU7WUFDM0MsZUFBZSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQzVEO1FBRUQsSUFBSSxtQkFBbUIsRUFBRTtZQUN2Qix5Q0FBeUMsQ0FBQyx1QkFBdUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUN4RSxLQUFLLE1BQU0sYUFBYSxJQUFJLGVBQWUsRUFBRTtnQkFDM0MseUNBQXlDLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxJQUFJLENBQ3JFLGFBQWEsQ0FBQyxRQUFRLENBQ3ZCLENBQUM7YUFDSDtTQUNGO2FBQU07WUFDTCx5Q0FBeUMsQ0FBQyx1QkFBdUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQztTQUN6RTtLQUNGO0lBRUQsOEZBQThGO0lBQzlGLElBQUksb0NBQW9DLEdBQ3RDLFVBQVUsQ0FBQyx1Q0FBdUMsRUFBRSxDQUFDO0lBQ3ZELElBQUksMENBQTBDLEdBQzVDLFVBQVUsQ0FBQyw2Q0FBNkMsRUFBRSxDQUFDO0lBRTdELElBQUksVUFBVSxDQUFDLElBQUksS0FBSyw4QkFBVSxDQUFDLElBQUksRUFBRTtRQUN2QyxvQ0FBb0MsR0FDbEMsVUFBVSxDQUFDLFlBQ1osQ0FBQyxZQUFZLENBQUMsMkNBQTJDLEVBQUUsQ0FBQztRQUM3RCwwQ0FBMEMsR0FDeEMsVUFBVSxDQUFDLFlBQ1osQ0FBQyxZQUFZLENBQUMsaURBQWlELEVBQUUsQ0FBQztLQUNwRTtJQUVELElBQUksb0NBQW9DLEtBQUssU0FBUyxFQUFFO1FBQ3RELElBQUEsMENBQW9CLEVBQ2xCLDBDQUFvQixFQUNwQixvQ0FBb0MsQ0FDckMsQ0FBQztRQUNGLFVBQVUsQ0FBQyxXQUFXLENBQUM7WUFDckIsRUFBRSxFQUFFLDRDQUF3QixDQUFDLG9CQUFvQjtZQUNqRCxVQUFVLEVBQUUsb0NBQW9DO1lBQ2hELFNBQVMsRUFBRSxNQUFBLElBQUEsZ0JBQUMsRUFDVixJQUFJLG9DQUFrQixHQUFHLG9DQUFvQyxFQUFFLENBQ2hFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQywwQ0FBRSxTQUFTO1NBQ3BCLENBQUMsQ0FBQztLQUNKO0lBRUQsSUFBSSwwQ0FBMEMsS0FBSyxTQUFTLEVBQUU7UUFDNUQsSUFBQSwwQ0FBb0IsRUFDbEIsaURBQTJCLEVBQzNCLDBDQUEwQyxDQUMzQyxDQUFDO1FBQ0YsVUFBVSxDQUFDLFdBQVcsQ0FBQztZQUNyQixFQUFFLEVBQUUsNENBQXdCLENBQUMsMkJBQTJCO1lBQ3hELFdBQVcsRUFBRSwwQ0FBMEM7WUFDdkQsVUFBVSxFQUFFLDBDQUEwQyxhQUExQywwQ0FBMEMsdUJBQTFDLDBDQUEwQyxDQUFFLEdBQUcsQ0FDekQsQ0FBQyxVQUFVLEVBQUUsRUFBRSxXQUNiLE9BQUEsTUFBQSxJQUFBLGdCQUFDLEVBQUMsSUFBSSxvQ0FBa0IsR0FBRyxVQUFVLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsMENBQUUsU0FBUyxDQUFBLEVBQUEsQ0FDN0Q7U0FDRixDQUFDLENBQUM7S0FDSjtJQUVELElBQUksdUJBQXVCLEVBQUU7UUFDM0Isb0VBQW9FO1FBQ3BFLElBQUEsZ0JBQUMsRUFBQyxLQUFLLG1EQUFpQyxRQUFRLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztLQUM1RDtJQUVELFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFDckIsRUFBRSxFQUFFLDRDQUF3QixDQUFDLG1CQUFtQjtRQUNoRCxVQUFVLEVBQUUsZUFBZTtRQUMzQixpQkFBaUIsRUFBRSxzQkFBc0I7UUFDekMsdUJBQXVCO0tBQ3hCLENBQUMsQ0FBQztJQUVILE9BQU8sRUFBRSxjQUFjLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQztBQUNyRCxDQUFDLENBQUM7QUE5cUJXLFFBQUEseUJBQXlCLDZCQThxQnBDO0FBRUYsTUFBTSw2QkFBNkIsR0FBRyxDQUNwQyxVQUFlLEVBQ2YsVUFBc0IsRUFDeUMsRUFBRTtJQUNqRSxNQUFNLFlBQVksR0FBRyxVQUFVLENBQUMsWUFBWSxDQUFDO0lBRTdDLE1BQU0sWUFBWSxHQUFHLFlBQVksQ0FBQyxZQUFZLENBQUM7SUFFL0MsSUFBSSxDQUFDLGtEQUE4QixDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDL0QsT0FBTyxFQUFFLGNBQWMsRUFBRSxLQUFLLEVBQUUsdUJBQXVCLEVBQUUsS0FBSyxFQUFFLENBQUM7S0FDbEU7SUFFRCxJQUFJLGNBQWMsR0FBRyxLQUFLLENBQUM7SUFDM0IsSUFBSSx1QkFBdUIsR0FBRyxLQUFLLENBQUM7SUFFcEMsdUVBQXVFO0lBQ3ZFLElBQUksWUFBWSxDQUFDLGdCQUFnQixFQUFFO1FBQ2pDLE1BQU0scUJBQXFCLEdBRXZCLEVBQUUsQ0FBQztRQUNQLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDNUQsTUFBTSxLQUFLLEdBQUcsWUFBWSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3BELHFCQUFxQixDQUFDLEtBQUssQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUN4QyxDQUFDLENBQUMsQ0FBQztRQUVILDZGQUE2RjtRQUM3RixrQ0FBa0M7UUFDbEMsTUFBTSxpQ0FBaUMsR0FDckMsWUFBWSxDQUFDLDJDQUEyQyxFQUFFLEtBQUssU0FBUyxDQUFDO1FBQzNFLElBQUEseUJBQWlCLEVBQ2YsVUFBVSxFQUNWLHFCQUFxQixFQUNyQixDQUFDLGlDQUFpQyxDQUNuQyxDQUFDO0tBQ0g7SUFFRCw4QkFBOEI7SUFDOUIsSUFBSSxZQUFZLENBQUMsSUFBSSxLQUFLLDhCQUFVLENBQUMsVUFBVSxFQUFFO1FBQy9DLHlCQUF5QjtRQUN6QixNQUFNLGlCQUFpQixHQUNyQixZQUFZLENBQUMsWUFBcUMsQ0FBQztRQUNyRCxNQUFNLGtCQUFrQixHQUFHLGlCQUFpQixDQUFDLG1CQUFtQixDQUFDO1FBRWpFLGdGQUFnRjtRQUNoRixJQUFJLFlBQVksQ0FBQyx1QkFBdUIsRUFBRTtZQUN4QyxNQUFNLGlCQUFpQixHQUFHLFlBQVksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1lBQzlELE1BQU0sMEJBQTBCLEdBRTVCLGlCQUFpQixDQUFDLDBCQUEwQixJQUFJLEVBQUUsQ0FBQztZQUV2RCxNQUFNLENBQUMsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUMsT0FBTyxDQUNoRCxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsWUFBWSxDQUFDLEVBQUUsRUFBRTtnQkFDbkMsbURBQW1EO2dCQUNuRCxNQUFNLGtCQUFrQixHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsSUFBSSxDQUN6RCxDQUFDLENBQU0sRUFBRSxDQUFNLEVBQUUsRUFBRTtvQkFDakIsTUFBTSxXQUFXLEdBQUcsMkJBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUM7b0JBQzlELE1BQU0sV0FBVyxHQUFHLDJCQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO29CQUM5RCxPQUFPLFdBQVcsQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUN6QyxXQUFXLENBQUMsVUFBVSxDQUN2QixDQUFDO2dCQUNKLENBQUMsQ0FDRixDQUFDO2dCQUVGLDBCQUEwQjtnQkFDMUIsTUFBTSxhQUFhLEdBQUcsSUFBQSxnQkFBQyxFQUNyQixJQUFJLG9DQUFrQixHQUFHLGdCQUFnQixFQUFFLENBQzVDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNULElBQUksYUFBYSxFQUFFO29CQUNqQix5Q0FBeUM7b0JBQ3pDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQVMsRUFBRSxFQUFFO3dCQUN2QyxNQUFNLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFFLEdBQUcsSUFBSSxDQUFDO3dCQUU5QyxNQUFNLE9BQU8sR0FBRywyQkFBWSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO3dCQUN4RCxNQUFNLGFBQWEsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQzt3QkFFbEUsTUFBTSxrQkFBa0IsR0FBRyxJQUFBLGdCQUFDLEVBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUUvQyxpQ0FBaUM7d0JBQ2pDLElBQUksa0JBQWtCLEVBQUU7NEJBQ3RCLGtCQUFrQixDQUFDLFlBQVksQ0FDN0IsNENBQTBCLEVBQzFCLE1BQU0sQ0FDUCxDQUFDOzRCQUNGLGtCQUFrQixDQUFDLFlBQVksQ0FBQyxzQ0FBb0IsRUFBRSxNQUFNLENBQUMsQ0FBQzs0QkFDOUQsYUFBYSxDQUFDLFlBQVksQ0FDeEIsa0JBQWtCLEVBQ2xCLGFBQWEsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLElBQUksSUFBSSxDQUM5QyxDQUFDOzRCQUNGLHVCQUF1QixHQUFHLElBQUksQ0FBQzs0QkFDL0IsY0FBYyxHQUFHLElBQUksQ0FBQzt5QkFDdkI7b0JBQ0gsQ0FBQyxDQUFDLENBQUM7aUJBQ0o7WUFDSCxDQUFDLENBQ0YsQ0FBQztTQUNIO2FBQU07WUFDTCxxQ0FBcUM7WUFDckMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUMsaUJBQWlCLEVBQUUsRUFBRTtnQkFDL0MsSUFBQSxnQkFBQyxFQUFDLElBQUksaUJBQWlCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsRUFBRTtvQkFDOUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsd0RBQXNDLENBQUMsQ0FBQztvQkFDOUQsSUFBSSxDQUFDLGVBQWUsQ0FBQyx3REFBc0MsQ0FBQyxDQUFDO29CQUU3RCxjQUFjLEdBQUcsSUFBSSxDQUFDO29CQUN0Qix1QkFBdUIsR0FBRyxJQUFJLENBQUM7Z0JBQ2pDLENBQUMsQ0FBQyxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7U0FDSjtLQUNGO1NBQU0sSUFDTCxZQUFZLENBQUMsSUFBSSxLQUFLLDhCQUFVLENBQUMsU0FBUztRQUMxQyxZQUFZLENBQUMsSUFBSSxLQUFLLDhCQUFVLENBQUMsT0FBTyxFQUN4QztRQUNBLE1BQU0saUJBQWlCLEdBQUcsWUFBWSxDQUFDLG9CQUFvQixFQUFFLENBQUM7UUFDOUQsTUFBTSxpQkFBaUIsR0FBRyxZQUFZLENBQUMsWUFBb0MsQ0FBQztRQUU1RSxNQUFNLFVBQVUsR0FBRyxpQkFBaUIsYUFBakIsaUJBQWlCLHVCQUFqQixpQkFBaUIsQ0FBRSxVQUFVLENBQUM7UUFDakQsSUFBSSxVQUFVLEVBQUU7WUFDZCxJQUFBLGdCQUFDLEVBQUMsSUFBSSxpQkFBaUIsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFFO2dCQUNuRSxJQUFJLElBQUEsZ0JBQUMsRUFBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLEVBQUU7b0JBQ2hDLElBQUEsZ0JBQUMsRUFBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUM7b0JBQ2hDLHVCQUF1QixHQUFHLElBQUksQ0FBQztpQkFDaEM7WUFDSCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBRUQsTUFBTSxrQkFBa0IsR0FBRyxpQkFBaUIsYUFBakIsaUJBQWlCLHVCQUFqQixpQkFBaUIsQ0FBRSxrQkFBa0IsQ0FBQztRQUNqRSxJQUFJLGtCQUFrQixFQUFFO1lBQ3RCLElBQUEsZ0JBQUMsRUFBQyxJQUFJLGlCQUFpQixDQUFDLG9CQUFvQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUU7Z0JBQ25FLElBQUksSUFBQSxnQkFBQyxFQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFO29CQUN4QyxJQUFBLGdCQUFDLEVBQUMsSUFBSSxDQUFDLENBQUMsV0FBVyxDQUFDLGtCQUFrQixDQUFDLENBQUM7b0JBQ3hDLHVCQUF1QixHQUFHLElBQUksQ0FBQztpQkFDaEM7WUFDSCxDQUFDLENBQUMsQ0FBQztTQUNKO0tBQ0Y7U0FBTSxJQUFJLFlBQVksQ0FBQyxJQUFJLEtBQUssOEJBQVUsQ0FBQyxjQUFjLEVBQUU7UUFDMUQsTUFBTSxFQUFFLHVCQUF1QixFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsR0FDdkQsWUFBWSxDQUFDLFlBQXlDLENBQUM7UUFFekQsMkVBQTJFO1FBQzNFLEtBQUssTUFBTSxRQUFRLElBQUksVUFBVSxFQUFFO1lBQ2pDLElBQUEsZ0JBQUMsRUFBQyxJQUFJLHVCQUF1QixFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDeEQ7UUFFRCxLQUFLLE1BQU0sUUFBUSxJQUFJLFVBQVUsRUFBRTtZQUNqQyxJQUFBLGdCQUFDLEVBQUMsSUFBSSx1QkFBdUIsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3JEO1FBRUQseUNBQXlDLENBQUMsdUJBQXVCLENBQUMsR0FBRyxFQUFFLENBQUM7S0FDekU7U0FBTSxJQUFJLFlBQVksQ0FBQyxJQUFJLEtBQUssOEJBQVUsQ0FBQyxPQUFPLEVBQUU7UUFDbkQsTUFBTSxpQkFBaUIsR0FBRyxZQUFZLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUM5RCxNQUFNLFFBQVEsR0FBRyxpQkFBaUIsYUFBakIsaUJBQWlCLHVCQUFqQixpQkFBaUIsQ0FBRSxRQUFRLENBQUM7UUFFN0MsUUFBUSxhQUFSLFFBQVEsdUJBQVIsUUFBUSxDQUFFLE9BQU8sQ0FBQyxDQUFDLE9BQWUsRUFBRSxFQUFFO1lBQ3BDLElBQUEsZ0JBQUMsRUFBQyxJQUFJLE9BQU8sRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDMUIsdUJBQXVCLEdBQUcsSUFBSSxDQUFDO1FBQ2pDLENBQUMsQ0FBQyxDQUFDO1FBRUgsY0FBYyxHQUFHLElBQUksQ0FBQztLQUN2QjtJQUVELE9BQU8sRUFBRSxjQUFjLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQztBQUNyRCxDQUFDLENBQUM7QUFFRjs7R0FFRztBQUNJLE1BQU0saUJBQWlCLEdBQUcsQ0FDL0IsVUFBZSxFQUNmLGdCQUVDLEVBQ0QsaUJBQTJCLEVBQ2xCLEVBQUU7SUFDWCxzQ0FBc0M7SUFDdEMsTUFBTSxPQUFPLEdBQVEsRUFBRSxDQUFDO0lBQ3hCLE1BQU0sQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxPQUFPLENBQ3RDLENBQUMsQ0FBQyxjQUFjLEVBQUUsYUFBYSxDQUFDLEVBQUUsRUFBRTtRQUNsQyxJQUFBLGdCQUFDLEVBQUMsSUFBSSxjQUFjLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQVUsRUFBRSxJQUFTLEVBQUUsRUFBRTtZQUNyRCxPQUFPLENBQUMsSUFBSSxDQUFDO2dCQUNYLElBQUk7Z0JBQ0osY0FBYztnQkFDZCxhQUFhO2FBQ2QsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQ0YsQ0FBQztJQUVGLHVGQUF1RjtJQUN2RixPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBVyxFQUFFLEVBQUU7UUFDOUIsTUFBTSxLQUFLLEdBQUcsSUFBQSxnQkFBQyxFQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3QixNQUFNLFFBQVEsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsT0FBTyxDQUNsRCxJQUFJLE1BQU0sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxjQUFjLEVBQUUsRUFBRSxHQUFHLENBQUMsRUFDM0MsTUFBTSxDQUFDLGFBQWEsQ0FDckIsQ0FBQztRQUNGLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRTlCLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixFQUFFLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNqRSxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLEVBQUUsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ2hFLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLGlCQUFpQixFQUFFO1FBQ3RCLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztLQUNoQztJQUVELE1BQU0sV0FBVyxHQUFHO1FBQ2xCO1lBQ0UsR0FBRyxFQUFFLDBDQUFvQjtZQUN6QixTQUFTLEVBQUUsNENBQXdCLENBQUMsb0JBQW9CO1NBQ3pEO1FBQ0Q7WUFDRSxHQUFHLEVBQUUseUNBQW1CO1lBQ3hCLFNBQVMsRUFBRSw0Q0FBd0IsQ0FBQyxtQkFBbUI7U0FDeEQ7S0FDRixDQUFDO0lBQ0YsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUU7O1FBQ3pDLE1BQU0sVUFBVSxHQUFHLElBQUEsMENBQW9CLEVBQUMsR0FBRyxDQUFDLENBQUM7UUFDN0MsTUFBTSxZQUFZLEdBQUcsMkJBQVksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDdEQsSUFBSSxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDN0MsTUFBTSxVQUFVLEdBQUcsSUFBSSwyQkFBWSxDQUNqQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLEVBQ3pDLFlBQVksQ0FBQyxZQUFZLEVBQ3pCLFlBQVksQ0FBQyxVQUFVLENBQ3hCLENBQUM7WUFDRixJQUFBLDBDQUFvQixFQUFDLEdBQUcsRUFBRSxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUUvQyxVQUFVLENBQUMsV0FBVyxDQUFDO2dCQUNyQixFQUFFLEVBQUUsU0FBUztnQkFDYixVQUFVLEVBQUUsVUFBVSxDQUFDLE1BQU0sRUFBRTtnQkFDL0IsU0FBUyxFQUFFLE1BQUEsSUFBQSxnQkFBQyxFQUFDLElBQUksb0NBQWtCLEdBQUcsVUFBVSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLDBDQUMvRCxTQUFTO2FBQ2QsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDLENBQUMsQ0FBQztJQUVILDZDQUE2QztJQUM3QyxNQUFNLHdCQUF3QixHQUFHLElBQUEsMENBQW9CLEVBQ25ELGlEQUEyQixDQUM1QixDQUFDO0lBQ0YsSUFBSSx3QkFBd0IsYUFBeEIsd0JBQXdCLHVCQUF4Qix3QkFBd0IsQ0FBRSxNQUFNLEVBQUU7UUFDcEMsTUFBTSwyQkFBMkIsR0FBYSxFQUFFLENBQUM7UUFDakQsd0JBQXdCLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBa0IsRUFBRSxFQUFFO1lBQ3RELE1BQU0sWUFBWSxHQUFHLDJCQUFZLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3RELElBQUksZ0JBQWdCLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxFQUFFO2dCQUM3QyxNQUFNLFVBQVUsR0FBRyxJQUFJLDJCQUFZLENBQ2pDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsRUFDekMsWUFBWSxDQUFDLFlBQVksRUFDekIsWUFBWSxDQUFDLFVBQVUsQ0FDeEIsQ0FBQztnQkFDRiwyQkFBMkIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7YUFDdkQ7aUJBQU07Z0JBQ0wsMkJBQTJCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2FBQzlDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFBLDBDQUFvQixFQUNsQixpREFBMkIsRUFDM0IsMkJBQTJCLENBQzVCLENBQUM7UUFDRixVQUFVLENBQUMsV0FBVyxDQUFDO1lBQ3JCLEVBQUUsRUFBRSw0Q0FBd0IsQ0FBQywyQkFBMkI7WUFDeEQsV0FBVyxFQUFFLDJCQUEyQjtZQUN4QyxVQUFVLEVBQUUsMkJBQTJCLGFBQTNCLDJCQUEyQix1QkFBM0IsMkJBQTJCLENBQUUsR0FBRyxDQUMxQyxDQUFDLFVBQVUsRUFBRSxFQUFFLFdBQ2IsT0FBQSxNQUFBLElBQUEsZ0JBQUMsRUFBQyxJQUFJLG9DQUFrQixHQUFHLFVBQVUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQywwQ0FBRSxTQUFTLENBQUEsRUFBQSxDQUM3RDtTQUNGLENBQUMsQ0FBQztLQUNKO0lBRUQsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ2pDLENBQUMsQ0FBQztBQXZHVyxRQUFBLGlCQUFpQixxQkF1RzVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICQgZnJvbSAnanF1ZXJ5JztcbmltcG9ydCB7XG4gIFRFTVBPX0RFTEVURV9BRlRFUl9SRUZSRVNILFxuICBURU1QT19ET19OT1RfU0hPV19JTl9OQVZfVU5USUxfUkVGUkVTSCxcbiAgVEVNUE9fSU5TVEFOVF9VUERBVEUsXG4gIFRFTVBPX0lOU1RBTlRfVVBEQVRFX1NUWUxJTkdfUFJFRklYLFxuICBURU1QT19ESVNQTEFZX05PTkVfVU5USUxfUkVGUkVTSF9DTEFTUyxcbiAgZ2V0Q29kZWJhc2VJZEZyb21Ob2RlLFxuICBnZXRFbGVtZW50S2V5RnJvbU5vZGUsXG4gIEVMRU1FTlRfS0VZX1BSRUZJWCxcbiAgVEVNUE9fRUxFTUVOVF9JRCxcbiAgVEVNUE9fREVMRVRFX0FGVEVSX0lOU1RBTlRfVVBEQVRFLFxuICBURU1QT19PVVRMSU5FX1VOVElMX1JFRkVTSCxcbn0gZnJvbSAnLi9pZGVudGlmaWVyVXRpbHMnO1xuaW1wb3J0IHtcbiAgQWRkQ2xhc3NDaGFuZ2UsXG4gIEFkZENsYXNzQ2hhbmdlRmllbGRzLFxuICBBZGRKc3hDaGFuZ2UsXG4gIEFueUNoYW5nZUxlZGdlckl0ZW0sXG4gIENIQU5HRV9UWVBFU19XSVRIX0lOU1RBTlRfVU5ETyxcbiAgQ2hhbmdlVGFnQ2hhbmdlRmllbGRzLFxuICBDaGFuZ2VUeXBlLFxuICBEdXBsaWNhdGVDaGFuZ2VGaWVsZHMsXG4gIE1vdmVKc3hDaGFuZ2UsXG4gIFJlZG9DaGFuZ2VGaWVsZHMsXG4gIFJlbW92ZUNsYXNzQ2hhbmdlRmllbGRzLFxuICBSZW1vdmVKc3hDaGFuZ2UsXG4gIFJlbW92ZUpzeENoYW5nZUZpZWxkcyxcbiAgU3R5bGluZ0NoYW5nZUZpZWxkcyxcbiAgVW5kb0NoYW5nZSxcbiAgVW5kb0NoYW5nZUZpZWxkcyxcbiAgVXBkYXRlQ2xhc3Nlc0NoYW5nZUZpZWxkcyxcbiAgV3JhcERpdkNoYW5nZUZpZWxkcyxcbiAgcmVjb25zdHJ1Y3RDaGFuZ2VMZWRnZXJDbGFzcyxcbn0gZnJvbSAnLi9jaGFuZ2VMZWRnZXJUeXBlcyc7XG5pbXBvcnQge1xuICBERUxFVEVfU1RZTEVfQ09OU1RBTlQsXG4gIEZJWEVEX0lGUkFNRV9NRVNTQUdFX0lEUyxcbn0gZnJvbSAnLi9jb25zdGFudHNBbmRUeXBlcyc7XG5pbXBvcnQgeyBjYW1lbFRvU25ha2VDYXNlIH0gZnJvbSAnLi9jc3NSdWxlVXRpbHMnO1xuaW1wb3J0IHtcbiAgSE9WRVJFRF9FTEVNRU5UX0tFWSxcbiAgTVVMVElfU0VMRUNURURfRUxFTUVOVF9LRVlTLFxuICBTRUxFQ1RFRF9FTEVNRU5UX0tFWSxcbiAgZ2V0TWVtb3J5U3RvcmFnZUl0ZW0sXG4gIHNldE1lbW9yeVN0b3JhZ2VJdGVtLFxufSBmcm9tICcuL3Nlc3Npb25TdG9yYWdlVXRpbHMnO1xuaW1wb3J0IHsgVGVtcG9FbGVtZW50IH0gZnJvbSAnLi90ZW1wb0VsZW1lbnQnO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5cbi8vIFRoZXNlIGNvbnN0YW50cyBtYXRjaCB3aGF0IHRlbXBvLWFwaSBoYXNcbmV4cG9ydCBjb25zdCBXUkFQX0lOX0RJVl9QTEFDRUhPTERFUl9DT0RFQkFTRV9JRCA9XG4gICd0ZW1wby13cmFwLWluLWRpdi1wbGFjZWhvbGRlcic7XG5leHBvcnQgY29uc3QgRFVQTElDQVRFX1BMQUNFSE9MREVSX1BSRUZJWCA9ICd0ZW1wby1kdXBsaWNhdGUtcGxhY2Vob2xkZXItJztcbmV4cG9ydCBjb25zdCBBRERfSlNYX1BSRUZJWCA9ICd0ZW1wby1hZGQtanN4LXBsYWNlaG9sZGVyLSc7XG5cbi8vIFN0b3JlZCBpbiBtZW1vcnkgc3RvcmFnZSwgdXNlZCB0byBrZWVwIHRyYWNrIG9mIHNvbWUgcG9zc2libGUgYWRkIGNsYXNzIGluc3RhbnRcbi8vIHVwZGF0ZXMgdGhhdCBuZWVkIHRvIGJlIHJlLWFwcGxpZWQgYWZ0ZXIgYSBob3QgcmVsb2FkXG4vLyAoZS5nLiB3aGVuIHRoZSBhZGRpdGlvbmFsKSBpbnN0YW50IHVwZGF0ZXMgaGFwcGVuZWQgZHVyaW5nIGZsdXNoaW5nXG5leHBvcnQgY29uc3QgQUREX0NMQVNTX0lOU1RBTlRfVVBEQVRFX1FVRVVFID0gJ0FERF9DTEFTU19JTlNUQU5UX1VQREFURV9RVUVVRSc7XG5cbmV4cG9ydCBjb25zdCBURU1QT1JBUllfU1RZTElOR19DTEFTU19OQU1FID0gJ2FyYjg5LXRlbXAtc3R5bGluZyc7XG5cbmNvbnN0IGdldFRvcExldmVsQ29kZWJhc2VJZEZvckNvbXBvbmVudCA9IChjb21wb25lbnRJZDogc3RyaW5nKTogc3RyaW5nID0+IHtcbiAgbGV0IHRvcExldmVsQ29kZWJhc2VJZDogYW55ID0gbnVsbDtcbiAgbGV0IG1pbk51bWJlclBhcmVudHMgPSBJbmZpbml0eTtcbiAgJChgLmNvbXBvbmVudC0ke2NvbXBvbmVudElkfWApLmVhY2goKGluZGV4OiBhbnksIGVsZW1lbnQ6IGFueSkgPT4ge1xuICAgIGlmICgkKGVsZW1lbnQpLnBhcmVudHMoKS5sZW5ndGggPCBtaW5OdW1iZXJQYXJlbnRzKSB7XG4gICAgICBtaW5OdW1iZXJQYXJlbnRzID0gJChlbGVtZW50KS5wYXJlbnRzKCkubGVuZ3RoO1xuICAgICAgdG9wTGV2ZWxDb2RlYmFzZUlkID0gZ2V0Q29kZWJhc2VJZEZyb21Ob2RlKGVsZW1lbnQpO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHRvcExldmVsQ29kZWJhc2VJZDtcbn07XG5cbmNvbnN0IG1ha2VpZCA9IChsZW5ndGg6IG51bWJlcik6IHN0cmluZyA9PiB7XG4gIGxldCByZXN1bHQgPSAnJztcbiAgY29uc3QgY2hhcmFjdGVycyA9XG4gICAgJ0FCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5JztcbiAgY29uc3QgY2hhcmFjdGVyc0xlbmd0aCA9IGNoYXJhY3RlcnMubGVuZ3RoO1xuICBsZXQgY291bnRlciA9IDA7XG4gIHdoaWxlIChjb3VudGVyIDwgbGVuZ3RoKSB7XG4gICAgcmVzdWx0ICs9IGNoYXJhY3RlcnMuY2hhckF0KE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGNoYXJhY3RlcnNMZW5ndGgpKTtcbiAgICBjb3VudGVyICs9IDE7XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbmxldCBpbnRlcm1lZGlhdGVDbGFzc2VzRm9yU2xpZGVySW5zdGFudFVwZGF0ZToge1xuICBbY29kZWJhc2VJZDogc3RyaW5nXTogc3RyaW5nW107XG59ID0ge307XG5cbmV4cG9ydCBjb25zdCByZXNldEludGVybWVkaWF0ZUNsYXNzZXNGb3JTbGlkZXJJbnN0YW50VXBkYXRlID0gKCkgPT4ge1xuICBpbnRlcm1lZGlhdGVDbGFzc2VzRm9yU2xpZGVySW5zdGFudFVwZGF0ZSA9IHt9O1xufTtcblxuY29uc3QgYWRkQ2xhc3NDc3NSdWxlID0gKGNsYXNzTmFtZTogc3RyaW5nLCBydWxlczogc3RyaW5nLCBpZD86IHN0cmluZykgPT4ge1xuICBsZXQgc2VsZWN0b3IgPSBjbGFzc05hbWVcbiAgICAucmVwbGFjZSgvXFxbL2csICdcXFxcWycpXG4gICAgLnJlcGxhY2UoL1xcXS9nLCAnXFxcXF0nKVxuICAgIC5yZXBsYWNlKC9cXCgvZywgJ1xcXFwoJylcbiAgICAucmVwbGFjZSgvXFwpL2csICdcXFxcKScpXG4gICAgLnJlcGxhY2UoL1xcLi9nLCAnXFxcXC4nKVxuICAgIC5yZXBsYWNlKC9cXCUvZywgJ1xcXFwlJylcbiAgICAucmVwbGFjZSgvXFwhL2csICdcXFxcIScpXG4gICAgLnJlcGxhY2UoL1xcLy9nLCAnXFxcXC8nKVxuICAgIC5yZXBsYWNlKC8jL2csICdcXFxcIycpO1xuXG4gIHNlbGVjdG9yID0gYC4ke3NlbGVjdG9yfWA7XG4gIHRyeSB7XG4gICAgYWRkT3JFZGl0Q1NTUnVsZShzZWxlY3RvciwgcnVsZXMsIGlkKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUubG9nKCdFcnJvciBhZGRpbmcgY2xhc3MgQ1NTIHJ1bGUnLCBlKTtcbiAgfVxufTtcblxuY29uc3QgYWRkT3JFZGl0Q1NTUnVsZSA9IChzZWxlY3Rvcjogc3RyaW5nLCBydWxlczogc3RyaW5nLCBpZD86IHN0cmluZykgPT4ge1xuICB2YXIgc3R5bGVFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7XG5cbiAgaWYgKGlkKSB7XG4gICAgY29uc3QgZXhpc3RpbmdFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpO1xuICAgIGlmIChleGlzdGluZ0VsZW1lbnQpIHtcbiAgICAgIGV4aXN0aW5nRWxlbWVudC5yZW1vdmUoKTtcbiAgICB9XG5cbiAgICBzdHlsZUVsLmlkID0gaWQ7XG4gIH1cblxuICAvLyBBcHBlbmQgPHN0eWxlPiBlbGVtZW50IHRvIDxoZWFkPlxuICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlRWwpO1xuXG4gIHZhciBzdHlsZVNoZWV0OiBhbnkgPSBzdHlsZUVsLnNoZWV0O1xuXG4gIGlmIChzdHlsZVNoZWV0Lmluc2VydFJ1bGUpIHtcbiAgICAvLyBBbGwgYnJvd3NlcnMsIGV4Y2VwdCBJRSBiZWZvcmUgdmVyc2lvbiA5XG4gICAgc3R5bGVTaGVldC5pbnNlcnRSdWxlKFxuICAgICAgc2VsZWN0b3IgKyAneycgKyBydWxlcyArICd9JyxcbiAgICAgIHN0eWxlU2hlZXQuY3NzUnVsZXMubGVuZ3RoLFxuICAgICk7XG4gIH0gZWxzZSBpZiAoc3R5bGVTaGVldC5hZGRSdWxlKSB7XG4gICAgLy8gSUUgYmVmb3JlIHZlcnNpb24gOVxuICAgIHN0eWxlU2hlZXQuYWRkUnVsZShzZWxlY3RvciwgcnVsZXMsIHN0eWxlU2hlZXQucnVsZXMubGVuZ3RoKTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGFwcGx5Q2hhbmdlSXRlbVRvRG9jdW1lbnQgPSAoXG4gIHBhcmVudFBvcnQ6IE1lc3NhZ2VQb3J0LFxuICBzdG9yeWJvYXJkSWQ6IHN0cmluZyxcbiAgcGxhaW5DaGFuZ2VJdGVtOiBBbnlDaGFuZ2VMZWRnZXJJdGVtLFxuKTogeyBzZW5kTmV3TmF2VHJlZTogYm9vbGVhbjsgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWw6IGJvb2xlYW4gfSA9PiB7XG4gIGlmICghcGxhaW5DaGFuZ2VJdGVtIHx8ICFwbGFpbkNoYW5nZUl0ZW0udHlwZSkge1xuICAgIHJldHVybiB7IHNlbmROZXdOYXZUcmVlOiBmYWxzZSwgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWw6IGZhbHNlIH07XG4gIH1cblxuICBjb25zdCBjaGFuZ2VJdGVtID0gcmVjb25zdHJ1Y3RDaGFuZ2VMZWRnZXJDbGFzcyhcbiAgICBwbGFpbkNoYW5nZUl0ZW0sXG4gICkgYXMgQW55Q2hhbmdlTGVkZ2VySXRlbTtcblxuICBsZXQgZXh0cmFJbnN0YW50VXBkYXRlRGF0YTogYW55ID0ge307XG4gIGxldCBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCA9IGZhbHNlO1xuXG4gIC8vIFRoZSBkaXNwbGF5OiBub25lIHJ1bGUgaXMgbmVlZGVkIGZvciBhIGxvdCBvZiBpbnN0YW50IHVwZGF0ZXMsIHNvIGNyZWF0ZSBpdCBpZiBpdCBkb2Vzbid0IGV4aXN0XG4gIGlmICghZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoVEVNUE9fRElTUExBWV9OT05FX1VOVElMX1JFRlJFU0hfQ0xBU1MpKSB7XG4gICAgYWRkQ2xhc3NDc3NSdWxlKFxuICAgICAgVEVNUE9fRElTUExBWV9OT05FX1VOVElMX1JFRlJFU0hfQ0xBU1MsXG4gICAgICAnZGlzcGxheTogbm9uZSAhaW1wb3J0YW50JyxcbiAgICAgIFRFTVBPX0RJU1BMQVlfTk9ORV9VTlRJTF9SRUZSRVNIX0NMQVNTLFxuICAgICk7XG4gIH1cblxuICBsZXQgc2VuZE5ld05hdlRyZWUgPSBmYWxzZTtcbiAgaWYgKGNoYW5nZUl0ZW0udHlwZSA9PT0gQ2hhbmdlVHlwZS5BRERfSlNYKSB7XG4gICAgY29uc3QgY2FzdENoYW5nZUl0ZW0gPSBjaGFuZ2VJdGVtIGFzIEFkZEpzeENoYW5nZTtcbiAgICBjb25zdCBjaGFuZ2VGaWVsZHMgPSBjYXN0Q2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHM7XG5cbiAgICBjb25zdCBuZXdBZGRlZElkcyA9IFtdO1xuXG4gICAgaWYgKGNoYW5nZUZpZWxkcy5odG1sRm9ySW5zdGFudFVwZGF0ZSkge1xuICAgICAgY29uc3QgZWxlbWVudFRvQWRkID0gJChjaGFuZ2VGaWVsZHMuaHRtbEZvckluc3RhbnRVcGRhdGUpO1xuICAgICAgZWxlbWVudFRvQWRkLmF0dHIoVEVNUE9fREVMRVRFX0FGVEVSX1JFRlJFU0gsICd0cnVlJyk7XG4gICAgICBlbGVtZW50VG9BZGQuYXR0cihURU1QT19JTlNUQU5UX1VQREFURSwgJ3RydWUnKTsgLy8gU28gdGhhdCB0aGUgRE9NIHRyZWUgcmVmcmVzaCBkb2Vzbid0IGdldCB0cmlnZ2VyZWRcbiAgICAgIGVsZW1lbnRUb0FkZC5hdHRyKFRFTVBPX09VVExJTkVfVU5USUxfUkVGRVNILCAndHJ1ZScpO1xuXG4gICAgICBjb25zdCBJRF9GT1JfRUxFTUVOVCA9IGAke0FERF9KU1hfUFJFRklYfSR7dXVpZHY0KCl9YDtcbiAgICAgIGVsZW1lbnRUb0FkZC5hdHRyKFRFTVBPX0VMRU1FTlRfSUQsIElEX0ZPUl9FTEVNRU5UKTtcbiAgICAgIGVsZW1lbnRUb0FkZC5hZGRDbGFzcyhJRF9GT1JfRUxFTUVOVCk7XG5cbiAgICAgIG5ld0FkZGVkSWRzLnB1c2goSURfRk9SX0VMRU1FTlQpO1xuXG4gICAgICAkKGAuJHtjaGFuZ2VGaWVsZHMuY29kZWJhc2VJZFRvQWRkVG99YCkuZWFjaCgoaW5kZXg6IGFueSwgaXRlbSkgPT4ge1xuICAgICAgICBpZiAoY2hhbmdlRmllbGRzLmFmdGVyQ29kZWJhc2VJZCkge1xuICAgICAgICAgIGNvbnN0IGFmdGVyRWxlbWVudCA9ICQoYC4ke2NoYW5nZUZpZWxkcy5hZnRlckNvZGViYXNlSWR9YCk7XG4gICAgICAgICAgaWYgKCFhZnRlckVsZW1lbnQ/Lmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGVsZW1lbnRUb0FkZC5pbnNlcnRBZnRlcihhZnRlckVsZW1lbnQuZmlyc3QoKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoY2hhbmdlRmllbGRzLmJlZm9yZUNvZGViYXNlSWQpIHtcbiAgICAgICAgICBjb25zdCBiZWZvcmVFbGVtZW50ID0gJChgLiR7Y2hhbmdlRmllbGRzLmJlZm9yZUNvZGViYXNlSWR9YCk7XG4gICAgICAgICAgaWYgKCFiZWZvcmVFbGVtZW50Py5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxlbWVudFRvQWRkLmluc2VydEJlZm9yZShiZWZvcmVFbGVtZW50LmZpcnN0KCkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICQoaXRlbSkuYXBwZW5kKGVsZW1lbnRUb0FkZCk7XG4gICAgICAgIH1cblxuICAgICAgICBzZW5kTmV3TmF2VHJlZSA9IHRydWU7XG4gICAgICAgIGluc3RhbnRVcGRhdGVTdWNjZXNzZnVsID0gdHJ1ZTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGV4dHJhSW5zdGFudFVwZGF0ZURhdGFbJ25ld0FkZGVkSWRzJ10gPSBuZXdBZGRlZElkcztcbiAgfSBlbHNlIGlmIChjaGFuZ2VJdGVtLnR5cGUgPT09IENoYW5nZVR5cGUuTU9WRV9KU1gpIHtcbiAgICBjb25zdCBjYXN0Q2hhbmdlSXRlbTogTW92ZUpzeENoYW5nZSA9IGNoYW5nZUl0ZW0gYXMgTW92ZUpzeENoYW5nZTtcblxuICAgIC8vIEZpbmQgZWFjaCBlbGVtZW50IHRoYXQgbWF0Y2hlcyB0aGUganN4Q29kZWJhc2VJZFxuICAgIGNvbnN0IHNvdXJjZUVsZW1lbnRzOiBKUXVlcnk8YW55PltdID0gW107XG5cbiAgICAvLyBTZWUgaWYgZGlyZWN0IG1hdGNoZXMgd29yayBmaXJzdFxuICAgIGlmICgkKGAuJHtjYXN0Q2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMuY29kZWJhc2VJZFRvTW92ZX1gKS5sZW5ndGggPiAwKSB7XG4gICAgICAkKGAuJHtjYXN0Q2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMuY29kZWJhc2VJZFRvTW92ZX1gKS5lYWNoKFxuICAgICAgICAoaW5kZXg6IGFueSwgZWxlbWVudDogYW55KSA9PiB7XG4gICAgICAgICAgc291cmNlRWxlbWVudHMucHVzaCgkKGVsZW1lbnQpKTtcbiAgICAgICAgfSxcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFRyeSB0byBmaW5kIGl0IGJ5IHRoZSBjb21wb25lbnQgSURcbiAgICAgIGxldCB0b3BMZXZlbENvZGViYXNlSWQgPSBnZXRUb3BMZXZlbENvZGViYXNlSWRGb3JDb21wb25lbnQoXG4gICAgICAgIGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5jb2RlYmFzZUlkVG9Nb3ZlIHx8ICcnLFxuICAgICAgKTtcblxuICAgICAgaWYgKHRvcExldmVsQ29kZWJhc2VJZCkge1xuICAgICAgICAkKGAuJHt0b3BMZXZlbENvZGViYXNlSWR9YCkuZWFjaCgoaW5kZXg6IGFueSwgZWxlbWVudDogYW55KSA9PiB7XG4gICAgICAgICAgc291cmNlRWxlbWVudHMucHVzaCgkKGVsZW1lbnQpKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gSWYgdGhlIGNvbnRhaW5lciBpcyBhIGNvbXBvbmVudCwgZHJvcCBpbnRvIHRoZSBjb2RlYmFzZUlkIG9mIHRoZSB0b3AtbW9zdCBjaGlsZCBkaXZcbiAgICBsZXQgY29udGFpbmVyQ29kZWJhc2VJZCA9XG4gICAgICBnZXRUb3BMZXZlbENvZGViYXNlSWRGb3JDb21wb25lbnQoXG4gICAgICAgIGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5jb2RlYmFzZUlkVG9Nb3ZlVG8gfHwgJycsXG4gICAgICApIHx8IGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5jb2RlYmFzZUlkVG9Nb3ZlVG87XG5cbiAgICAvLyBGb3IgZWFjaCBzb3VyY2UgZWxlbWVudCwgZmluZCB0aGUgbmV3IG1hdGNoaW5nIHBhcmVudCBlbGVtZW50XG4gICAgY29uc3QgbmV3UGFyZW50RWxlbWVudHM6IGFueVtdID0gW107XG4gICAgc291cmNlRWxlbWVudHMuZm9yRWFjaCgoZWxlbWVudCkgPT4ge1xuICAgICAgbGV0IG5ld1BhcmVudEVsZW1lbnQgPSBudWxsO1xuXG4gICAgICAvLyBGb3IgZWFjaCBwYXJlbnQsIHRyeSB0byBzZWUgaWYgaXQgZWl0aGVyIG1hdGNoZXMgb3IgY29udGFpbnMgdGhlIG5ldyBwYXJlbnRcbiAgICAgIGxldCBwYXJlbnRFbGVtZW50ID0gZWxlbWVudC5wYXJlbnQoKTtcbiAgICAgIHdoaWxlIChwYXJlbnRFbGVtZW50Lmxlbmd0aCkge1xuICAgICAgICAvLyBJZiB0aGUgcGFyZW50IGRpcmVjdGx5IG1hdGNoZXMsIHRoaXMgaXMgaXRcbiAgICAgICAgaWYgKHBhcmVudEVsZW1lbnQuaGFzQ2xhc3MoY29udGFpbmVyQ29kZWJhc2VJZCkpIHtcbiAgICAgICAgICBuZXdQYXJlbnRFbGVtZW50ID0gcGFyZW50RWxlbWVudDtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIGNoaWxkcmVuIHRoYXQgbWF0Y2ggdGhlIGNvZGViYXNlIElEIHRvIGRyb3AgaW50b1xuICAgICAgICBjb25zdCBtYXRjaGluZ0NoaWxkcmVuID0gcGFyZW50RWxlbWVudC5maW5kKGAuJHtjb250YWluZXJDb2RlYmFzZUlkfWApO1xuICAgICAgICBpZiAobWF0Y2hpbmdDaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgICAgICAvLyBUT0RPOiBXaGF0IGlmIHRoaXMgbWF0Y2hlcyBtb3JlIHRoYW4gb25lP1xuICAgICAgICAgIG5ld1BhcmVudEVsZW1lbnQgPSBtYXRjaGluZ0NoaWxkcmVuLmZpcnN0KCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBwYXJlbnRFbGVtZW50ID0gcGFyZW50RWxlbWVudC5wYXJlbnQoKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFuZXdQYXJlbnRFbGVtZW50KSB7XG4gICAgICAgIG5ld1BhcmVudEVsZW1lbnRzLnB1c2gobnVsbCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgbmV3UGFyZW50RWxlbWVudHMucHVzaChuZXdQYXJlbnRFbGVtZW50KTtcbiAgICB9KTtcblxuICAgIC8vIEZvciBlYWNoIGNoaWxkL3BhcmVudEVsZW1lbnQgcGFpciwgbW92ZSB0aGUgY2hpbGQgdG8gdGhlIG5ldyBwYXJlbnRcbiAgICBzb3VyY2VFbGVtZW50cy5mb3JFYWNoKChlbGVtZW50LCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICBjb25zdCBuZXdQYXJlbnRFbGVtZW50ID0gbmV3UGFyZW50RWxlbWVudHNbaW5kZXhdO1xuXG4gICAgICBpZiAoIW5ld1BhcmVudEVsZW1lbnQubGVuZ3RoKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdDb3VsZCBub3QgZmluZCBuZXcgcGFyZW50IGVsZW1lbnQgZm9yIGluc3RhbnQgdXBkYXRlJyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgc2VuZE5ld05hdlRyZWUgPSB0cnVlO1xuICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuXG4gICAgICBlbGVtZW50LmF0dHIoVEVNUE9fSU5TVEFOVF9VUERBVEUsICd0cnVlJyk7XG5cbiAgICAgIC8vIElmIHRoZSBwYXJlbnQgaGFzbid0IGNoYW5nZWQsIGp1c3QgbW92ZSBpdCwgb3RoZXJ3aXNlIGNsb25lIGl0IGFuZCBjcmVhdGUgYSBuZXcgb25lIGluIHRoZSBuZXcgc3BvdFxuICAgICAgbGV0IHVzZUNsb25lID0gIW5ld1BhcmVudEVsZW1lbnQuaXMoZWxlbWVudC5wYXJlbnQoKSk7XG5cbiAgICAgIC8vIFNvIHRoYXQgbmV4dGpzIGhvdCByZWxvYWRpbmcgd29ya3MsIHNpbXBseSBoaWRlIHRoZSBlbGVtZW50IGFuZCBjbG9uZSBpdCBpbnRvIHRoZSBuZXcgc3BvdFxuICAgICAgbGV0IGNsb25lRWxlbWVudDtcbiAgICAgIGlmICh1c2VDbG9uZSkge1xuICAgICAgICBjbG9uZUVsZW1lbnQgPSBlbGVtZW50LmNsb25lKCk7XG4gICAgICAgIGNsb25lRWxlbWVudC5hdHRyKFRFTVBPX0RFTEVURV9BRlRFUl9SRUZSRVNILCAndHJ1ZScpO1xuXG4gICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoVEVNUE9fRElTUExBWV9OT05FX1VOVElMX1JFRlJFU0hfQ0xBU1MpO1xuICAgICAgICBlbGVtZW50LmF0dHIoVEVNUE9fRE9fTk9UX1NIT1dfSU5fTkFWX1VOVElMX1JFRlJFU0gsICd0cnVlJyk7XG4gICAgICB9XG5cbiAgICAgIGlmIChjYXN0Q2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMuYWZ0ZXJDb2RlYmFzZUlkKSB7XG4gICAgICAgIGNvbnN0IGFmdGVySWRUb1VzZSA9XG4gICAgICAgICAgZ2V0VG9wTGV2ZWxDb2RlYmFzZUlkRm9yQ29tcG9uZW50KFxuICAgICAgICAgICAgY2FzdENoYW5nZUl0ZW0uY2hhbmdlRmllbGRzLmFmdGVyQ29kZWJhc2VJZCxcbiAgICAgICAgICApIHx8IGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5hZnRlckNvZGViYXNlSWQ7XG4gICAgICAgIGNvbnN0IGFmdGVyRWxlbWVudCA9IG5ld1BhcmVudEVsZW1lbnQuY2hpbGRyZW4oYC4ke2FmdGVySWRUb1VzZX1gKTtcbiAgICAgICAgaWYgKGFmdGVyRWxlbWVudC5sZW5ndGgpIHtcbiAgICAgICAgICBpZiAodXNlQ2xvbmUgJiYgY2xvbmVFbGVtZW50KSB7XG4gICAgICAgICAgICBjbG9uZUVsZW1lbnQuaW5zZXJ0QWZ0ZXIoYWZ0ZXJFbGVtZW50LmZpcnN0KCkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBlbGVtZW50Lmluc2VydEFmdGVyKGFmdGVyRWxlbWVudC5maXJzdCgpKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5iZWZvcmVDb2RlYmFzZUlkKSB7XG4gICAgICAgIGNvbnN0IGJlZm9yZUlkVG9Vc2UgPVxuICAgICAgICAgIGdldFRvcExldmVsQ29kZWJhc2VJZEZvckNvbXBvbmVudChcbiAgICAgICAgICAgIGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5iZWZvcmVDb2RlYmFzZUlkLFxuICAgICAgICAgICkgfHwgY2FzdENoYW5nZUl0ZW0uY2hhbmdlRmllbGRzLmJlZm9yZUNvZGViYXNlSWQ7XG4gICAgICAgIGNvbnN0IGJlZm9yZUVsZW1lbnQgPSBuZXdQYXJlbnRFbGVtZW50LmNoaWxkcmVuKGAuJHtiZWZvcmVJZFRvVXNlfWApO1xuICAgICAgICBpZiAoYmVmb3JlRWxlbWVudC5sZW5ndGgpIHtcbiAgICAgICAgICBpZiAodXNlQ2xvbmUgJiYgY2xvbmVFbGVtZW50KSB7XG4gICAgICAgICAgICBjbG9uZUVsZW1lbnQuaW5zZXJ0QmVmb3JlKGJlZm9yZUVsZW1lbnQuZmlyc3QoKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKGJlZm9yZUVsZW1lbnQuZmlyc3QoKSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAodXNlQ2xvbmUgJiYgY2xvbmVFbGVtZW50KSB7XG4gICAgICAgIGNsb25lRWxlbWVudC5hcHBlbmRUbyhuZXdQYXJlbnRFbGVtZW50KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGVsZW1lbnQuYXBwZW5kVG8obmV3UGFyZW50RWxlbWVudCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0gZWxzZSBpZiAoY2hhbmdlSXRlbS50eXBlID09PSBDaGFuZ2VUeXBlLlJFTU9WRV9KU1gpIHtcbiAgICBjb25zdCBjYXN0Q2hhbmdlSXRlbTogUmVtb3ZlSnN4Q2hhbmdlID0gY2hhbmdlSXRlbSBhcyBSZW1vdmVKc3hDaGFuZ2U7XG5cbiAgICBjb25zdCBwYXJlbnRUb0VsZW1lbnRLZXlzUmVtb3ZlZDogYW55ID0ge307XG5cbiAgICBjYXN0Q2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMuY29kZWJhc2VJZHNUb1JlbW92ZS5mb3JFYWNoKFxuICAgICAgKGNvZGViYXNlSWQ6IHN0cmluZykgPT4ge1xuICAgICAgICAvLyBTZWUgaWYgZGlyZWN0IG1hdGNoZXMgd29yayBmaXJzdFxuICAgICAgICBsZXQgY29kZWJhc2VJZFRvUmVtb3ZlO1xuICAgICAgICBpZiAoJChgLiR7Y29kZWJhc2VJZH1gKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgY29kZWJhc2VJZFRvUmVtb3ZlID0gY29kZWJhc2VJZDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBUcnkgdG8gZmluZCBpdCBieSB0aGUgY29tcG9uZW50IElEXG4gICAgICAgICAgbGV0IHRvcExldmVsQ29kZWJhc2VJZCA9IGdldFRvcExldmVsQ29kZWJhc2VJZEZvckNvbXBvbmVudChcbiAgICAgICAgICAgIGNvZGViYXNlSWQgfHwgJycsXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIGlmICghdG9wTGV2ZWxDb2RlYmFzZUlkKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnQ291bGQgbm90IGZpbmQgY29tcG9uZW50IGVsZW1lbnQgZm9yIGluc3RhbnQgdXBkYXRlJyk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29kZWJhc2VJZFRvUmVtb3ZlID0gdG9wTGV2ZWxDb2RlYmFzZUlkO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gRm9yIGVhY2ggaXRlbSB0aGF0IGlzIHJlbW92ZWQsIHNhdmUgdGhlIGlubmVyIEhUTUwgaW4gY2FzZSBpdCBnZXRzIGRlbGV0ZWQgYW5kIHdlIHdhbnQgdG8gdW5kb1xuICAgICAgICAkKGAuJHtjb2RlYmFzZUlkVG9SZW1vdmV9YCkuZWFjaCgoaW5kZXg6IGFueSwgaXRlbSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGVsZW1lbnRLZXlSZW1vdmVkID0gZ2V0RWxlbWVudEtleUZyb21Ob2RlKGl0ZW0pO1xuICAgICAgICAgIGNvbnN0IHBhcmVudEVsZW1lbnRLZXkgPSBnZXRFbGVtZW50S2V5RnJvbU5vZGUoaXRlbS5wYXJlbnRFbGVtZW50KTtcblxuICAgICAgICAgIGlmIChlbGVtZW50S2V5UmVtb3ZlZCAmJiBwYXJlbnRFbGVtZW50S2V5KSB7XG4gICAgICAgICAgICBpZiAoIXBhcmVudFRvRWxlbWVudEtleXNSZW1vdmVkW3BhcmVudEVsZW1lbnRLZXldKSB7XG4gICAgICAgICAgICAgIHBhcmVudFRvRWxlbWVudEtleXNSZW1vdmVkW3BhcmVudEVsZW1lbnRLZXldID0gW107XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHBhcmVudFRvRWxlbWVudEtleXNSZW1vdmVkW3BhcmVudEVsZW1lbnRLZXldLnB1c2goe1xuICAgICAgICAgICAgICBvdXRlckhUTUw6IGl0ZW0ub3V0ZXJIVE1MLFxuICAgICAgICAgICAgICBlbGVtZW50S2V5UmVtb3ZlZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGl0ZW0uY2xhc3NMaXN0LmFkZChURU1QT19ESVNQTEFZX05PTkVfVU5USUxfUkVGUkVTSF9DTEFTUyk7XG4gICAgICAgICAgaXRlbS5zZXRBdHRyaWJ1dGUoVEVNUE9fRE9fTk9UX1NIT1dfSU5fTkFWX1VOVElMX1JFRlJFU0gsICd0cnVlJyk7XG5cbiAgICAgICAgICBzZW5kTmV3TmF2VHJlZSA9IHRydWU7XG4gICAgICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGV4dHJhSW5zdGFudFVwZGF0ZURhdGEucGFyZW50VG9FbGVtZW50S2V5c1JlbW92ZWQgPVxuICAgICAgcGFyZW50VG9FbGVtZW50S2V5c1JlbW92ZWQ7XG4gIH0gZWxzZSBpZiAoXG4gICAgY2hhbmdlSXRlbS50eXBlID09PSBDaGFuZ2VUeXBlLkFERF9DTEFTUyB8fFxuICAgIGNoYW5nZUl0ZW0udHlwZSA9PT0gQ2hhbmdlVHlwZS5TVFlMSU5HXG4gICkge1xuICAgIGxldCBjbGFzc05hbWUsXG4gICAgICBjc3NFcXVpdmFsZW50LFxuICAgICAgY29kZWJhc2VJZFRvQWRkQ2xhc3MsXG4gICAgICB0ZW1wb3JhcnlDbGFzcyxcbiAgICAgIGNvZGViYXNlQ2xhc3NOYW1lLFxuICAgICAgbW9kaWZpZXJzO1xuXG4gICAgaWYgKGNoYW5nZUl0ZW0udHlwZSA9PT0gQ2hhbmdlVHlwZS5BRERfQ0xBU1MpIHtcbiAgICAgIGNvbnN0IGNhc3RDaGFuZ2VJdGVtOiBBZGRDbGFzc0NoYW5nZSA9IGNoYW5nZUl0ZW0gYXMgQWRkQ2xhc3NDaGFuZ2U7XG4gICAgICBjb2RlYmFzZUNsYXNzTmFtZSA9IGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5jbGFzc05hbWU7XG4gICAgICBjbGFzc05hbWUgPSBjYXN0Q2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMuY2xhc3NOYW1lO1xuICAgICAgY3NzRXF1aXZhbGVudCA9IGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy5jc3NFcXVpdmFsZW50O1xuICAgICAgY29kZWJhc2VJZFRvQWRkQ2xhc3MgPSBjYXN0Q2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMuY29kZWJhc2VJZFRvQWRkQ2xhc3M7XG4gICAgICB0ZW1wb3JhcnlDbGFzcyA9IGNhc3RDaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcy50ZW1wb3JhcnlPbmx5O1xuICAgICAgbW9kaWZpZXJzID0gY2FzdENoYW5nZUl0ZW0uY2hhbmdlRmllbGRzLm1vZGlmaWVycztcbiAgICAgIGlmICh0ZW1wb3JhcnlDbGFzcykge1xuICAgICAgICBjbGFzc05hbWUgPSBURU1QT1JBUllfU1RZTElOR19DTEFTU19OQU1FO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBBcyBvZiBNYXJjaCA2LCAyMDI0IHdlIG9ubHkgc3VwcG9ydCB0YWlsd2luZCBTVFlMSU5HIGNoYW5nZXMsIHNvIHRyZWF0IHRoZW0gYXMgYWRkaW5nIGEgY2xhc3NcbiAgICAgIGNvbnN0IGNhc3RDaGFuZ2VJdGVtOiBTdHlsaW5nQ2hhbmdlRmllbGRzID1cbiAgICAgICAgY2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMgYXMgU3R5bGluZ0NoYW5nZUZpZWxkcztcbiAgICAgIGNsYXNzTmFtZSA9ICcnO1xuICAgICAgY3NzRXF1aXZhbGVudCA9IE9iamVjdC5rZXlzKGNhc3RDaGFuZ2VJdGVtLnN0eWxpbmdDaGFuZ2VzKVxuICAgICAgICAubWFwKChrZXkpID0+IHtcbiAgICAgICAgICBpZiAoY2FzdENoYW5nZUl0ZW0uc3R5bGluZ0NoYW5nZXNba2V5XSA9PT0gREVMRVRFX1NUWUxFX0NPTlNUQU5UKSB7XG4gICAgICAgICAgICByZXR1cm4gYCR7Y2FtZWxUb1NuYWtlQ2FzZShrZXkpfTogdW5zZXQgIWltcG9ydGFudDtgO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBgJHtjYW1lbFRvU25ha2VDYXNlKGtleSl9OiAke1xuICAgICAgICAgICAgY2FzdENoYW5nZUl0ZW0uc3R5bGluZ0NoYW5nZXNba2V5XVxuICAgICAgICAgIH07YDtcbiAgICAgICAgfSlcbiAgICAgICAgLmpvaW4oJycpO1xuICAgICAgY29kZWJhc2VJZFRvQWRkQ2xhc3MgPSBjYXN0Q2hhbmdlSXRlbS5jb2RlYmFzZUlkO1xuICAgICAgbW9kaWZpZXJzID0gY2FzdENoYW5nZUl0ZW0ubW9kaWZpZXJzO1xuICAgIH1cbiAgICBjb25zdCBTQUZFX0NMQVNTTkFNRV9SRUdFWCA9IC9bXkEtWmEtejAtOV8tXS9nO1xuXG4gICAgLy8gRXNjYXBlIGFueSBjdXN0b20gY2xhc3Nlc1xuICAgIGxldCBjbGFzc1RvQWRkID0gKGNsYXNzTmFtZSB8fCAnJylcbiAgICAgIC5yZXBsYWNlKFNBRkVfQ0xBU1NOQU1FX1JFR0VYLCAnLScpIC8vIFJlcGxhY2UgYW55IG5vbi1hbHBoYW51bWVyaWMgY2hhcmFjdGVycyB3aXRoICctJ1xuICAgICAgLnJlcGxhY2UoL15cXGQvLCAnLSQmJyk7IC8vIElmIHRoZSBjbGFzcyBzdGFydHMgd2l0aCBhIGRpZ2l0LCBwcmVwZW5kIHdpdGggJy0nXG5cbiAgICAvLyBJbnN0ZWFkIG9mIGFkZGluZyB0aGUgY2xhc3MgbmFtZSwgZ2VuZXJhdGUgYSBuZXcgY2xhc3MgYW5kIHNldCB0aGVcbiAgICAvLyBjc3MgZXF1aXZhbGVudCB2YWx1ZXMgaW5zaWRlIGl0XG4gICAgLy8gVGhpcyBjbGFzcyB3aWxsIGJlIGRlbGV0ZWQgYWZ0ZXIgYSBob3QgcmVsb2FkXG4gICAgLy8gTm90ZSAtIGZvciB0ZW1wb3JhcnkgY2xhc3NlcyB3ZSB3YW50IHRvIGV4cGxpY2l0bHkgdXNlIHRoZSBzYW1lIGNsYXNzXG4gICAgaWYgKGNzc0VxdWl2YWxlbnQgJiYgIXRlbXBvcmFyeUNsYXNzKSB7XG4gICAgICBjb25zdCBtc1NpbmNlSmFuMSA9IERhdGUubm93KCkgLSAxNzA0MDY3MjAwMDAwO1xuICAgICAgY2xhc3NUb0FkZCA9IGAke1RFTVBPX0lOU1RBTlRfVVBEQVRFX1NUWUxJTkdfUFJFRklYfSR7bXNTaW5jZUphbjF9LSR7Y2xhc3NUb0FkZH1gO1xuICAgIH1cblxuICAgIGlmIChjbGFzc1RvQWRkKSB7XG4gICAgICBpZiAoIXRlbXBvcmFyeUNsYXNzKSB7XG4gICAgICAgIC8vIENsZWFyIHRoZSB0ZW1wb3JhcnkgY2xhc3Mgb24gdGhpcyBlbGVtZW50IGlmIGl0IGhhcyBpdFxuICAgICAgICAkKGAuJHtjb2RlYmFzZUlkVG9BZGRDbGFzc31gKS5yZW1vdmVDbGFzcyhURU1QT1JBUllfU1RZTElOR19DTEFTU19OQU1FKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGNzc0VxdWl2YWxlbnQpIHtcbiAgICAgICAgaWYgKG1vZGlmaWVycyAmJiBtb2RpZmllcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGNvbnN0IENTU19QU0VVRE9fTU9ESUZJRVJTID0gW1xuICAgICAgICAgICAgJ2hvdmVyJyxcbiAgICAgICAgICAgICdyZXF1aXJlZCcsXG4gICAgICAgICAgICAnZm9jdXMnLFxuICAgICAgICAgICAgJ2FjdGl2ZScsXG4gICAgICAgICAgICAnaW52YWxpZCcsXG4gICAgICAgICAgICAnZGlzYWJsZWQnLFxuICAgICAgICAgIF07XG5cbiAgICAgICAgICBjb25zdCBwc2V1ZG9Nb2RpZmllcnMgPSBtb2RpZmllcnMuZmlsdGVyKChtb2RpZmllcikgPT5cbiAgICAgICAgICAgIENTU19QU0VVRE9fTU9ESUZJRVJTLmluY2x1ZGVzKG1vZGlmaWVyKSxcbiAgICAgICAgICApO1xuICAgICAgICAgIGNvbnN0IHBzZXVkb01vZGlmaWVyc1N1ZmZpeCA9IHBzZXVkb01vZGlmaWVycy5qb2luKCc6Jyk7XG5cbiAgICAgICAgICBpZiAocHNldWRvTW9kaWZpZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IG1vZGlmaWVyQ2xhc3MgPSBgJHtjbGFzc1RvQWRkfToke3BzZXVkb01vZGlmaWVyc1N1ZmZpeH1gO1xuICAgICAgICAgICAgYWRkQ2xhc3NDc3NSdWxlKG1vZGlmaWVyQ2xhc3MsIGNzc0VxdWl2YWxlbnQsIG1vZGlmaWVyQ2xhc3MpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhZGRDbGFzc0Nzc1J1bGUoY2xhc3NUb0FkZCwgY3NzRXF1aXZhbGVudCwgY2xhc3NUb0FkZCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3QgZm9yY2VDbGFzc2VzID0gbW9kaWZpZXJzXG4gICAgICAgICAgICAubWFwKChtb2RpZmllcikgPT4gYC50ZW1wby1mb3JjZS0ke21vZGlmaWVyfWApXG4gICAgICAgICAgICAuam9pbignJyk7XG4gICAgICAgICAgY29uc3QgaW5zdGFudFVwZGF0ZUZvckZvcmNlQ2xhc3MgPSBgJHtjbGFzc1RvQWRkfSR7Zm9yY2VDbGFzc2VzfWA7XG5cbiAgICAgICAgICBhZGRDbGFzc0Nzc1J1bGUoXG4gICAgICAgICAgICBpbnN0YW50VXBkYXRlRm9yRm9yY2VDbGFzcyxcbiAgICAgICAgICAgIGNzc0VxdWl2YWxlbnQsXG4gICAgICAgICAgICBpbnN0YW50VXBkYXRlRm9yRm9yY2VDbGFzcyxcbiAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGFkZENsYXNzQ3NzUnVsZShjbGFzc1RvQWRkLCBjc3NFcXVpdmFsZW50LCBjbGFzc1RvQWRkKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zdCBjdXJyZW50QWRkQ2xhc3NWYWx1ZXMgPVxuICAgICAgICBnZXRNZW1vcnlTdG9yYWdlSXRlbShBRERfQ0xBU1NfSU5TVEFOVF9VUERBVEVfUVVFVUUpIHx8IFtdO1xuXG4gICAgICAvLyBTZWUgaWYgZGlyZWN0IG1hdGNoZXMgd29yayBmaXJzdFxuICAgICAgaWYgKCQoYC4ke2NvZGViYXNlSWRUb0FkZENsYXNzfWApLmxlbmd0aCA+IDApIHtcbiAgICAgICAgJChgLiR7Y29kZWJhc2VJZFRvQWRkQ2xhc3N9YCkuYWRkQ2xhc3MoY2xhc3NUb0FkZCk7XG5cbiAgICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuXG4gICAgICAgIGN1cnJlbnRBZGRDbGFzc1ZhbHVlcy5wdXNoKHtcbiAgICAgICAgICBjb2RlYmFzZUlkOiBjb2RlYmFzZUlkVG9BZGRDbGFzcyxcbiAgICAgICAgICBjbGFzc05hbWU6IGNsYXNzVG9BZGQsXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gVHJ5IHRvIGZpbmQgaXQgYnkgdGhlIGNvbXBvbmVudCBJRFxuICAgICAgICBsZXQgdG9wTGV2ZWxDb2RlYmFzZUlkID0gZ2V0VG9wTGV2ZWxDb2RlYmFzZUlkRm9yQ29tcG9uZW50KFxuICAgICAgICAgIGNvZGViYXNlSWRUb0FkZENsYXNzIHx8ICcnLFxuICAgICAgICApO1xuXG4gICAgICAgIGlmICh0b3BMZXZlbENvZGViYXNlSWQgJiYgJChgLiR7dG9wTGV2ZWxDb2RlYmFzZUlkfWApLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCA9IHRydWU7XG4gICAgICAgICAgJChgLiR7dG9wTGV2ZWxDb2RlYmFzZUlkfWApLmFkZENsYXNzKGNsYXNzVG9BZGQpO1xuXG4gICAgICAgICAgY3VycmVudEFkZENsYXNzVmFsdWVzLnB1c2goe1xuICAgICAgICAgICAgY29kZWJhc2VJZDogdG9wTGV2ZWxDb2RlYmFzZUlkLFxuICAgICAgICAgICAgY2xhc3NOYW1lOiBjbGFzc1RvQWRkLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHNldE1lbW9yeVN0b3JhZ2VJdGVtKFxuICAgICAgICBBRERfQ0xBU1NfSU5TVEFOVF9VUERBVEVfUVVFVUUsXG4gICAgICAgIGN1cnJlbnRBZGRDbGFzc1ZhbHVlcyxcbiAgICAgICk7XG5cbiAgICAgIGV4dHJhSW5zdGFudFVwZGF0ZURhdGEuYWRkZWRDbGFzcyA9IGNsYXNzVG9BZGQ7XG4gICAgICBleHRyYUluc3RhbnRVcGRhdGVEYXRhLmNvZGViYXNlQWRkZWRDbGFzcyA9IGNvZGViYXNlQ2xhc3NOYW1lO1xuICAgIH1cbiAgfSBlbHNlIGlmIChjaGFuZ2VJdGVtLnR5cGUgPT09IENoYW5nZVR5cGUuUkVNT1ZFX0NMQVNTKSB7XG4gICAgY29uc3QgcmVtb3ZlQ2xhc3NDaGFuZ2VGaWVsZHMgPVxuICAgICAgY2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMgYXMgUmVtb3ZlQ2xhc3NDaGFuZ2VGaWVsZHM7XG5cbiAgICAvLyBTZWUgaWYgZGlyZWN0IG1hdGNoZXMgd29yayBmaXJzdFxuICAgIGlmICgkKGAuJHtyZW1vdmVDbGFzc0NoYW5nZUZpZWxkcy5jb2RlYmFzZUlkVG9SZW1vdmVDbGFzc31gKS5sZW5ndGggPiAwKSB7XG4gICAgICAkKGAuJHtyZW1vdmVDbGFzc0NoYW5nZUZpZWxkcy5jb2RlYmFzZUlkVG9SZW1vdmVDbGFzc31gKS5yZW1vdmVDbGFzcyhcbiAgICAgICAgcmVtb3ZlQ2xhc3NDaGFuZ2VGaWVsZHMuY2xhc3NOYW1lLFxuICAgICAgKTtcblxuICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBUcnkgdG8gZmluZCBpdCBieSB0aGUgY29tcG9uZW50IElEXG4gICAgICBsZXQgdG9wTGV2ZWxDb2RlYmFzZUlkID0gZ2V0VG9wTGV2ZWxDb2RlYmFzZUlkRm9yQ29tcG9uZW50KFxuICAgICAgICByZW1vdmVDbGFzc0NoYW5nZUZpZWxkcy5jb2RlYmFzZUlkVG9SZW1vdmVDbGFzcyB8fCAnJyxcbiAgICAgICk7XG5cbiAgICAgIGlmICh0b3BMZXZlbENvZGViYXNlSWQgJiYgJChgLiR7dG9wTGV2ZWxDb2RlYmFzZUlkfWApLmxlbmd0aCA+IDApIHtcbiAgICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgICAgICAkKGAuJHt0b3BMZXZlbENvZGViYXNlSWR9YCkucmVtb3ZlQ2xhc3MoXG4gICAgICAgICAgcmVtb3ZlQ2xhc3NDaGFuZ2VGaWVsZHMuY2xhc3NOYW1lLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIGlmIChjaGFuZ2VJdGVtLnR5cGUgPT09IENoYW5nZVR5cGUuV1JBUF9ESVYpIHtcbiAgICBjb25zdCBjaGFuZ2VGaWVsZHMgPSBjaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcyBhcyBXcmFwRGl2Q2hhbmdlRmllbGRzO1xuICAgIGNvbnN0IGNvZGViYXNlSWRzVG9XcmFwID0gY2hhbmdlRmllbGRzLmNvZGViYXNlSWRzVG9XcmFwO1xuXG4gICAgY29uc3QgZmlyc3RDb2RlYmFzZUlkID0gY29kZWJhc2VJZHNUb1dyYXBbMF07XG5cbiAgICAvLyBXZSBhc3N1bWUgdGhlIG90aGVyIGNvZGViYXNlIElEcyBhcmUgc2libGluZ3Mgb2YgdGhpcyBjb2RlYmFzZSBJRCwgc28gd2VcbiAgICAvLyBmaW5kIGVhY2ggaW5zdGFuY2Ugb2YgdGhlIGZpcnN0IG9uZSBhbmQgaW5jbHVkZSB0aGUgb3RoZXIgaXRlbXMgdGhhdCBtYXRjaCBpbiBpdFxuICAgIC8vIElmIHRoZSBvdGhlciBpdGVtcyBhcmVuJ3QgYWxsIGZvdW5kLCB3ZSBkbyBub3Qgd3JhcCBhbmQgbGV0IGhvdCByZWxvYWQgaGFuZGxlIGl0XG4gICAgJChgLiR7Zmlyc3RDb2RlYmFzZUlkfWApLmVhY2goKGluZGV4OiBhbnksIGl0ZW0pID0+IHtcbiAgICAgIGNvbnN0IG90aGVyQ29kZWJhc2VJZHMgPSBjb2RlYmFzZUlkc1RvV3JhcC5zbGljZSgxKTtcbiAgICAgIC8vIEZvciBlYWNoIGNvZGViYXNlIElEIGluIG90aGVyQ29kZWJhc2VJZHMsIHJldHJpZXZlIHRoZSBlbGVtZW50IHRoYXQgaXMgYSBzaWJsaW5nIG9mIGl0ZW1cbiAgICAgIGNvbnN0IHNpYmxpbmdzID0gJChpdGVtKS5zaWJsaW5ncygpO1xuICAgICAgY29uc3QgYWxsSXRlbXNUb0FkZFRvTmV3RGl2ID0gW2l0ZW1dO1xuXG4gICAgICBsZXQgZWFybGllc3RJdGVtID0gaXRlbTtcbiAgICAgIGxldCBlYXJsaWVzdEluZGV4ID0gJChpdGVtKS5pbmRleCgpO1xuXG4gICAgICBvdGhlckNvZGViYXNlSWRzLmZvckVhY2goKGNvZGViYXNlSWQpID0+IHtcbiAgICAgICAgY29uc3QgZm91bmRTaWJsaW5nID0gc2libGluZ3MuZmlsdGVyKGAuJHtjb2RlYmFzZUlkfWApLmdldCgwKTtcbiAgICAgICAgaWYgKGZvdW5kU2libGluZykge1xuICAgICAgICAgIGFsbEl0ZW1zVG9BZGRUb05ld0Rpdi5wdXNoKGZvdW5kU2libGluZyk7XG4gICAgICAgICAgY29uc3QgaW5kZXggPSAkKGZvdW5kU2libGluZykuaW5kZXgoKTtcbiAgICAgICAgICBpZiAoaW5kZXggPCBlYXJsaWVzdEluZGV4KSB7XG4gICAgICAgICAgICBlYXJsaWVzdEl0ZW0gPSBmb3VuZFNpYmxpbmc7XG4gICAgICAgICAgICBlYXJsaWVzdEluZGV4ID0gaW5kZXg7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgLy8gVE9ETzogV2hhdCB0byBkbyBpZiB0aGV5IGFsbCBjYW4ndCBiZSBmb3VuZD9cbiAgICAgIGlmIChhbGxJdGVtc1RvQWRkVG9OZXdEaXYubGVuZ3RoICE9PSBjb2RlYmFzZUlkc1RvV3JhcC5sZW5ndGgpIHtcbiAgICAgICAgLy8gRm9yIG5vdywganVzdCBhZGQgdGhlIG9uZXMgdGhhdCB3ZXJlIGZvdW5kXG4gICAgICB9XG5cbiAgICAgIC8vIENyZWF0ZSBhIGRpdiB3aXRoIGEgY2xvbmUgb2YgdGhlIGl0ZW0sIHdoaWxlIGhpZGluZyB0aGUgaXRlbVxuICAgICAgLy8gV2hlbiB0aGUgaG90IHJlbG9hZCBoYXBwZW5zIHRoZSBjbG9uZSBnZXRzIGRlbGV0ZWQgYW5kIHRoZSBpdGVtIGlzIHNob3duIGFnYWluXG4gICAgICBjb25zdCBuZXdEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgIG5ld0Rpdi5jbGFzc05hbWUgPSBXUkFQX0lOX0RJVl9QTEFDRUhPTERFUl9DT0RFQkFTRV9JRDtcbiAgICAgIG5ld0Rpdi5zZXRBdHRyaWJ1dGUoVEVNUE9fSU5TVEFOVF9VUERBVEUsICd0cnVlJyk7IC8vIFNvIHRoYXQgdGhlIERPTSB0cmVlIHJlZnJlc2ggZG9lc24ndCBnZXQgdHJpZ2dlcmVkXG4gICAgICBuZXdEaXYuc2V0QXR0cmlidXRlKFxuICAgICAgICAndGVtcG9lbGVtZW50aWQnLFxuICAgICAgICBXUkFQX0lOX0RJVl9QTEFDRUhPTERFUl9DT0RFQkFTRV9JRCxcbiAgICAgICk7XG4gICAgICBuZXdEaXYuc2V0QXR0cmlidXRlKCdkYXRhLXRlc3RpZCcsIFdSQVBfSU5fRElWX1BMQUNFSE9MREVSX0NPREVCQVNFX0lEKTtcbiAgICAgIG5ld0Rpdi5zZXRBdHRyaWJ1dGUoVEVNUE9fREVMRVRFX0FGVEVSX1JFRlJFU0gsICd0cnVlJyk7XG4gICAgICBhbGxJdGVtc1RvQWRkVG9OZXdEaXYuZm9yRWFjaCgoZWxlbSkgPT4ge1xuICAgICAgICBuZXdEaXYuYXBwZW5kQ2hpbGQoZWxlbS5jbG9uZU5vZGUodHJ1ZSkpO1xuXG4gICAgICAgIGVsZW0uY2xhc3NMaXN0LmFkZChURU1QT19ESVNQTEFZX05PTkVfVU5USUxfUkVGUkVTSF9DTEFTUyk7XG4gICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKFRFTVBPX0RPX05PVF9TSE9XX0lOX05BVl9VTlRJTF9SRUZSRVNILCAndHJ1ZScpO1xuICAgICAgfSk7XG5cbiAgICAgIC8vIEluc2VydCB0aGUgbmV3IGRpdiByaWdodCBiZWZvcmUgdGhlIGZpcnN0IGl0ZW1cbiAgICAgIGVhcmxpZXN0SXRlbS5pbnNlcnRBZGphY2VudEVsZW1lbnQoJ2JlZm9yZWJlZ2luJywgbmV3RGl2KTtcblxuICAgICAgc2VuZE5ld05hdlRyZWUgPSB0cnVlO1xuICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgIH0pO1xuICB9IGVsc2UgaWYgKGNoYW5nZUl0ZW0udHlwZSA9PT0gQ2hhbmdlVHlwZS5EVVBMSUNBVEUpIHtcbiAgICBjb25zdCBjaGFuZ2VGaWxlZHMgPSBjaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcyBhcyBEdXBsaWNhdGVDaGFuZ2VGaWVsZHM7XG4gICAgY29uc3QgY29kZWJhc2VJZHNUb0R1cGxpY2F0ZSA9IGNoYW5nZUZpbGVkcy5jb2RlYmFzZUlkc1RvRHVwbGljYXRlO1xuXG4gICAgY29kZWJhc2VJZHNUb0R1cGxpY2F0ZS5mb3JFYWNoKChjb2RlYmFzZUlkVG9EdXBsaWNhdGUpID0+IHtcbiAgICAgICQoYC4ke2NvZGViYXNlSWRUb0R1cGxpY2F0ZX1gKS5lYWNoKChpbmRleDogYW55LCBpdGVtKSA9PiB7XG4gICAgICAgIGNvbnN0IGNsb25lZE5vZGUgPSBpdGVtLmNsb25lTm9kZSh0cnVlKSBhcyBIVE1MRWxlbWVudDtcblxuICAgICAgICBjbG9uZWROb2RlLnNldEF0dHJpYnV0ZShURU1QT19ERUxFVEVfQUZURVJfUkVGUkVTSCwgJ3RydWUnKTtcbiAgICAgICAgY2xvbmVkTm9kZS5zZXRBdHRyaWJ1dGUoVEVNUE9fSU5TVEFOVF9VUERBVEUsICd0cnVlJyk7IC8vIFNvIHRoYXQgdGhlIERPTSB0cmVlIHJlZnJlc2ggZG9lc24ndCBnZXQgdHJpZ2dlcmVkXG5cbiAgICAgICAgLy8gU2V0IHVwIGFsbCB0aGUgY29ycmVjdCBkdXBsaWNhdGVkIGNvZGViYXNlIElEc1xuICAgICAgICBjbG9uZWROb2RlLnNldEF0dHJpYnV0ZShcbiAgICAgICAgICAndGVtcG9lbGVtZW50aWQnLFxuICAgICAgICAgIGAke0RVUExJQ0FURV9QTEFDRUhPTERFUl9QUkVGSVh9JHtjb2RlYmFzZUlkVG9EdXBsaWNhdGV9YCxcbiAgICAgICAgKTtcbiAgICAgICAgY2xvbmVkTm9kZS5zZXRBdHRyaWJ1dGUoXG4gICAgICAgICAgJ2RhdGEtdGVzdGlkJyxcbiAgICAgICAgICBgJHtEVVBMSUNBVEVfUExBQ0VIT0xERVJfUFJFRklYfSR7Y29kZWJhc2VJZFRvRHVwbGljYXRlfWAsXG4gICAgICAgICk7XG4gICAgICAgIGNsb25lZE5vZGUuY2xhc3NMaXN0LmFkZChcbiAgICAgICAgICBEVVBMSUNBVEVfUExBQ0VIT0xERVJfUFJFRklYICsgY29kZWJhc2VJZFRvRHVwbGljYXRlLFxuICAgICAgICApO1xuICAgICAgICBjbG9uZWROb2RlLmNsYXNzTGlzdC5yZW1vdmUoY29kZWJhc2VJZFRvRHVwbGljYXRlKTtcblxuICAgICAgICBsZXQgY2hpbGRyZW4gPSBBcnJheS5mcm9tKGNsb25lZE5vZGUuY2hpbGRyZW4pO1xuICAgICAgICB3aGlsZSAoY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbi5wb3AoKTtcbiAgICAgICAgICBpZiAoIWNoaWxkKSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBjb2RlYmFzZUlkID1cbiAgICAgICAgICAgIGNoaWxkLmdldEF0dHJpYnV0ZSgndGVtcG9lbGVtZW50aWQnKSB8fFxuICAgICAgICAgICAgY2hpbGQuZ2V0QXR0cmlidXRlKCdkYXRhLXRlc3RpZCcpO1xuICAgICAgICAgIGlmICghY29kZWJhc2VJZCkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY2hpbGQuc2V0QXR0cmlidXRlKFxuICAgICAgICAgICAgJ3RlbXBvZWxlbWVudGlkJyxcbiAgICAgICAgICAgIGAke0RVUExJQ0FURV9QTEFDRUhPTERFUl9QUkVGSVh9JHtjb2RlYmFzZUlkfWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjaGlsZC5zZXRBdHRyaWJ1dGUoXG4gICAgICAgICAgICAnZGF0YS10ZXN0aWQnLFxuICAgICAgICAgICAgYCR7RFVQTElDQVRFX1BMQUNFSE9MREVSX1BSRUZJWH0ke2NvZGViYXNlSWR9YCxcbiAgICAgICAgICApO1xuICAgICAgICAgIGNoaWxkLmNsYXNzTGlzdC5yZW1vdmUoY29kZWJhc2VJZCk7XG4gICAgICAgICAgY2hpbGQuY2xhc3NMaXN0LmFkZChEVVBMSUNBVEVfUExBQ0VIT0xERVJfUFJFRklYICsgY29kZWJhc2VJZCk7XG4gICAgICAgICAgY2hpbGQuc2V0QXR0cmlidXRlKFRFTVBPX0lOU1RBTlRfVVBEQVRFLCAndHJ1ZScpO1xuXG4gICAgICAgICAgY2hpbGRyZW4ucHVzaCguLi5BcnJheS5mcm9tKGNoaWxkLmNoaWxkcmVuKSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBZGQgdGhlIGNsb25lcyBub2RlIHJpZ2h0IGFmdGVyIHRoZSBmb3VuZCBub2RlXG4gICAgICAgIGl0ZW0uaW5zZXJ0QWRqYWNlbnRFbGVtZW50KCdhZnRlcmVuZCcsIGNsb25lZE5vZGUpO1xuXG4gICAgICAgIHNlbmROZXdOYXZUcmVlID0gdHJ1ZTtcbiAgICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0gZWxzZSBpZiAoY2hhbmdlSXRlbS50eXBlID09PSBDaGFuZ2VUeXBlLkNIQU5HRV9UQUcpIHtcbiAgICBjb25zdCBjaGFuZ2VGaWVsZHMgPSBjaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcyBhcyBDaGFuZ2VUYWdDaGFuZ2VGaWVsZHM7XG5cbiAgICAkKGAuJHtjaGFuZ2VGaWVsZHMuY29kZWJhc2VJZFRvQ2hhbmdlfWApLmVhY2goKGluZGV4OiBhbnksIGl0ZW0pID0+IHtcbiAgICAgIGNvbnN0ICRuZXdFbGVtZW50ID0gJChcbiAgICAgICAgJzwnICsgY2hhbmdlRmllbGRzLm5ld1RhZ05hbWUgKyAnPjwvJyArIGNoYW5nZUZpZWxkcy5uZXdUYWdOYW1lICsgJz4nLFxuICAgICAgKTtcbiAgICAgICRuZXdFbGVtZW50LmF0dHIoVEVNUE9fSU5TVEFOVF9VUERBVEUsICd0cnVlJyk7IC8vIFNvIHRoYXQgdGhlIERPTSB0cmVlIHJlZnJlc2ggZG9lc24ndCBnZXQgdHJpZ2dlcmVkXG4gICAgICAkbmV3RWxlbWVudC5hdHRyKFRFTVBPX0RFTEVURV9BRlRFUl9SRUZSRVNILCAndHJ1ZScpO1xuXG4gICAgICBjb25zdCAkaXRlbSA9ICQoaXRlbSk7XG5cbiAgICAgIC8vIENvcHkgYWxsIGF0dHJpYnV0ZXMgZnJvbSB0aGUgb3JpZ2luYWwgZWxlbWVudCB0byB0aGUgbmV3IGVsZW1lbnRcbiAgICAgICQuZWFjaCgkaXRlbVswXS5hdHRyaWJ1dGVzLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICRuZXdFbGVtZW50LmF0dHIodGhpcy5uYW1lLCB0aGlzLnZhbHVlKTtcbiAgICAgIH0pO1xuXG4gICAgICAkaXRlbS5jb250ZW50cygpLmNsb25lKHRydWUsIHRydWUpLmFwcGVuZFRvKCRuZXdFbGVtZW50KTtcblxuICAgICAgLy8gQWRkIHJpZ2h0IGJlZm9yZSB0aGUgY2xvbmVkIGl0ZW0gc28gdGhlIHVuaXF1ZSBwYXRoIHN0YXlzIHRoZSBzYW1lXG4gICAgICAkaXRlbS5iZWZvcmUoJG5ld0VsZW1lbnQpO1xuXG4gICAgICAvLyBIaWRlIHRoZSBvcmlnaW5hbCBpdGVtXG4gICAgICAkaXRlbS5hZGRDbGFzcyhURU1QT19ESVNQTEFZX05PTkVfVU5USUxfUkVGUkVTSF9DTEFTUyk7XG4gICAgICAkaXRlbS5hdHRyKFRFTVBPX0RPX05PVF9TSE9XX0lOX05BVl9VTlRJTF9SRUZSRVNILCAndHJ1ZScpO1xuXG4gICAgICBzZW5kTmV3TmF2VHJlZSA9IHRydWU7XG4gICAgICBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCA9IHRydWU7XG4gICAgfSk7XG4gIH0gZWxzZSBpZiAoY2hhbmdlSXRlbS50eXBlID09PSBDaGFuZ2VUeXBlLlVORE8pIHtcbiAgICBjb25zdCB7XG4gICAgICBzZW5kTmV3TmF2VHJlZTogX3NlbmROZXdOYXZUcmVlLFxuICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWw6IF9pbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCxcbiAgICB9ID0gYXBwbHlVbmRvQ2hhbmdlSXRlbVRvRG9jdW1lbnQocGFyZW50UG9ydCwgY2hhbmdlSXRlbSBhcyBVbmRvQ2hhbmdlKTtcblxuICAgIHNlbmROZXdOYXZUcmVlID0gX3NlbmROZXdOYXZUcmVlO1xuICAgIGluc3RhbnRVcGRhdGVTdWNjZXNzZnVsID0gX2luc3RhbnRVcGRhdGVTdWNjZXNzZnVsO1xuICB9IGVsc2UgaWYgKGNoYW5nZUl0ZW0udHlwZSA9PT0gQ2hhbmdlVHlwZS5SRURPKSB7XG4gICAgY29uc3QgY2hhbmdlRmllbGRzID0gY2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMgYXMgUmVkb0NoYW5nZUZpZWxkcztcblxuICAgIGNvbnN0IGNoYW5nZVRvUmVkbyA9IGNoYW5nZUZpZWxkcy5jaGFuZ2VUb1JlZG87XG5cbiAgICBpZiAoQ0hBTkdFX1RZUEVTX1dJVEhfSU5TVEFOVF9VTkRPLmluY2x1ZGVzKGNoYW5nZVRvUmVkby50eXBlKSkge1xuICAgICAgY29uc3Qge1xuICAgICAgICBzZW5kTmV3TmF2VHJlZTogX3NlbmROZXdOYXZUcmVlLFxuICAgICAgICBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bDogX2luc3RhbnRVcGRhdGVTdWNjZXNzZnVsLFxuICAgICAgfSA9IGFwcGx5Q2hhbmdlSXRlbVRvRG9jdW1lbnQocGFyZW50UG9ydCwgc3Rvcnlib2FyZElkLCBjaGFuZ2VUb1JlZG8pO1xuXG4gICAgICBzZW5kTmV3TmF2VHJlZSA9IF9zZW5kTmV3TmF2VHJlZTtcbiAgICAgIGluc3RhbnRVcGRhdGVTdWNjZXNzZnVsID0gX2luc3RhbnRVcGRhdGVTdWNjZXNzZnVsO1xuXG4gICAgICBpZiAoY2hhbmdlVG9SZWRvLnByZXZJZFRvTmV3SWRNYXApIHtcbiAgICAgICAgdXBkYXRlQ29kZWJhc2VJZHMocGFyZW50UG9ydCwgY2hhbmdlVG9SZWRvLnByZXZJZFRvTmV3SWRNYXAsIHRydWUpO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIGlmIChjaGFuZ2VJdGVtLnR5cGUgPT09IENoYW5nZVR5cGUuVVBEQVRFX0NMQVNTRVMpIHtcbiAgICBjb25zdCB7XG4gICAgICBjb2RlYmFzZUlkVG9VcGRhdGVDbGFzcyxcbiAgICAgIG5ld0NsYXNzZXMsXG4gICAgICBvbGRDbGFzc2VzLFxuICAgICAgaW52b2x2ZWRDbGFzc2VzLFxuICAgICAgaXNJbnN0YW50Q2hhbmdlT25seSxcbiAgICB9ID0gY2hhbmdlSXRlbS5jaGFuZ2VGaWVsZHMgYXMgVXBkYXRlQ2xhc3Nlc0NoYW5nZUZpZWxkcztcblxuICAgIC8vIFRPRE8obmhhbnRoYWkpOiBTaG91bGQgaGFuZGxlIHRoaXMgYmV0dGVyIGluc3RlYWQgb2YganVzdCByZW1vdmUgYW5kIGFkZFxuICAgIGZvciAoY29uc3Qgb2xkQ2xhc3Mgb2Ygb2xkQ2xhc3Nlcykge1xuICAgICAgJChgLiR7Y29kZWJhc2VJZFRvVXBkYXRlQ2xhc3N9YCkucmVtb3ZlQ2xhc3Mob2xkQ2xhc3MpO1xuICAgIH1cblxuICAgIChcbiAgICAgIGludGVybWVkaWF0ZUNsYXNzZXNGb3JTbGlkZXJJbnN0YW50VXBkYXRlW2NvZGViYXNlSWRUb1VwZGF0ZUNsYXNzXSB8fCBbXVxuICAgICkuZm9yRWFjaCgoY2xhc3NOYW1lKSA9PiB7XG4gICAgICAkKGAuJHtjb2RlYmFzZUlkVG9VcGRhdGVDbGFzc31gKS5yZW1vdmVDbGFzcyhjbGFzc05hbWUpO1xuICAgIH0pO1xuXG4gICAgZm9yIChjb25zdCBuZXdDbGFzcyBvZiBuZXdDbGFzc2VzKSB7XG4gICAgICAkKGAuJHtjb2RlYmFzZUlkVG9VcGRhdGVDbGFzc31gKS5hZGRDbGFzcyhuZXdDbGFzcyk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBpbnZvbHZlZENsYXNzIG9mIGludm9sdmVkQ2xhc3Nlcykge1xuICAgICAgYWRkQ2xhc3NDc3NSdWxlKGludm9sdmVkQ2xhc3MudGFpbHdpbmQsIGludm9sdmVkQ2xhc3MuY3NzKTtcbiAgICB9XG5cbiAgICBpZiAoaXNJbnN0YW50Q2hhbmdlT25seSkge1xuICAgICAgaW50ZXJtZWRpYXRlQ2xhc3Nlc0ZvclNsaWRlckluc3RhbnRVcGRhdGVbY29kZWJhc2VJZFRvVXBkYXRlQ2xhc3NdID0gW107XG4gICAgICBmb3IgKGNvbnN0IGludm9sdmVkQ2xhc3Mgb2YgaW52b2x2ZWRDbGFzc2VzKSB7XG4gICAgICAgIGludGVybWVkaWF0ZUNsYXNzZXNGb3JTbGlkZXJJbnN0YW50VXBkYXRlW2NvZGViYXNlSWRUb1VwZGF0ZUNsYXNzXS5wdXNoKFxuICAgICAgICAgIGludm9sdmVkQ2xhc3MudGFpbHdpbmQsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGludGVybWVkaWF0ZUNsYXNzZXNGb3JTbGlkZXJJbnN0YW50VXBkYXRlW2NvZGViYXNlSWRUb1VwZGF0ZUNsYXNzXSA9IFtdO1xuICAgIH1cbiAgfVxuXG4gIC8vIEltbWVkaWF0ZWx5IHNldCB0aGUgbmV3IHNlbGVjdGVkIGVsZW1lbnQga2V5cyB0byBwcmV2ZW50IGFueSBkZWxheSBpbiB0aGUgb3V0bGluZXMgdXBkYXRpbmdcbiAgbGV0IGVsZW1lbnRLZXlUb1NlbGVjdEFmdGVySW5zdGFudFVwZGF0ZSA9XG4gICAgY2hhbmdlSXRlbS5nZXRFbGVtZW50S2V5VG9TZWxlY3RBZnRlckluc3RhbnRVcGRhdGUoKTtcbiAgbGV0IGVsZW1lbnRLZXlzVG9NdWx0aXNlbGVjdEFmdGVySW5zdGFudFVwZGF0ZSA9XG4gICAgY2hhbmdlSXRlbS5nZXRFbGVtZW50S2V5c1RvTXVsdGlzZWxlY3RBZnRlckluc3RhbnRVcGRhdGUoKTtcblxuICBpZiAoY2hhbmdlSXRlbS50eXBlID09PSBDaGFuZ2VUeXBlLlVORE8pIHtcbiAgICBlbGVtZW50S2V5VG9TZWxlY3RBZnRlckluc3RhbnRVcGRhdGUgPSAoXG4gICAgICBjaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcyBhcyBVbmRvQ2hhbmdlRmllbGRzXG4gICAgKS5jaGFuZ2VUb1VuZG8uZ2V0RWxlbWVudEtleVRvU2VsZWN0QWZ0ZXJVbmRvSW5zdGFudFVwZGF0ZSgpO1xuICAgIGVsZW1lbnRLZXlzVG9NdWx0aXNlbGVjdEFmdGVySW5zdGFudFVwZGF0ZSA9IChcbiAgICAgIGNoYW5nZUl0ZW0uY2hhbmdlRmllbGRzIGFzIFVuZG9DaGFuZ2VGaWVsZHNcbiAgICApLmNoYW5nZVRvVW5kby5nZXRFbGVtZW50S2V5c1RvTXVsdGlzZWxlY3RBZnRlclVuZG9JbnN0YW50VXBkYXRlKCk7XG4gIH1cblxuICBpZiAoZWxlbWVudEtleVRvU2VsZWN0QWZ0ZXJJbnN0YW50VXBkYXRlICE9PSB1bmRlZmluZWQpIHtcbiAgICBzZXRNZW1vcnlTdG9yYWdlSXRlbShcbiAgICAgIFNFTEVDVEVEX0VMRU1FTlRfS0VZLFxuICAgICAgZWxlbWVudEtleVRvU2VsZWN0QWZ0ZXJJbnN0YW50VXBkYXRlLFxuICAgICk7XG4gICAgcGFyZW50UG9ydC5wb3N0TWVzc2FnZSh7XG4gICAgICBpZDogRklYRURfSUZSQU1FX01FU1NBR0VfSURTLlNFTEVDVEVEX0VMRU1FTlRfS0VZLFxuICAgICAgZWxlbWVudEtleTogZWxlbWVudEtleVRvU2VsZWN0QWZ0ZXJJbnN0YW50VXBkYXRlLFxuICAgICAgb3V0ZXJIVE1MOiAkKFxuICAgICAgICBgLiR7RUxFTUVOVF9LRVlfUFJFRklYfSR7ZWxlbWVudEtleVRvU2VsZWN0QWZ0ZXJJbnN0YW50VXBkYXRlfWAsXG4gICAgICApLmdldCgwKT8ub3V0ZXJIVE1MLFxuICAgIH0pO1xuICB9XG5cbiAgaWYgKGVsZW1lbnRLZXlzVG9NdWx0aXNlbGVjdEFmdGVySW5zdGFudFVwZGF0ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgc2V0TWVtb3J5U3RvcmFnZUl0ZW0oXG4gICAgICBNVUxUSV9TRUxFQ1RFRF9FTEVNRU5UX0tFWVMsXG4gICAgICBlbGVtZW50S2V5c1RvTXVsdGlzZWxlY3RBZnRlckluc3RhbnRVcGRhdGUsXG4gICAgKTtcbiAgICBwYXJlbnRQb3J0LnBvc3RNZXNzYWdlKHtcbiAgICAgIGlkOiBGSVhFRF9JRlJBTUVfTUVTU0FHRV9JRFMuTVVMVElfU0VMRUNURURfRUxFTUVOVF9LRVlTLFxuICAgICAgZWxlbWVudEtleXM6IGVsZW1lbnRLZXlzVG9NdWx0aXNlbGVjdEFmdGVySW5zdGFudFVwZGF0ZSxcbiAgICAgIG91dGVySFRNTHM6IGVsZW1lbnRLZXlzVG9NdWx0aXNlbGVjdEFmdGVySW5zdGFudFVwZGF0ZT8ubWFwKFxuICAgICAgICAoZWxlbWVudEtleSkgPT5cbiAgICAgICAgICAkKGAuJHtFTEVNRU5UX0tFWV9QUkVGSVh9JHtlbGVtZW50S2V5fWApLmdldCgwKT8ub3V0ZXJIVE1MLFxuICAgICAgKSxcbiAgICB9KTtcbiAgfVxuXG4gIGlmIChpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCkge1xuICAgIC8vIERlbGV0ZSBhbnkgZWxlbWVudHMgdGhhdCBuZWVkIHRvIGJlIGRlbGV0ZWQgYWZ0ZXIgaW5zdGFudCB1cGRhdGVzXG4gICAgJChgKlske1RFTVBPX0RFTEVURV9BRlRFUl9JTlNUQU5UX1VQREFURX09dHJ1ZV1gKS5yZW1vdmUoKTtcbiAgfVxuXG4gIHBhcmVudFBvcnQucG9zdE1lc3NhZ2Uoe1xuICAgIGlkOiBGSVhFRF9JRlJBTUVfTUVTU0FHRV9JRFMuSU5TVEFOVF9VUERBVEVfRE9ORSxcbiAgICBjaGFuZ2VJdGVtOiBwbGFpbkNoYW5nZUl0ZW0sXG4gICAgaW5zdGFudFVwZGF0ZURhdGE6IGV4dHJhSW5zdGFudFVwZGF0ZURhdGEsXG4gICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwsXG4gIH0pO1xuXG4gIHJldHVybiB7IHNlbmROZXdOYXZUcmVlLCBpbnN0YW50VXBkYXRlU3VjY2Vzc2Z1bCB9O1xufTtcblxuY29uc3QgYXBwbHlVbmRvQ2hhbmdlSXRlbVRvRG9jdW1lbnQgPSAoXG4gIHBhcmVudFBvcnQ6IGFueSxcbiAgY2hhbmdlSXRlbTogVW5kb0NoYW5nZSxcbik6IHsgc2VuZE5ld05hdlRyZWU6IGJvb2xlYW47IGluc3RhbnRVcGRhdGVTdWNjZXNzZnVsOiBib29sZWFuIH0gPT4ge1xuICBjb25zdCBjaGFuZ2VGaWVsZHMgPSBjaGFuZ2VJdGVtLmNoYW5nZUZpZWxkcztcblxuICBjb25zdCBjaGFuZ2VUb1VuZG8gPSBjaGFuZ2VGaWVsZHMuY2hhbmdlVG9VbmRvO1xuXG4gIGlmICghQ0hBTkdFX1RZUEVTX1dJVEhfSU5TVEFOVF9VTkRPLmluY2x1ZGVzKGNoYW5nZVRvVW5kby50eXBlKSkge1xuICAgIHJldHVybiB7IHNlbmROZXdOYXZUcmVlOiBmYWxzZSwgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWw6IGZhbHNlIH07XG4gIH1cblxuICBsZXQgc2VuZE5ld05hdlRyZWUgPSBmYWxzZTtcbiAgbGV0IGluc3RhbnRVcGRhdGVTdWNjZXNzZnVsID0gZmFsc2U7XG5cbiAgLy8gQVBJIGhhcyBjb21wbGV0ZWQgYW5kIHRoZSBJRHMgaGF2ZSBiZWVuIHVwZGF0ZWQsIHJldmVyc2UgdGhpcyBjaGFuZ2VcbiAgaWYgKGNoYW5nZVRvVW5kby5wcmV2SWRUb05ld0lkTWFwKSB7XG4gICAgY29uc3QgdW5kb0NvZGViYXNlSWRDaGFuZ2VzOiB7XG4gICAgICBbbmV3Q29kZWJhc2VJZDogc3RyaW5nXTogc3RyaW5nO1xuICAgIH0gPSB7fTtcbiAgICBPYmplY3Qua2V5cyhjaGFuZ2VUb1VuZG8ucHJldklkVG9OZXdJZE1hcCkuZm9yRWFjaCgocHJldklkKSA9PiB7XG4gICAgICBjb25zdCBuZXdJZCA9IGNoYW5nZVRvVW5kby5wcmV2SWRUb05ld0lkTWFwW3ByZXZJZF07XG4gICAgICB1bmRvQ29kZWJhc2VJZENoYW5nZXNbbmV3SWRdID0gcHJldklkO1xuICAgIH0pO1xuXG4gICAgLy8gSWYgdW5kb2luZyBkbyBub3QgdXBkYXRlIHRoZSBjb2RlYmFzZSBJRHMgYmFja3dhcmRzIGlmIHRoZXJlIGFyZSBjb2RlYmFzZSBJRHMgdG8gc2V0IGFmdGVyXG4gICAgLy8gdGhlIHVuZG8gaW5zdGFudCB1cGRhdGUgaXMgZG9uZVxuICAgIGNvbnN0IHNlbGVjdGVkRWxlbWVudFNwZWNpZmllZEFmdGVyVW5kbyA9XG4gICAgICBjaGFuZ2VUb1VuZG8uZ2V0RWxlbWVudEtleVRvU2VsZWN0QWZ0ZXJVbmRvSW5zdGFudFVwZGF0ZSgpICE9PSB1bmRlZmluZWQ7XG4gICAgdXBkYXRlQ29kZWJhc2VJZHMoXG4gICAgICBwYXJlbnRQb3J0LFxuICAgICAgdW5kb0NvZGViYXNlSWRDaGFuZ2VzLFxuICAgICAgIXNlbGVjdGVkRWxlbWVudFNwZWNpZmllZEFmdGVyVW5kbyxcbiAgICApO1xuICB9XG5cbiAgLy8gVGhlbiB1bmRvIHRoZSBhY3R1YWwgY2hhbmdlXG4gIGlmIChjaGFuZ2VUb1VuZG8udHlwZSA9PT0gQ2hhbmdlVHlwZS5SRU1PVkVfSlNYKSB7XG4gICAgLy8gUmUtYWRkIHRoZSByZW1vdmVkIEpTWFxuICAgIGNvbnN0IGlubmVyQ2hhbmdlRmllbGRzID1cbiAgICAgIGNoYW5nZVRvVW5kby5jaGFuZ2VGaWVsZHMgYXMgUmVtb3ZlSnN4Q2hhbmdlRmllbGRzO1xuICAgIGNvbnN0IGNvZGViYXNlSWRzVG9SZWFkZCA9IGlubmVyQ2hhbmdlRmllbGRzLmNvZGViYXNlSWRzVG9SZW1vdmU7XG5cbiAgICAvLyBJZiBpdCBoYXMgYmVlbiBmbHVzaGVkLCByZS1jcmVhdGUgdGhlIGh0bWwgZWxlbWVudHMgZnJvbSB0aGUgc2F2ZWQgaW5uZXIgSFRNTFxuICAgIGlmIChjaGFuZ2VGaWVsZHMubWF0Y2hpbmdBY3Rpdml0eUZsdXNoZWQpIHtcbiAgICAgIGNvbnN0IGluc3RhbnRVcGRhdGVEYXRhID0gY2hhbmdlVG9VbmRvLmdldEluc3RhbnRVcGRhdGVEYXRhKCk7XG4gICAgICBjb25zdCBwYXJlbnRUb0VsZW1lbnRLZXlzUmVtb3ZlZDoge1xuICAgICAgICBbcGFyZW50RWxlbWVudEtleTogc3RyaW5nXTogYW55W107XG4gICAgICB9ID0gaW5zdGFudFVwZGF0ZURhdGEucGFyZW50VG9FbGVtZW50S2V5c1JlbW92ZWQgfHwge307XG5cbiAgICAgIE9iamVjdC5lbnRyaWVzKHBhcmVudFRvRWxlbWVudEtleXNSZW1vdmVkKS5mb3JFYWNoKFxuICAgICAgICAoW3BhcmVudEVsZW1lbnRLZXksIGl0ZW1zUmVtb3ZlZF0pID0+IHtcbiAgICAgICAgICAvLyBTb3J0IHRoZSByZW1vdmVkIGVudHJpZXMgaW4gb3JkZXIgb2YgdW5pcXVlIHBhdGhcbiAgICAgICAgICBjb25zdCBzb3J0ZWRJdGVtc1JlbW92ZWQgPSBPYmplY3QudmFsdWVzKGl0ZW1zUmVtb3ZlZCkuc29ydChcbiAgICAgICAgICAgIChhOiBhbnksIGI6IGFueSkgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBhRWxlbWVudEtleSA9IFRlbXBvRWxlbWVudC5mcm9tS2V5KGEuZWxlbWVudEtleVJlbW92ZWQpO1xuICAgICAgICAgICAgICBjb25zdCBiRWxlbWVudEtleSA9IFRlbXBvRWxlbWVudC5mcm9tS2V5KGIuZWxlbWVudEtleVJlbW92ZWQpO1xuICAgICAgICAgICAgICByZXR1cm4gYUVsZW1lbnRLZXkudW5pcXVlUGF0aC5sb2NhbGVDb21wYXJlKFxuICAgICAgICAgICAgICAgIGJFbGVtZW50S2V5LnVuaXF1ZVBhdGgsXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICAvLyBGaW5kIHRoZSBwYXJlbnQgZWxlbWVudFxuICAgICAgICAgIGNvbnN0IHBhcmVudEVsZW1lbnQgPSAkKFxuICAgICAgICAgICAgYC4ke0VMRU1FTlRfS0VZX1BSRUZJWH0ke3BhcmVudEVsZW1lbnRLZXl9YCxcbiAgICAgICAgICApLmdldCgwKTtcbiAgICAgICAgICBpZiAocGFyZW50RWxlbWVudCkge1xuICAgICAgICAgICAgLy8gQWRkIHRoZSByZW1vdmVkIGVsZW1lbnRzIGJhY2sgaW4gb3JkZXJcbiAgICAgICAgICAgIHNvcnRlZEl0ZW1zUmVtb3ZlZC5mb3JFYWNoKChpdGVtOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgeyBlbGVtZW50S2V5UmVtb3ZlZCwgb3V0ZXJIVE1MIH0gPSBpdGVtO1xuXG4gICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSBUZW1wb0VsZW1lbnQuZnJvbUtleShlbGVtZW50S2V5UmVtb3ZlZCk7XG4gICAgICAgICAgICAgIGNvbnN0IGluZGV4SW5QYXJlbnQgPSBOdW1iZXIoZWxlbWVudC51bmlxdWVQYXRoLnNwbGl0KCctJykucG9wKCkpO1xuXG4gICAgICAgICAgICAgIGNvbnN0IG5ld0VsZW1lbnRGcm9tSHRtbCA9ICQob3V0ZXJIVE1MKS5nZXQoMCk7XG5cbiAgICAgICAgICAgICAgLy8gQWRkIHRvIHRoZSBwYXJlbnQgaW4gdGhlIGluZGV4XG4gICAgICAgICAgICAgIGlmIChuZXdFbGVtZW50RnJvbUh0bWwpIHtcbiAgICAgICAgICAgICAgICBuZXdFbGVtZW50RnJvbUh0bWwuc2V0QXR0cmlidXRlKFxuICAgICAgICAgICAgICAgICAgVEVNUE9fREVMRVRFX0FGVEVSX1JFRlJFU0gsXG4gICAgICAgICAgICAgICAgICAndHJ1ZScsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBuZXdFbGVtZW50RnJvbUh0bWwuc2V0QXR0cmlidXRlKFRFTVBPX0lOU1RBTlRfVVBEQVRFLCAndHJ1ZScpO1xuICAgICAgICAgICAgICAgIHBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKFxuICAgICAgICAgICAgICAgICAgbmV3RWxlbWVudEZyb21IdG1sLFxuICAgICAgICAgICAgICAgICAgcGFyZW50RWxlbWVudC5jaGlsZHJlbltpbmRleEluUGFyZW50XSB8fCBudWxsLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHNlbmROZXdOYXZUcmVlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gTm90IGZsdXNoZWQgeWV0IHNvIGNhbiBqdXN0IHJlLWFkZFxuICAgICAgY29kZWJhc2VJZHNUb1JlYWRkLmZvckVhY2goKGNvZGViYXNlSWRUb1JlYWRkKSA9PiB7XG4gICAgICAgICQoYC4ke2NvZGViYXNlSWRUb1JlYWRkfWApLmVhY2goKGluZGV4LCBpdGVtKSA9PiB7XG4gICAgICAgICAgaXRlbS5jbGFzc0xpc3QucmVtb3ZlKFRFTVBPX0RJU1BMQVlfTk9ORV9VTlRJTF9SRUZSRVNIX0NMQVNTKTtcbiAgICAgICAgICBpdGVtLnJlbW92ZUF0dHJpYnV0ZShURU1QT19ET19OT1RfU0hPV19JTl9OQVZfVU5USUxfUkVGUkVTSCk7XG5cbiAgICAgICAgICBzZW5kTmV3TmF2VHJlZSA9IHRydWU7XG4gICAgICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSBlbHNlIGlmIChcbiAgICBjaGFuZ2VUb1VuZG8udHlwZSA9PT0gQ2hhbmdlVHlwZS5BRERfQ0xBU1MgfHxcbiAgICBjaGFuZ2VUb1VuZG8udHlwZSA9PT0gQ2hhbmdlVHlwZS5TVFlMSU5HXG4gICkge1xuICAgIGNvbnN0IGluc3RhbnRVcGRhdGVEYXRhID0gY2hhbmdlVG9VbmRvLmdldEluc3RhbnRVcGRhdGVEYXRhKCk7XG4gICAgY29uc3QgaW5uZXJDaGFuZ2VGaWVsZHMgPSBjaGFuZ2VUb1VuZG8uY2hhbmdlRmllbGRzIGFzIEFkZENsYXNzQ2hhbmdlRmllbGRzO1xuXG4gICAgY29uc3QgYWRkZWRDbGFzcyA9IGluc3RhbnRVcGRhdGVEYXRhPy5hZGRlZENsYXNzO1xuICAgIGlmIChhZGRlZENsYXNzKSB7XG4gICAgICAkKGAuJHtpbm5lckNoYW5nZUZpZWxkcy5jb2RlYmFzZUlkVG9BZGRDbGFzc31gKS5lYWNoKChpbmRleCwgaXRlbSkgPT4ge1xuICAgICAgICBpZiAoJChpdGVtKS5oYXNDbGFzcyhhZGRlZENsYXNzKSkge1xuICAgICAgICAgICQoaXRlbSkucmVtb3ZlQ2xhc3MoYWRkZWRDbGFzcyk7XG4gICAgICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBjb2RlYmFzZUFkZGVkQ2xhc3MgPSBpbnN0YW50VXBkYXRlRGF0YT8uY29kZWJhc2VBZGRlZENsYXNzO1xuICAgIGlmIChjb2RlYmFzZUFkZGVkQ2xhc3MpIHtcbiAgICAgICQoYC4ke2lubmVyQ2hhbmdlRmllbGRzLmNvZGViYXNlSWRUb0FkZENsYXNzfWApLmVhY2goKGluZGV4LCBpdGVtKSA9PiB7XG4gICAgICAgIGlmICgkKGl0ZW0pLmhhc0NsYXNzKGNvZGViYXNlQWRkZWRDbGFzcykpIHtcbiAgICAgICAgICAkKGl0ZW0pLnJlbW92ZUNsYXNzKGNvZGViYXNlQWRkZWRDbGFzcyk7XG4gICAgICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0gZWxzZSBpZiAoY2hhbmdlVG9VbmRvLnR5cGUgPT09IENoYW5nZVR5cGUuVVBEQVRFX0NMQVNTRVMpIHtcbiAgICBjb25zdCB7IGNvZGViYXNlSWRUb1VwZGF0ZUNsYXNzLCBuZXdDbGFzc2VzLCBvbGRDbGFzc2VzIH0gPVxuICAgICAgY2hhbmdlVG9VbmRvLmNoYW5nZUZpZWxkcyBhcyBVcGRhdGVDbGFzc2VzQ2hhbmdlRmllbGRzO1xuXG4gICAgLy8gVE9ETyhuaGFudGhhaSk6IFNob3VsZCBoYW5kbGUgdGhpcyBiZXR0ZXIgaW5zdGVhZCBvZiBqdXN0IHJlbW92ZSBhbmQgYWRkXG4gICAgZm9yIChjb25zdCBuZXdDbGFzcyBvZiBuZXdDbGFzc2VzKSB7XG4gICAgICAkKGAuJHtjb2RlYmFzZUlkVG9VcGRhdGVDbGFzc31gKS5yZW1vdmVDbGFzcyhuZXdDbGFzcyk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBvbGRDbGFzcyBvZiBvbGRDbGFzc2VzKSB7XG4gICAgICAkKGAuJHtjb2RlYmFzZUlkVG9VcGRhdGVDbGFzc31gKS5hZGRDbGFzcyhvbGRDbGFzcyk7XG4gICAgfVxuXG4gICAgaW50ZXJtZWRpYXRlQ2xhc3Nlc0ZvclNsaWRlckluc3RhbnRVcGRhdGVbY29kZWJhc2VJZFRvVXBkYXRlQ2xhc3NdID0gW107XG4gIH0gZWxzZSBpZiAoY2hhbmdlVG9VbmRvLnR5cGUgPT09IENoYW5nZVR5cGUuQUREX0pTWCkge1xuICAgIGNvbnN0IGluc3RhbnRVcGRhdGVEYXRhID0gY2hhbmdlVG9VbmRvLmdldEluc3RhbnRVcGRhdGVEYXRhKCk7XG4gICAgY29uc3QgYWRkZWRJZHMgPSBpbnN0YW50VXBkYXRlRGF0YT8uYWRkZWRJZHM7XG5cbiAgICBhZGRlZElkcz8uZm9yRWFjaCgoYWRkZWRJZDogc3RyaW5nKSA9PiB7XG4gICAgICAkKGAuJHthZGRlZElkfWApLnJlbW92ZSgpO1xuICAgICAgaW5zdGFudFVwZGF0ZVN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgIH0pO1xuXG4gICAgc2VuZE5ld05hdlRyZWUgPSB0cnVlO1xuICB9XG5cbiAgcmV0dXJuIHsgc2VuZE5ld05hdlRyZWUsIGluc3RhbnRVcGRhdGVTdWNjZXNzZnVsIH07XG59O1xuXG4vKipcbiAqIEFmdGVyIGEgY2hhbmdlIGlzIHByb2Nlc3NlZCBvbiB0aGUgYmFja2VuZCwgd2UgbmVlZCB0byB1cGRhdGUgdGhlIGNvZGViYXNlIGlkcyBpbiB0aGUgZG9jdW1lbnQuXG4gKi9cbmV4cG9ydCBjb25zdCB1cGRhdGVDb2RlYmFzZUlkcyA9IChcbiAgcGFyZW50UG9ydDogYW55LFxuICBwcmV2SWRUb05ld0lkTWFwOiB7XG4gICAgW3ByZXZDb2RlYmFzZUlkOiBzdHJpbmddOiBzdHJpbmc7XG4gIH0sXG4gIHVwZGF0ZUVsZW1lbnRLZXlzPzogYm9vbGVhbixcbik6IGJvb2xlYW4gPT4ge1xuICAvLyBVcGRhdGUgY29kZWJhc2UgaWRzIGluIHRoZSBkb2N1bWVudFxuICBjb25zdCBjaGFuZ2VzOiBhbnkgPSBbXTtcbiAgT2JqZWN0LmVudHJpZXMocHJldklkVG9OZXdJZE1hcCkuZm9yRWFjaChcbiAgICAoW3ByZXZDb2RlYmFzZUlkLCBuZXdDb2RlYmFzZUlkXSkgPT4ge1xuICAgICAgJChgLiR7cHJldkNvZGViYXNlSWR9YCkuZWFjaCgoaW5kZXg6IGFueSwgaXRlbTogYW55KSA9PiB7XG4gICAgICAgIGNoYW5nZXMucHVzaCh7XG4gICAgICAgICAgaXRlbSxcbiAgICAgICAgICBwcmV2Q29kZWJhc2VJZCxcbiAgICAgICAgICBuZXdDb2RlYmFzZUlkLFxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0sXG4gICk7XG5cbiAgLy8gQ29kZWJhc2UgSWRzIGNhbiBzd2FwLCBzbyB3ZSBoYXZlIHRvIGFwcGx5IHRoZSBjaGFuZ2VzIGFmdGVyIGxvb2tpbmcgYWxsIGVsZW1lbnRzIHVwXG4gIGNoYW5nZXMuZm9yRWFjaCgoY2hhbmdlOiBhbnkpID0+IHtcbiAgICBjb25zdCAkaXRlbSA9ICQoY2hhbmdlLml0ZW0pO1xuICAgIGNvbnN0IG5ld0NsYXNzID0gKCRpdGVtLmF0dHIoJ2NsYXNzJykgfHwgJycpLnJlcGxhY2UoXG4gICAgICBuZXcgUmVnRXhwKGAke2NoYW5nZS5wcmV2Q29kZWJhc2VJZH1gLCAnZycpLFxuICAgICAgY2hhbmdlLm5ld0NvZGViYXNlSWQsXG4gICAgKTtcbiAgICAkaXRlbS5hdHRyKCdjbGFzcycsIG5ld0NsYXNzKTtcblxuICAgIGNoYW5nZS5pdGVtLnNldEF0dHJpYnV0ZSgndGVtcG9lbGVtZW50aWQnLCBjaGFuZ2UubmV3Q29kZWJhc2VJZCk7XG4gICAgY2hhbmdlLml0ZW0uc2V0QXR0cmlidXRlKCdkYXRhLXRlc3RpZCcsIGNoYW5nZS5uZXdDb2RlYmFzZUlkKTtcbiAgfSk7XG5cbiAgaWYgKCF1cGRhdGVFbGVtZW50S2V5cykge1xuICAgIHJldHVybiBCb29sZWFuKGNoYW5nZXMubGVuZ3RoKTtcbiAgfVxuXG4gIGNvbnN0IGtleXNUb0NoZWNrID0gW1xuICAgIHtcbiAgICAgIGtleTogU0VMRUNURURfRUxFTUVOVF9LRVksXG4gICAgICBtZXNzYWdlSWQ6IEZJWEVEX0lGUkFNRV9NRVNTQUdFX0lEUy5TRUxFQ1RFRF9FTEVNRU5UX0tFWSxcbiAgICB9LFxuICAgIHtcbiAgICAgIGtleTogSE9WRVJFRF9FTEVNRU5UX0tFWSxcbiAgICAgIG1lc3NhZ2VJZDogRklYRURfSUZSQU1FX01FU1NBR0VfSURTLkhPVkVSRURfRUxFTUVOVF9LRVksXG4gICAgfSxcbiAgXTtcbiAga2V5c1RvQ2hlY2suZm9yRWFjaCgoeyBrZXksIG1lc3NhZ2VJZCB9KSA9PiB7XG4gICAgY29uc3QgZWxlbWVudEtleSA9IGdldE1lbW9yeVN0b3JhZ2VJdGVtKGtleSk7XG4gICAgY29uc3QgdGVtcG9FbGVtZW50ID0gVGVtcG9FbGVtZW50LmZyb21LZXkoZWxlbWVudEtleSk7XG4gICAgaWYgKHByZXZJZFRvTmV3SWRNYXBbdGVtcG9FbGVtZW50LmNvZGViYXNlSWRdKSB7XG4gICAgICBjb25zdCBuZXdFbGVtZW50ID0gbmV3IFRlbXBvRWxlbWVudChcbiAgICAgICAgcHJldklkVG9OZXdJZE1hcFt0ZW1wb0VsZW1lbnQuY29kZWJhc2VJZF0sXG4gICAgICAgIHRlbXBvRWxlbWVudC5zdG9yeWJvYXJkSWQsXG4gICAgICAgIHRlbXBvRWxlbWVudC51bmlxdWVQYXRoLFxuICAgICAgKTtcbiAgICAgIHNldE1lbW9yeVN0b3JhZ2VJdGVtKGtleSwgbmV3RWxlbWVudC5nZXRLZXkoKSk7XG5cbiAgICAgIHBhcmVudFBvcnQucG9zdE1lc3NhZ2Uoe1xuICAgICAgICBpZDogbWVzc2FnZUlkLFxuICAgICAgICBlbGVtZW50S2V5OiBuZXdFbGVtZW50LmdldEtleSgpLFxuICAgICAgICBvdXRlckhUTUw6ICQoYC4ke0VMRU1FTlRfS0VZX1BSRUZJWH0ke25ld0VsZW1lbnQuZ2V0S2V5KCl9YCkuZ2V0KDApXG4gICAgICAgICAgPy5vdXRlckhUTUwsXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIEFsc28gdXBkYXRlIHRoZSBtdWx0aXNlbGVjdGVkIGVsZW1lbnQga2V5c1xuICBjb25zdCBtdWx0aXNlbGVjdGVkRWxlbWVudEtleXMgPSBnZXRNZW1vcnlTdG9yYWdlSXRlbShcbiAgICBNVUxUSV9TRUxFQ1RFRF9FTEVNRU5UX0tFWVMsXG4gICk7XG4gIGlmIChtdWx0aXNlbGVjdGVkRWxlbWVudEtleXM/Lmxlbmd0aCkge1xuICAgIGNvbnN0IG5ld011bHRpc2VsZWN0ZWRFbGVtZW50S2V5czogc3RyaW5nW10gPSBbXTtcbiAgICBtdWx0aXNlbGVjdGVkRWxlbWVudEtleXMuZm9yRWFjaCgoZWxlbWVudEtleTogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zdCB0ZW1wb0VsZW1lbnQgPSBUZW1wb0VsZW1lbnQuZnJvbUtleShlbGVtZW50S2V5KTtcbiAgICAgIGlmIChwcmV2SWRUb05ld0lkTWFwW3RlbXBvRWxlbWVudC5jb2RlYmFzZUlkXSkge1xuICAgICAgICBjb25zdCBuZXdFbGVtZW50ID0gbmV3IFRlbXBvRWxlbWVudChcbiAgICAgICAgICBwcmV2SWRUb05ld0lkTWFwW3RlbXBvRWxlbWVudC5jb2RlYmFzZUlkXSxcbiAgICAgICAgICB0ZW1wb0VsZW1lbnQuc3Rvcnlib2FyZElkLFxuICAgICAgICAgIHRlbXBvRWxlbWVudC51bmlxdWVQYXRoLFxuICAgICAgICApO1xuICAgICAgICBuZXdNdWx0aXNlbGVjdGVkRWxlbWVudEtleXMucHVzaChuZXdFbGVtZW50LmdldEtleSgpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5ld011bHRpc2VsZWN0ZWRFbGVtZW50S2V5cy5wdXNoKGVsZW1lbnRLZXkpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgc2V0TWVtb3J5U3RvcmFnZUl0ZW0oXG4gICAgICBNVUxUSV9TRUxFQ1RFRF9FTEVNRU5UX0tFWVMsXG4gICAgICBuZXdNdWx0aXNlbGVjdGVkRWxlbWVudEtleXMsXG4gICAgKTtcbiAgICBwYXJlbnRQb3J0LnBvc3RNZXNzYWdlKHtcbiAgICAgIGlkOiBGSVhFRF9JRlJBTUVfTUVTU0FHRV9JRFMuTVVMVElfU0VMRUNURURfRUxFTUVOVF9LRVlTLFxuICAgICAgZWxlbWVudEtleXM6IG5ld011bHRpc2VsZWN0ZWRFbGVtZW50S2V5cyxcbiAgICAgIG91dGVySFRNTHM6IG5ld011bHRpc2VsZWN0ZWRFbGVtZW50S2V5cz8ubWFwKFxuICAgICAgICAoZWxlbWVudEtleSkgPT5cbiAgICAgICAgICAkKGAuJHtFTEVNRU5UX0tFWV9QUkVGSVh9JHtlbGVtZW50S2V5fWApLmdldCgwKT8ub3V0ZXJIVE1MLFxuICAgICAgKSxcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBCb29sZWFuKGNoYW5nZXMubGVuZ3RoKTtcbn07XG4iXX0=